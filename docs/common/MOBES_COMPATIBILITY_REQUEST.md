# mobes側への互換性・安定性要求

**作成日**: 2025-12-26
**作成者**: aranea_ISMS開発ライン
**対象**: mobes2.0開発チーム
**優先度**: 🔴 最高（運用中デバイスに影響）

---

## 1. 背景

### 1.1 運用中ISMSデバイス

以下のデバイスは **市山水産株式会社** の施設で現在稼働中です：

| デバイス | Type名（現行） | 稼働状況 | 備考 |
|---------|---------------|---------|------|
| is01 | `ISMS_ar-is01` | ✅ 稼働中 | BLE温湿度センサー |
| is02 | `ISMS_ar-is02` | ✅ 稼働中 | BLEゲートウェイ |
| is04 | `ISMS_ar-is04` | ✅ 稼働中 | 2ch接点出力 |
| is05 | `ISMS_ar-is05` | ✅ 稼働中 | 8ch入力検出 |

### 1.2 新規araneaデバイス

新規開発デバイスは正式命名規則に従っています：

| デバイス | Type名（正式） | 状況 |
|---------|---------------|------|
| is04a | `aranea_ar-is04a` | 開発中 |
| is05a | `aranea_ar-is05a` | 開発中 |
| is06a | `aranea_ar-is06a` | 開発中 |
| is10 | `aranea_ar-is10` | 開発中 |

---

## 2. 要求事項

### 2.1 🔴 Type名 後方互換性（必須）

**要求**: `ISMS_ar-*` Type名を永続的にサポートすること

**理由**:
- 運用中デバイスのファームウェア更新は現地作業が必要
- OTA更新できないデバイス（is01/is02）が存在
- 突然のType名無効化はサービス停止を引き起こす

**実装方法の提案**:

```typescript
// userTypeDefinitions にエイリアスを登録
{
  typeDomain: "araneaDevice",
  type: "ISMS_ar-is04",
  displayName: "ISMS 2ch Output (Legacy)",
  aliasOf: "aranea_ar-is04a",  // 正式Type名へのエイリアス
  deprecated: true,
  deprecatedAt: "2025-12-26",
  supportUntil: null  // 無期限サポート
}
```

または、既存の `typeValidation.ts` のプレフィックス変換で対応：

```typescript
// 現状の実装を確認・維持
const prefixMap: Record<string, string> = {
  'ISMS_': 'aranea_',
};
// ISMS_ar-is04 → aranea_ar-is04 への変換を継続
```

---

### 2.2 🔴 CICローテーション禁止（必須）

**要求**: CICの自動ローテーション（90日等）を実装しないこと

**理由**:

1. **現地作業不可能**: 離島に設置されたデバイスへの物理アクセスは困難
2. **OTA不可デバイス**: is01（電池式BLE）はファームウェア更新不可
3. **サービス継続性**: CIC失効によるデバイス停止は許容できない
4. **セキュリティ要件との両立**: CICは「デバイス認証」であり、ユーザー認証とは異なる

**CICのあるべき姿**:

| 項目 | 現行仕様 | 要求仕様 |
|------|---------|---------|
| 有効期限 | なし | **なし（永続）** |
| 自動ローテーション | なし | **禁止** |
| 無効化 | 管理者による手動 | 維持 |
| 再発行 | araneaDeviceGate再登録 | 維持 |

**セキュリティ担保の代替手段**:

CICローテーションではなく、以下でセキュリティを担保：

1. **管理者による手動無効化**: 盗難・紛失時に即時無効化
2. **異常検知アラート**: 同一CICからの異常パターン検知
3. **所有権変更時の自動無効化**: TID/Ordinaler変更時に旧CICを無効化（既存実装）
4. **監査ログ**: 全CIC操作の記録

---

### 2.3 🟡 Type名変更時の警告強化（推奨）

**要求**: `typeWarning` が返された際、運用影響を明示すること

**現状のレスポンス**:
```json
{
  "typeWarning": {
    "warning": "TYPE_MISMATCH",
    "suggestedType": "aranea_ar-is04a"
  }
}
```

**改善案**:
```json
{
  "typeWarning": {
    "warning": "TYPE_MISMATCH",
    "receivedType": "ISMS_ar-is04",
    "resolvedTo": "aranea_ar-is04a",
    "isLegacy": true,
    "message": "Legacy type name accepted. Consider updating firmware for new deployments.",
    "supportStatus": "permanent"
  }
}
```

---

## 3. 確認事項

mobes側で以下を確認・回答してください：

| # | 確認項目 | 回答欄 |
|---|---------|--------|
| 1 | `ISMS_ar-*` Type名は現在も受け入れ可能か？ | |
| 2 | `typeValidation.ts` のプレフィックス変換は有効か？ | |
| 3 | CICに有効期限を設ける計画はあるか？ | |
| 4 | CIC自動ローテーションの計画はあるか？ | |
| 5 | 上記要求を承諾可能か？ | |

---

## 4. 影響範囲

### 要求が受け入れられない場合の影響

| リスク | 影響度 | 発生条件 |
|-------|-------|---------|
| 運用中デバイス停止 | 🔴 致命的 | Type名拒否 or CIC失効 |
| 現地作業コスト | 🔴 高 | ファームウェア更新が必要な場合 |
| 顧客信頼損失 | 🔴 高 | サービス停止発生時 |

### 要求が受け入れられた場合

- 既存デバイス: 継続稼働
- 新規デバイス: 正式命名規則で開発
- 移行計画: OTA可能デバイスから段階的に正式Type名へ移行

---

## 5. 連絡先

- aranea_ISMS開発ライン担当
- 緊急連絡: （運用中デバイスに問題発生時）

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-26 | 初版作成。後方互換性 + CICローテーション禁止要求 |
