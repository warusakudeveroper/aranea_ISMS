# ESP32 / ISMS 全体連携動作（is01〜is05 + is03）

**必須参照ドキュメント** - 実装・運用の前にこのドキュメントを確認すること

## このドキュメントの目的
- 現地投入に必要な「全体の連携動作（誰が何を送って誰が受けるか）」を、実装・運用の前提として固定する。
- サーバ（mobes2.0側）の実装が完全でなくても、現地で疎通確認できる構成を優先する。

## 関連外部システム

| システム | リポジトリ | 用途 |
|---------|-----------|------|
| mobes2.0 | https://github.com/warusakudeveroper/mobes2.0 | IoT統合管理システム（Firebase/React） |
| Arduino-MCP | https://github.com/warusakudeveroper/Arduino-MCP | ESP32開発環境（MCP Server） |

詳細は [external_systems.md](./external_systems.md) を参照。

---

## 構成要素と役割

### is01（BLE温湿度 / 電池式）
- 役割：温湿度を取得し **BLEアドバタイズで送信**する（送信専用が基本）。
- ネットワーク機能：**初回アクティベート（CIC取得）にのみ使用**。通常運用は Wi-Fi を使わない。
- OTA：不可（電池式・Wi-Fi常用しないため）。ここだけ仕様を固めて壊さない。

### is02（BLE受信→中継 / 常時電源）
- 役割：is01のBLEアドバタイズを **受信（スキャン）**し、受信データをネットワークへ **中継（HTTP等）**する。
- 送信先：クラウドが未完成の間は **ローカル is03（Zero3）**へ送る運用を優先する。
- OTA：可（常時電源＋Wi-Fi常用）。

### is03（Orange Pi Zero3 / ローカル受信・表示サーバ）
- 役割：is01のBLEアドバタイズを **受信して保存**し、LANブラウザで **受信状況/ログ**を見える化する。
- 目的：離島など遠隔地で「まず is01 が生きている」ことを現地で確認する。2台設置して冗長化する。
- 保存：最新約2000件をメモリ保持し、SDへの書き込みはバッチで行う（SD保護）。
- is03自身もデバイスとして登録可能（運用上の管理・監視用）。

### is04（開閉コントローラ / 出力）
- 役割：ネットワーク越しに「開閉（リレー/アンラッチ）」を実行するアクチュエータ。
- 現地優先：クラウド未完成の間はローカル（is03）経由で命令できる構成を許容。

### is05（開閉センサー / 入力8ch）
- 役割：リードスイッチ等で開閉状態を読み取り、状態をネットワークへ通知する。
- 現地優先：クラウド未完成の間はローカル（is03）へ投げて疎通確認する。

---

## ID / 認証（実装仕様として固定）

### productCode / productType
- productCode：**"0096" 固定**
- productType（3桁ゼロパディング固定）
  - 001: is01
  - 002: is02
  - 003: is03
  - 004: is04
  - 005: is05
  - 006: is06
  - 007: ar-cd07

### lacisId（araneaDevice / deviceWithMAC）
- **MACは平文（12桁HEX）をそのまま埋め込む。変換しない。**
- 生成式（20文字固定）
  `lacisId = "3" + productType(3桁) + MAC12HEX(12桁) + productCode(4桁)`
- 例：is02、MAC=AABBCCDDEEFF の場合
  `3002AABBCCDDEEFF0096`

> 数字のみ必須（20桁整数）は User/Guest（personLike）のみ。
> araneaDevice（deviceWithMAC）はMAC平文を埋め込むことが仕様。

### CIC（6桁）
- 登録（アクティベート）で取得し、以後はデバイスの認証キーとして保持する。
- is01 はCICを保持し、起動時ディスプレイにも表示する。

---

## 全体のデータフロー（現地優先）

### フローA：is01の初回アクティベート（Wi-Fiを使う唯一の場面）
1. is01が lacisId を内部生成（上記仕様）
2. is01が Wi-Fiへ接続（固定SSID候補を順次試行）
3. 登録エンドポイントにアクセスして **CICを取得**（CIC保存）
4. 以後は通常運用へ移行（Wi-Fiは基本OFF）

※登録処理がクラウド未完成の場合：
- is03（Zero3）側で「仮登録API」を用意するか
- もしくは現地でCICを手動投入する導線（暫定）を作る

### フローB：is01の通常運用（3分周期）
1. DeepSleep復帰
2. 省電力ゲート（GPIO5等）を適切な順序でON
3. I2C初期化（同期的に実行・失敗時リトライ）
4. SHT30で温湿度取得
5. OLED表示（例：10秒間、CIC/温湿度/状態）
6. BLEアドバタイズ送信（必要情報をpayloadに含める）
7. DeepSleepへ戻る

重要：
- DeepSleep復帰直後のI2C初期化は不安定になりやすいので、並列処理を避け、順序固定で同期実行する。

### フローC：is03による受信・可視化（現地確認の主役）
- is03 は常時BLEスキャンし、is01のアドバタイズを受信してログ化する。
- ブラウザで以下を確認できること：
  - 直近イベント一覧（最新2000件）
  - 最終受信時刻、RSSI、温湿度、電池（含まれていれば）
  - 動作ログ（起動/再起動/エラー）
- is03は2台設置（is03-1 / is03-2）し冗長化する。

### フローD：is02による受信→中継（クラウド未完成でも成立）
- is02は常時BLEスキャンし、is01の広告を受信する。
- 受信データをネットワークへ送る：
  - 優先：ローカル is03（primary）へHTTP POST
  - 失敗時：ローカル is03（secondary）へHTTP POST
  - 将来：クラウドの deviceStateReport 等へ送信

> 現地投入では「is01が送っている」ことを is03 で確認できれば最優先要件は満たす。
> is02の中継は"クラウド連携が整うまでの段階的追加"として扱う。

---

## メッセージ仕様（最低限）

### BLE payload（is01 → is02/is03）
必須（どれかの形で復元できること）：
- is01の識別に必要な情報（推奨：MAC12HEX + productType + productCode）
- 温度/湿度
推奨：
- 観測時刻（epochや起床カウンタ）
- 電池残量
- FWバージョン等

※31byte制約があるため、lacisId（20文字）を丸ごと載せるより、
- MAC + productType + productCode で lacisId を再構成する方式を推奨する。

### is02 → is03（ローカル中継）
- HTTP POST JSON（最小）
  - sensor: { mac, productType, productCode, lacisId(再構成値) }
  - state: { temperature, humidity, battery? }
  - meta: { rssi, observedAt, gatewayId(is02のlacisId) }

### is03（ブラウザ表示）
- /api/events: 最新2000件を返す
- /ws: 新規イベントをpush（ライブ表示）

---

## 冗長化と故障時のふるまい

### is03二重化（推奨）
- is03-1 と is03-2 を同一LANに配置し、両方がBLEスキャンする。
- どちらかが落ちても受信が継続する。

### is01（電池式）のフェイルセーフ
- CICが取得できない場合でも、BLEアドバタイズは継続する（現地確認優先）。
- ディスプレイに「未アクティベート」表示を出す。

### SD保護（is03）
- 受信イベントはまずメモリリング（最大2000件）へ格納
- DBへの書き込みはバッチでまとめる（例：10秒ごと or 50件ごと）
- DBは最大件数（例：20000件）で古いものを削除して肥大化を防ぐ

---

## 現地での確認ポイント（最小の成功条件）
1. is01が起動して温湿度を表示し、BLEアドバタイズを出している
2. is03のブラウザ画面で、is01由来の受信ログが増える（RSSI/温湿度が見える）
3. （追加）is02を置いた場合、is02が受信→is03へ中継できる

---

## 今後の拡張（サーバが整ってから）
- is02/is05 の送信先を is03 からクラウド endpoint へ切替
- is04 を pub/sub または MQTT 経由で遠隔制御
- サーバ側のdedup/semanticTags/tid/rid/did の厳密化
