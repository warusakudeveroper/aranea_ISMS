# is01a - Temp&HumSensor (Cluster Node) 設計書

**正式名称**: Aranea Temperature & Humidity Sensor - Cluster Node
**製品コード**: AR-IS01A
**作成日**: 2025/12/22
**ベース**: archive_ISMS/ESP32/is01 (ISMS専用版)
**目的**: is02a(Master)と連携する電池式温湿度クラスタノード

---

## 1. デバイス概要

### 1.1 機能概要

- **温湿度センサー**: HT-30 (I2C)
- **BLEアドバタイズ**: 送信のみ（受信しない）
- **電池駆動**: DeepSleep運用（デフォルト4分間隔）
- **省電力ロジック**: 最小限の起動時間でBLE発信後即Sleep
- **初回アクティベーション**: WiFi→APモード→設定→AraneaDeviceGate登録→CIC取得

### 1.2 動作概要

is02a(Master)と連携して動作するクラスタノードモデル。本体は基本的にインターバルで自身の温湿度状態をBLEアドバタイズ発信するのみ。is02aがこれを受信してクラウド/ローカルへ中継する。

### 1.3 ユースケース

| 用途 | 説明 |
|------|------|
| 温度監視 | 倉庫・冷蔵庫・サーバールーム |
| 湿度監視 | 文書保管庫・美術品保管 |
| 環境モニタリング | 農業施設・温室 |
| 分散センシング | 複数ノードでの広域計測 |

### 1.4 is01（ISMS版）との違い

| 項目 | is01 (ISMS版) | is01a (汎用版) |
|------|--------------|----------------|
| LacisID/CIC | **必須** | **必須** |
| AraneaRegister | **必須** | **必須** |
| TID設定 | ハードコード | NVS設定可能 |
| インターバル設定 | ハードコード(4分) | NVS設定可能(1-60分) |
| 温度補正設定 | なし | NVS設定可能 |
| 即時発信(PIN19短押し) | 未実装 | 実装 |
| 設定モード(PIN長押し) | 未実装 | 実装 |
| 初回セットアップ | 手動設定 | APモード→Web UI |

---

## 2. 起動フロー

### 2.1 is10同様の起動シーケンス

```
┌─────────────────────────────────────────────────────────────┐
│                    電源投入                                  │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│              WiFi設定確認                                    │
│  wifi_ssid が空？                                           │
└─────────────────────────────────────────────────────────────┘
        │                                    │
        ▼ Yes                                ▼ No
┌─────────────────────────────────────────────────────────────┐
│              APモード起動                                    │
│  SSID: "is01a-XXXX" (MACアドレス末尾)                        │
│  IP: 192.168.4.1                                            │
│  Web UI: 設定画面表示                                        │
└─────────────────────────────────────────────────────────────┘
        │ 設定保存
        ▼
┌─────────────────────────────────────────────────────────────┐
│              WiFi接続                                        │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│              AraneaDeviceGate登録                            │
│  - LacisID生成                                              │
│  - CIC取得・NVS保存                                          │
│  - activated=1                                              │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│              通常動作モード                                  │
│  DeepSleep → Wake → 計測 → BLE発信 → DeepSleep              │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 ボタン操作

| 操作 | GPIO | 動作 |
|------|------|------|
| PIN19 短押し | GPIO19 | 即時BLEアドバタイズ発信 |
| PIN19 長押し(3秒) | GPIO19 | WiFi接続モードへ移行（設定変更用） |
| BTN_RESET 長押し(5秒) | GPIO26 | ファクトリーリセット |

### 2.3 WiFi接続モード（PIN長押し時）

```
┌─────────────────────────────────────────────────────────────┐
│              WiFi接続モード                                  │
│  - 保存済みSSIDに接続                                        │
│  - Web UI起動（http://[IP]/）                               │
│  - 設定可能項目:                                             │
│    - インターバル設定（1-60分）                              │
│    - 温度補正設定（-5.0〜+5.0℃）                            │
│    - 湿度補正設定（-10〜+10%）                               │
│  - 5分間操作なしで自動的にDeepSleepへ                        │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. ハードウェア仕様

### 3.1 ESP32-DevKitC GPIO割り当て

| GPIO | 機能 | 説明 |
|------|------|------|
| 19 | BTN_ACTION | 短押し:即時発信 / 長押し:設定モード |
| 21 | I2C_SDA | HT-30/OLED SDA |
| 22 | I2C_SCL | HT-30/OLED SCL |
| 26 | BTN_RESET | ファクトリーリセット（5秒長押し） |

### 3.2 I2Cデバイス

| デバイス | アドレス | 用途 |
|---------|---------|------|
| HT-30 | 0x44 | 温湿度センサー |
| SSD1306 | 0x3C | OLED表示（128x64） |

### 3.3 電源仕様

- **電源**: 単3電池 x 2（3V）または18650リチウム電池
- **消費電力**:
  - アクティブ: ~80mA（BLE発信中）
  - DeepSleep: ~10μA
- **動作サイクル**: 設定間隔（デフォルト4分）でWake→計測→BLE送信→Sleep
- **想定電池寿命**: 単3電池 x 2で約6ヶ月（4分間隔時）

---

## 4. ソフトウェア設計

### 4.1 設計原則（全デバイス共通）

```
重要: ESP32では以下を遵守
- セマフォとWDTの過剰制御を避ける
- 監査系関数を入れすぎない（制御と監査で不安定化）
- 本体プログラムのタイミングとメモリ管理を重視
- コードのシンプル化
- 可能な限りシングルタスクで実装
- パーティション: min_SPIFFS使用（OTA領域確保）
```

### 4.2 通常動作サイクル

```cpp
void normalOperationCycle() {
    // 1. DeepSleep復帰
    // 2. I2C初期化（直列処理必須）
    initI2CDevices();

    // 3. HT-30計測
    float temp = sensor.readTemperature() + tempOffset;
    float hum = sensor.readHumidity() + humOffset;

    // 4. BLEアドバタイズ（3秒間）
    bleAdv.setPayload(myLacisId, myCic, temp, hum, battPct);
    bleAdv.advertise(3);

    // 5. DeepSleep（設定間隔）
    esp_deep_sleep(intervalMinutes * 60 * 1000000ULL);
}
```

### 4.3 即時発信（PIN19短押し）

```cpp
void onActionButtonShortPress() {
    // 即時計測・発信
    float temp = sensor.readTemperature() + tempOffset;
    float hum = sensor.readHumidity() + humOffset;

    bleAdv.setPayload(myLacisId, myCic, temp, hum, battPct);
    bleAdv.advertise(3);

    // 通常サイクルに戻る
    esp_deep_sleep(intervalMinutes * 60 * 1000000ULL);
}
```

---

## 5. BLE通信仕様

### 5.1 ISMSv1フォーマット（40バイト）

```
┌────────────────────────────────────────────────────────────────┐
│ Prefix(1) │ LacisID(20) │ CIC(6) │ Temp(5) │ Hum(5) │ Batt(3) │
└────────────────────────────────────────────────────────────────┘
```

| フィールド | バイト | 説明 | 例 |
|-----------|--------|------|-----|
| Prefix | 1 | 固定 "3" | "3" |
| LacisID | 20 | デバイス識別子 | "3001AABBCCDDEEFF0001" |
| CIC | 6 | 認証コード（0埋め6桁） | "123456" |
| Temperature | 5 | 温度（符号付き） | "+25.5" or "-05.0" |
| Humidity | 5 | 湿度 | "065.0" |
| Battery | 3 | 電池残量% | "085" |

---

## 6. NVS設定項目

### 6.1 必須設定（AraneaDeviceGate用）

| キー | 型 | 説明 |
|------|-----|------|
| `gate_url` | string | AraneaDeviceGate URL |
| `tid` | string | テナントID |
| `tenant_lacisid` | string | テナントプライマリのlacisID |
| `tenant_email` | string | テナントプライマリのEmail |
| `tenant_cic` | string | テナントプライマリのCIC |
| `cic` | string | 自デバイスのCIC（取得後保存） |
| `activated` | int | アクティベーション完了フラグ（0/1） |

### 6.2 WiFi設定

| キー | 型 | デフォルト | 説明 |
|------|-----|-----------|------|
| `wifi_ssid` | string | "" | WiFi SSID |
| `wifi_pass` | string | "" | WiFi パスワード |

### 6.3 is01a固有設定

| キー | 型 | デフォルト | 説明 |
|------|-----|-----------|------|
| `interval_min` | int | 4 | 発信間隔（1-60分） |
| `ble_adv_sec` | int | 3 | BLEアドバタイズ時間（秒） |
| `temp_offset` | float | 0.0 | 温度補正値（-5.0〜+5.0℃） |
| `hum_offset` | float | 0.0 | 湿度補正値（-10〜+10%） |
| `device_name` | string | "is01a" | デバイス表示名 |

---

## 7. Web UI（APモード/設定モード）

### 7.1 エンドポイント

| パス | メソッド | 説明 |
|------|---------|------|
| `/` | GET | 設定画面 |
| `/api/status` | GET | 現在の状態 |
| `/api/config` | GET/POST | 設定取得/更新 |
| `/api/reboot` | POST | 再起動 |
| `/api/factory_reset` | POST | ファクトリーリセット |

### 7.2 設定画面項目

```
=== WiFi設定 ===
- SSID
- パスワード

=== テナント設定 ===
- テナントID (TID)
- AraneaDeviceGate URL
- テナントプライマリ認証情報

=== センサー設定 ===
- 発信間隔（1-60分）
- 温度補正（-5.0〜+5.0℃）
- 湿度補正（-10〜+10%）

=== デバイス情報 ===
- LacisID（読み取り専用）
- CIC（読み取り専用）
- MACアドレス（読み取り専用）
- ファームウェアバージョン
```

---

## 8. 共通コンポーネント使用

| モジュール | 使用 | 備考 |
|-----------|------|------|
| WiFiManager | ○ | APモード/STA切替対応 |
| SettingManager | ○ | NVS永続化 |
| DisplayManager | ○ | I2C OLED表示 |
| NtpManager | △ | 設定モード時のみ |
| LacisIDGenerator | **○必須** | lacisID生成 |
| AraneaRegister | **○必須** | CIC取得 |
| AraneaWebUI | ○ | 設定画面 |
| Operator | ○ | 状態機械 |

**OTA非対応**: 電池駆動のためOTAは実装しない。更新はUSB経由。

---

## 9. 注意事項

### 9.1 I2C処理の直列化（必須）

```cpp
// 正しい実装
void initI2CDevices() {
    Wire.begin(SDA, SCL);
    delay(100);  // 安定化待ち

    sensor.begin();  // HT-30
    delay(50);

    display.begin(); // OLED
    delay(50);
}
// 並列I2C初期化は禁止（失敗の原因）
```

### 9.2 CIC未取得時の動作

- CIC未取得でもBLE広告は**必ず出す**
- ペイロードのCIC部分は"000000"とする
- is02/is03で検知可能にするため

---

## 10. 参照

- **is01 (ISMS版)**: `archive_ISMS/ESP32/is01/is01.ino`
- **is02a (Master)**: `code/ESP32/is02a/`
- **global モジュール**: `code/ESP32/global/src/`
- **役割分担ガイド**: `code/ESP32/______MUST_READ_ROLE_DIVISION______.md`
