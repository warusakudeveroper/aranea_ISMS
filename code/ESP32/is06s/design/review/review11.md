  コミット内容:                                                                                                     
  - a5b1839 docs(is06s): GPIO18/GPIO5出力不可問題 調査依頼書作成                                                    
                                                                                                                    
  含まれるファイル:                                                                                                 
  - code/ESP32/is06s/design/review/GPIO18_GPIO5_INVESTIGATION_REQUEST.md - 調査依頼書                               
  - code/ESP32/is06s/gpiotest/gpiotest.ino - 最小構成テストコード                                                   
                                                                                                                    
  調査依頼書の要点:                                                                                                 
  1. GPIO18/GPIO5のみ出力不可（他の4ピンは正常）                                                                    
  2. 過去コードでは3.3V出力確認済み → 配線問題ではない                                                              
  3. ESP32直結3.3Vで外部動作確認 → 外部コンポーネント問題ではない                                                   
  4. ESP32交換しても同一症状 → チップ固有の故障ではない                                                             
  5. レジスタ読み取りは正常値（OUT=1, ENABLE=1, IN=1）だが物理出力なし                                              
                                                                                                                    
  調査依頼事項:                                                                                                     
  - GPIO18/GPIO5特有の初期化要件                                                                                    
  - Arduino-ESP32 3.x の既知問題                                                                                    
  - レジスタ状態と物理出力の不一致原因                                                                              
  - 過去動作コードとの差分調査       


ご指摘ありがとうございます。「出力がない（0V）」ではなく、**「中途半端な電圧（1.25V〜1.37V）が出ている」** という事実は、トラブルシューティングの方向性を決定的に変える極めて重要な情報です。

この電圧値は、デジタル回路における「不定（Floating）」や「完全なLow（0V）」ではありません。**「何らかの信号が高速で動いている（発振）」** か、**「ドライバ同士が衝突している」** ことを示唆します。

前提を再整理し、この「1.3V前後」という現象に即した調査報告に修正します。

---

# 調査報告書（改訂版）：GPIO18/GPIO5 中間電位出力問題

**件名:** GPIO18/GPIO5における期待値(3.3V)に対し、実測値が中間電位(约1.3V)となる現象の原因特定
**対象:** Aranea_04 / ESP32-WROOM-32
**ステータス:** ハードウェア正常 / **出力信号の衝突または意図しない発振** の疑い

## 1. 現象の再定義

* **期待値:** 3.3V (完全なDC High)
* **実測値:** 1.25V 〜 1.37V
* **示唆:** テスター（DCレンジ）がこの電圧を示す場合、ピンは以下のいずれかの状態にある可能性が高い。
1. **高速スイッチング中:** 高周波のクロック信号（PWMやSPI CLK）が出力されており、その実効値（平均電圧）を計測している。
* 例: 3.3V の 40% Duty ≒ 1.32V


2. **出力衝突（Bus Contention）:** 内部で「Low」を出そうとする力と、外部または別の機能が「High」を出そうとする力が拮抗している。



## 2. 原因分析：なぜ「1.3V」なのか

GPIO18 と GPIO5 の役割（VSPI）と電圧値を照らし合わせると、原因は**「意図しないSPIクロックの出力（発振）」**である可能性が極めて高いと断定できる。

### A. GPIO18 (VSPI_CLK) = 1.3V の正体

GPIO18 はハードウェアSPIのクロックピンである。
もしシステム起動時にSPIコントローラーがActiveになった場合、アイドル時またはデータ送信待機時にクロックラインが特定の周波数で駆動、あるいはプルアップ/ダウン抵抗との兼ね合いで中間電位に見える挙動をすることがある。
特に、**3.3Vの矩形波（クロック信号）が出力されている場合、テスターは平均電圧として 1.65V 近辺（Duty比により変動）を表示する。** 1.25V〜1.37V という値は、負荷やDuty比を考慮すると「クロック信号」として非常に合点がいく値である。

### B. GPIO5 (VSPI_SS) = 1.3V の正体

通常、CSピンはHighかLowに固定されるが、もしこれが「他方のSPIデバイス（スレーブ）からの入力」として設定されていたり、あるいはGPIO18と連動して高速にトグルするモードに入っている場合、同様に中間電位が観測される。

### C. 結論：「出力していない」のではなく「別の信号を出している」

「過去のコードでは動いた」→ 当時はこの「裏で動く信号」が止まっていた。
「現在は動かない（1.3V）」→ 現在のビルド環境またはコード構成では、**ユーザーが意識しないところでSPIバスがアクティブになり、クロック等の信号を垂れ流している**。

これが、レジスタ（GPIO_OUT）で「High(1)」を指示しても、物理ピン（IO_MUX）がSPIコントローラーに接続され、勝手に波形を出力している原因である。

## 3. 対策の正当性確認

現象認識は変わったが、解決策の方向性は以前の提案（IO_MUXのリセット）で合致する。ただし、その目的は「Lowからの復帰」ではなく、**「暴走している周辺機能（SPI）の信号停止」** にある。

### 修正された対策コード

この電圧が出ている以上、単なる `pinMode` では上書きできない（周辺機能がドライブ能力を持っている）ため、やはり **`gpio_reset_pin` による強制停止** が必須である。

```cpp
#include <Arduino.h>
#include "driver/gpio.h"

void setup() {
    // 診断用：もしオシロスコープがあれば、この時点でGPIO18に
    // クロック波形が出ている可能性が高い。
    
    // 1. 周辺機能（SPI）による信号出力を強制停止
    //    これにより IO_MUX が GPIOモードに戻り、1.3Vの発振/衝突が止まる
    gpio_reset_pin(GPIO_NUM_18);
    gpio_reset_pin(GPIO_NUM_5);

    // 2. 改めてGPIO出力として設定
    pinMode(18, OUTPUT);
    pinMode(5, OUTPUT);
    
    // 3. 明確なHighを出力
    digitalWrite(18, HIGH);
    digitalWrite(5, HIGH);
}

void loop() {
    // 点滅処理
}

```

## 4. レビューまとめ

* **前提の修正:** 0V（出力なし）ではなく、1.3V（信号出力中/衝突）であった。
* **技術的解釈:** 1.3Vという値は、GPIO18が **SPI Clockとして動作している（発振している）** ことの強い証左である。
* **判定:** コード上の記述に関わらず、コンパイルされたバイナリは「SPIを使用する」構成になっている。これをユーザーコード側でキャンセルするには `gpio_reset_pin()` が唯一の確実な手段である。

以上、現象の再定義に基づく報告となります。上記コードにて「1.3Vの発振」が収まり「3.3V」になるか検証をお願いいたします。