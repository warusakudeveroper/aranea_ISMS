# is03a - LocalMQTT-Server 設計書

**正式名称**: Aranea Local MQTT Server & Relay
**製品コード**: AR-IS03A
**作成日**: 2025/12/22
**プラットフォーム**: Orange Pi Zero3 (Armbian)
**目的**: MQTTローカルリレー、回線断絶時の冗長性確保、ローカルデバイス管理

---

## 1. デバイス概要

### 1.1 機能概要

- **MQTTローカルリレー**: is02a等からのデータ受信・蓄積
- **回線断絶対応**: オフライン時のデータバッファリング・再送
- **ローカル冗長性**: インターネット断でもローカル監視継続
- **Mythtic Local**: ローカルAraneaDeviceの操作機能（将来）
- **mDNS OTAプロキシ**: オンラインOTA→ローカル展開（将来）

### 1.2 動作概要

is02aをはじめとするAraneaデバイスからのMQTTデータを受信し、ローカル保存しながらクラウドへ転送。インターネット断絶時はローカルで蓄積し、復旧後に再送する。

### 1.3 現在の実装状態

| 機能 | 状態 | 備考 |
|------|------|------|
| HTTP受信 | 仮実装済 | is02からのHTTP POST受信 |
| データ蓄積 | 仮実装済 | メモリ2000件 + SQLite |
| Web UI | 仮実装済 | 状態表示 |
| MQTT Broker | 未実装 | 将来対応 |
| OTAプロキシ | 未実装 | 将来対応 |
| Mythtic Local | 未実装 | 将来対応 |

### 1.4 ユースケース

| 用途 | 説明 |
|------|------|
| ローカルハブ | 拠点内のデバイスデータ集約 |
| 冗長バックアップ | クラウド障害時のデータ保全 |
| オフライン運用 | 回線なし環境での監視継続 |
| ローカル制御 | Mythtic Local経由でのデバイス操作 |

---

## 2. システムアーキテクチャ

### 2.1 構成図

```
┌─────────────────────────────────────────────────────────────┐
│                    is03a (Orange Pi Zero3)                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐       │
│  │ HTTP Server │   │ MQTT Broker │   │ OTA Proxy   │       │
│  │  (Port 8080)│   │ (Port 1883) │   │ (mDNS)      │       │
│  └──────┬──────┘   └──────┬──────┘   └──────┬──────┘       │
│         │                 │                 │               │
│         ▼                 ▼                 ▼               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Data Manager                            │   │
│  │  - メモリバッファ（最新2000件）                      │   │
│  │  - SQLite永続化                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Cloud Forwarder                         │   │
│  │  - 通常時: リアルタイム転送                          │   │
│  │  - 断絶時: キュー蓄積                                │   │
│  │  - 復旧時: キュー再送                                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│                    クラウド (CelestialGlobe)                │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 冗長構成

ISMSでは2台構成で冗長化:
- is03-1: `192.168.96.201:8080`（プライマリ）
- is03-2: `192.168.96.202:8080`（セカンダリ）

---

## 3. 現行機能（仮実装）

### 3.1 HTTPエンドポイント

| パス | メソッド | 説明 |
|------|---------|------|
| `/api/relay` | POST | is02aからのデータ受信 |
| `/api/status` | GET | サーバー状態取得 |
| `/api/events` | GET | 最新イベント取得 |
| `/api/events?limit=N` | GET | 直近N件取得 |

### 3.2 データ蓄積

```
メモリ: 最新2000件保持（画面表示用）
SQLite: /var/lib/is03-relay/relay.sqlite（バッチ書き込み）
```

### 3.3 サービス管理

```bash
# サービス状態確認
sudo systemctl status is03-relay

# API確認
curl http://localhost:8080/api/status
curl http://localhost:8080/api/events?limit=5
```

---

## 4. 将来機能

### 4.1 MQTT Broker（計画）

ローカルMQTTブローカーを内蔵し、is02a等からMQTT接続を受け付ける。

```
Port: 1883 (非TLS) / 8883 (TLS)
認証: ユーザー/パスワード または TLS証明書
```

### 4.2 mDNS OTAプロキシ（計画）

オンラインでダウンロードしたファームウェアをローカルネットワーク内のデバイスへ配信。

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  クラウド   │ ──→ │   is03a     │ ──→ │ ESP32デバイス │
│ (FW配信)    │     │ (OTA Proxy) │     │ (mDNS OTA)  │
└─────────────┘     └─────────────┘     └─────────────┘
```

**フロー**:
1. is03aがクラウドから最新FWをダウンロード
2. ローカルにキャッシュ
3. mDNSでデバイスを発見
4. 各デバイスへOTA配信

### 4.3 Mythtic Local（計画）

ローカルネットワーク内のAraneaDeviceを直接操作する機能。

**機能**:
- デバイス検出（mDNS/UDPブロードキャスト）
- ステータス取得
- コマンド送信（パルス出力等）
- 設定変更
- ファームウェア更新

---

## 5. 設定項目

### 5.1 環境変数

| 変数 | デフォルト | 説明 |
|------|-----------|------|
| `HTTP_PORT` | 8080 | HTTPサーバーポート |
| `MQTT_PORT` | 1883 | MQTTブローカーポート |
| `DATA_DIR` | `/var/lib/is03-relay` | データ保存ディレクトリ |
| `MEMORY_BUFFER_SIZE` | 2000 | メモリ保持件数 |
| `CLOUD_ENDPOINT` | - | クラウド転送先URL |
| `TID` | - | テナントID |

### 5.2 設定ファイル

```yaml
# /etc/is03-relay/config.yaml
server:
  http_port: 8080
  mqtt_port: 1883

storage:
  data_dir: /var/lib/is03-relay
  memory_buffer: 2000
  sqlite_batch_size: 100

cloud:
  endpoint: https://celestial.aranea.io/api/relay
  tid: T2025XXXXXXXXXXXX
  retry_interval: 60

mqtt_broker:
  enabled: false  # 将来対応
  auth_required: true

ota_proxy:
  enabled: false  # 将来対応
  cache_dir: /var/cache/is03-relay/firmware
```

---

## 6. 開発ステップ

### Phase 1: 現行機能強化
- [ ] エラーハンドリング改善
- [ ] ログ出力強化
- [ ] 再送キュー実装

### Phase 2: MQTT Broker
- [ ] Mosquitto統合 or 独自実装
- [ ] 認証機能
- [ ] TLS対応

### Phase 3: OTA Proxy
- [ ] FWダウンロード機能
- [ ] ローカルキャッシュ
- [ ] mDNSデバイス検出
- [ ] OTA配信機能

### Phase 4: Mythtic Local
- [ ] デバイス検出
- [ ] REST API for デバイス操作
- [ ] Web UI

---

## 7. システム要件

### 7.1 ハードウェア

- **プラットフォーム**: Orange Pi Zero3
- **RAM**: 1GB以上
- **ストレージ**: 8GB以上（microSD）
- **ネットワーク**: Ethernet or WiFi

### 7.2 ソフトウェア

- **OS**: Armbian 25.5.1 (Ubuntu Noble)
- **カーネル**: 6.12.23
- **ランタイム**: Node.js 18+ or Python 3.10+

### 7.3 デフォルトアカウント

```
User: isms
Password: isms12345@
```

---

## 8. 参照

- **is02a (データ送信元)**: `code/ESP32/is02a/`
- **is03 (ISMS版)**: OrangePiZero3上の仮実装
- **CelestialGlobe**: クラウドバックエンド
