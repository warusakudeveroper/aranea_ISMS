<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>is03 Relay - BLE Event Monitor</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #1e1e1e; color: #d4d4d4; }
        h1 { color: #4ec9b0; }
        #status { margin-bottom: 20px; padding: 10px; background: #2d2d30; border-radius: 5px; }
        #ws-status { display: inline-block; padding: 5px 10px; border-radius: 3px; margin-left: 10px; }
        .ws-connected { background: #4ec9b0; color: #000; }
        .ws-disconnected { background: #f48771; color: #000; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #3e3e42; }
        th { background: #2d2d30; color: #4ec9b0; position: sticky; top: 0; }
        tr:hover { background: #2d2d30; }
        .src-ble { color: #4ec9b0; }
        .src-debug { color: #dcdcaa; }
        button { background: #0e639c; color: #fff; border: none; padding: 8px 15px; cursor: pointer; border-radius: 3px; }
        button:hover { background: #1177bb; }
    </style>
</head>
<body>
    <h1>is03 Relay - BLE Event Monitor</h1>
    
    <div id="status">
        <strong>Hostname:</strong> <span id="hostname">-</span> |
        <strong>Uptime:</strong> <span id="uptime">-</span> |
        <strong>Bluetooth:</strong> <span id="bluetooth">-</span> |
        <strong>Ring:</strong> <span id="ring">-</span> |
        <strong>Queue:</strong> <span id="queue">-</span> |
        <strong>Last Flush:</strong> <span id="flush">-</span>
        <span id="ws-status" class="ws-disconnected">WS: Disconnected</span>
    </div>
    
    <button onclick="loadEvents()">Reload Events</button>
    <button onclick="publishSample()">Publish Debug Event</button>
    
    <h2>Recent Events (<span id="event-count">0</span>)</h2>
    <table>
        <thead>
            <tr>
                <th>Time</th>
                <th>Source</th>
                <th>MAC</th>
                <th>RSSI</th>
                <th>lacisId</th>
            </tr>
        </thead>
        <tbody id="events"></tbody>
    </table>
    
    <script>
        let ws = null;
        
        function connectWS() {
            const wsUrl = 'ws://' + location.host + '/ws';
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                document.getElementById('ws-status').textContent = 'WS: Connected';
                document.getElementById('ws-status').className = 'ws-connected';
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                prependEvent(data);
            };
            
            ws.onclose = () => {
                document.getElementById('ws-status').textContent = 'WS: Disconnected';
                document.getElementById('ws-status').className = 'ws-disconnected';
                setTimeout(connectWS, 3000);
            };
        }
        
        async function loadStatus() {
            const res = await fetch('/api/status');
            const data = await res.json();
            document.getElementById('hostname').textContent = data.hostname;
            document.getElementById('uptime').textContent = data.uptimeSec + 's';
            document.getElementById('bluetooth').textContent = data.bluetooth;
            document.getElementById('ring').textContent = data.ringSize;
            document.getElementById('queue').textContent = data.queuedWrites;
            document.getElementById('flush').textContent = data.lastFlushAt || 'Never';
        }
        
        async function loadEvents() {
            const res = await fetch('/api/events?limit=200');
            const events = await res.json();
            document.getElementById('event-count').textContent = events.length;
            const tbody = document.getElementById('events');
            tbody.innerHTML = '';
            events.forEach(e => prependEvent(e));
        }
        
        function prependEvent(e) {
            const tbody = document.getElementById('events');
            const row = tbody.insertRow(0);
            row.innerHTML = '<td>' + e.seenAt + '</td>' +
                          '<td class="src-' + e.src + '">' + e.src + '</td>' +
                          '<td>' + e.mac + '</td>' +
                          '<td>' + (e.rssi || '-') + '</td>' +
                          '<td>' + (e.lacisId || '-') + '</td>';
            const count = parseInt(document.getElementById('event-count').textContent);
            document.getElementById('event-count').textContent = count + 1;
        }
        
        async function publishSample() {
            await fetch('/api/debug/publishSample', { method: 'POST' });
        }
        
        connectWS();
        loadStatus();
        loadEvents();
        setInterval(loadStatus, 5000);
    </script>
</body>
</html>
