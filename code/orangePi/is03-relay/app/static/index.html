<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>is03 Relay - BLE Event Monitor</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #1e1e1e; color: #d4d4d4; }
        h1 { color: #4ec9b0; }
        #status { margin-bottom: 20px; padding: 10px; background: #2d2d30; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { padding: 6px; text-align: left; border-bottom: 1px solid #3e3e42; }
        th { background: #2d2d30; color: #4ec9b0; position: sticky; top: 0; }
        tr:hover { background: #2d2d30; }
        .src-ble { color: #4ec9b0; }
        .src-is02 { color: #ce9178; font-weight: bold; }
        .src-debug { color: #dcdcaa; }
        button { background: #0e639c; color: #fff; border: none; padding: 8px 15px; cursor: pointer; border-radius: 3px; margin-right: 5px; }
        button:hover { background: #1177bb; }
        .temp { color: #ff6b6b; }
        .humidity { color: #4ecdc4; }
        .battery { color: #95e1d3; }
    </style>
</head>
<body>
    <h1>is03 Relay - BLE Event Monitor</h1>

    <div id="status">
        <strong>Hostname:</strong> <span id="hostname">-</span> |
        <strong>Uptime:</strong> <span id="uptime">-</span> |
        <strong>Bluetooth:</strong> <span id="bluetooth">-</span> |
        <strong>Ring:</strong> <span id="ring">-</span> |
        <strong>Queue:</strong> <span id="queue">-</span> |
        <strong>Last Flush:</strong> <span id="flush">-</span>
    </div>

    <button onclick="loadEvents()">Reload Events</button>
    <button onclick="publishSample()">Publish Debug Event</button>
    <label style="margin-left: 20px;">
        <input type="checkbox" id="filter-ble" onchange="applyFilter()"> Hide BLE events
    </label>

    <h2>Recent Events (<span id="event-count">0</span>)</h2>
    <table>
        <thead>
            <tr>
                <th>Time</th>
                <th>Source</th>
                <th>MAC</th>
                <th>RSSI</th>
                <th>Temp(Â°C)</th>
                <th>Humidity(%)</th>
                <th>Battery(%)</th>
                <th>lacisId</th>
            </tr>
        </thead>
        <tbody id="events"></tbody>
    </table>

    <script>
        async function loadStatus() {
            const res = await fetch('/api/status');
            const data = await res.json();
            document.getElementById('hostname').textContent = data.hostname;
            document.getElementById('uptime').textContent = data.uptimeSec + 's';
            document.getElementById('bluetooth').textContent = data.bluetooth;
            document.getElementById('ring').textContent = data.ringSize;
            document.getElementById('queue').textContent = data.queuedWrites;
            document.getElementById('flush').textContent = data.lastFlushAt || 'Never';
        }

        async function loadEvents() {
            const res = await fetch('/api/events?limit=200');
            const events = await res.json();
            const tbody = document.getElementById('events');
            tbody.innerHTML = '';
            events.forEach(e => appendRow(e, tbody));
            document.getElementById('event-count').textContent = events.length;
        }

        function appendRow(e, tbody) {
            const row = tbody.insertRow();

            // Format temperature, humidity, battery
            const temp = e.temperatureC != null ? '<span class="temp">' + e.temperatureC.toFixed(2) + '</span>' : '-';
            const humidity = e.humidityPct != null ? '<span class="humidity">' + e.humidityPct.toFixed(1) + '</span>' : '-';
            const battery = e.batteryPct != null ? '<span class="battery">' + e.batteryPct + '</span>' : '-';

            row.innerHTML = '<td>' + e.seenAt + '</td>' +
                          '<td class="src-' + e.src + '">' + e.src + '</td>' +
                          '<td>' + (e.mac || '-') + '</td>' +
                          '<td>' + (e.rssi || '-') + '</td>' +
                          '<td>' + temp + '</td>' +
                          '<td>' + humidity + '</td>' +
                          '<td>' + battery + '</td>' +
                          '<td>' + (e.lacisId || '-') + '</td>';

            row.dataset.source = e.src;

            applyFilter();
        }

        function applyFilter() {
            const filterBle = document.getElementById('filter-ble').checked;
            const rows = document.querySelectorAll('#events tr');
            let visibleCount = 0;

            rows.forEach(row => {
                if (filterBle && row.dataset.source === 'ble') {
                    row.style.display = 'none';
                } else {
                    row.style.display = '';
                    visibleCount++;
                }
            });
        }

        async function publishSample() {
            await fetch('/api/debug/publishSample', { method: 'POST' });
        }

        loadStatus();
        loadEvents();
        setInterval(loadStatus, 5000);
        setInterval(loadEvents, 7000);
    </script>
</body>
</html>
