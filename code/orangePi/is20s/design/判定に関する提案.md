以下は、提示いただいた意見（=「gstatic偏重は自然」「SNIだけでは帰属不能」「ただし“見え方”改善と推定レイヤは有効」「QUIC/UDP443の取りこぼし注意」）を踏まえ、**IS-20S の改善案(1〜3)を“実装できる粒度”で詳細化**した設計案です。
※なお、現行実装は **UDP/443(QUIC) をBPFに含める**設定があり（`include_quic_udp_443` がデフォルト True、SYN-onlyでも `udp port 443` を捕捉）、tshark の抽出フィールドにも **QUIC系SNI (`gquic.tag.sni`)** が入っています。よって「QUIC未対応で0件」は“起こり得る落とし穴”としては妥当ですが、**現状コード上は一定対策済み**です。

---

## 0. 前提整理（今回の“問題”の正体）

* IS-20S の分類は **“観測できたドメイン”に対して**パターン辞書を当てる設計で、TLS/SNIの範囲では **`www.gstatic.com` が何のアプリ由来かを確定できない**（HTTPパス等が見えない）という結論は妥当です。
* 現行マッチングは「最初にヒットしたもの採用」で、ドット有り/無しで挙動が分岐します。
* `gstatic` は汎用として最後にマッチする想定で、`fonts.gstatic` / `maps.gstatic` / `youtube.gstatic` 等の“細分化”が先に並ぶ設計になっています。

この状況で起きているのは「分類バグ」というより、

1. **実トラフィックが `www.gstatic.com` に偏っていた**
2. その結果、**統計の“見え方”がCDN一色になって誤解を生む**
   の2点です。

---

## 1. 改善案1：gstaticカテゴリを CDN→Streaming に変更すべきか？

### 結論：**非推奨（変更しない）**

* `www.gstatic.com` は“動画ストリーム専用”ではなく、複数Googleサービスで共用され得るため、Streaming に寄せると **偽陽性（Streaming汚染）** が恒常化します。
* そもそも「YouTubeを検知したい」なら、一次ドメイン（例: `googlevideo`）が観測できることが本質で、カテゴリの付け替えでは根本解決になりません。

### 代替（見え方改善の“安全策”）

**カテゴリはCDNのまま**、次の2つを導入します（これが後述の案2/案3の土台になります）：

* **補助(Shared/Aux)フラグ**（例: `domain_role = "auxiliary"`）
* 統計表示で **“Primary(一次)” と “Auxiliary(補助/共有CDN)” を分離**（デフォルトはPrimary中心）

---

## 2. 改善案2：[www.gstatic.com](http://www.gstatic.com) 専用パターンを追加すべきか？

### 結論：**推奨（ただし“目的”は分類精度ではなく、説明力/可視化の改善）**

現行レポートにも「`www.gstatic` を追加してサービス名を明確化」という案があり、これは方向性として正しいです。

ただし、**現行の“ドット付きパターン”マッチ条件**だと、`www.gstatic`（ドット有り）を入れても `www.gstatic.com` にマッチしない可能性が高い（＝prefix位置を拾えない）ため、**辞書追加とセットでマッチャ改善**を入れるのが堅いです。

### 2-1) マッチングロジックの改善（prefix対応）

現行はドット付きパターンが「完全一致 / suffix一致 / 中間一致」しか見ません。
ここに **prefix一致**を追加します。

**仕様（ドット付きパターン）**

* 現状：

  * `domain == pattern`
  * `domain.endswith("." + pattern)`
  * `("." + pattern + ".") in domain`
* 追加：

  * `domain.startswith(pattern + ".")`  ← これで `fonts.gstatic.com` などが素直に当たる

この変更は “境界ドット” を保ったままマッチ範囲を拡張するだけなので、副作用が比較的読みやすいです。

### 2-2) gstaticファミリーの辞書整理（推奨セット）

`gstatic` を“汎用最後尾”に残しつつ、次を“先頭側”に積みます（既に存在する細分化も含め）：

* `www.gstatic` → service: `Google Shared CDN (www.gstatic)` / category: `CDN` / role: `auxiliary`
* `fonts.gstatic` → service: `Google Fonts` / category: `CDN` / role: `auxiliary`（既存）
* `maps.gstatic` → service: `Google Maps` / category: `Cloud` / role: `auxiliary`（既存）
* `youtube.gstatic` → service: `YouTube` / category: `Streaming` / role: `auxiliary`（既存）
* `gstatic` → service: `Google Shared CDN (gstatic)` / category: `CDN` / role: `auxiliary`（既存）

> ポイント：**カテゴリの変更はしない**。代わりに「Shared CDNである」ことを **service名 + role** で明示して、統計上の扱いを変えます。

---

## 3. 改善案3：複合判定（同一IPの複数ドメイン参照）を導入すべきか？

### 結論：**推奨（ただし“推定レイヤ”として。確定分類の上書きはしない）**

「同一IPの近接時間帯に観測された一次ドメインから、補助ドメインを帰属推定する」のは、**“CDN 87%問題”を人間が理解できる形に整える**のに効きます。

重要ガードレール：

* **ベース分類（domain_service / domain_category）は維持**
* 推定結果は別フィールドへ（例: `inferred_service`, `inferred_category`, `inference_confidence`, `inference_basis`）

### 3-1) 実装ポイント（入れ場所）

ローカルUIの `/api/capture/events` は、表示用バッファを取り出した後にドメインを決め、`domain_service/domain_category` を付与しています。
ここに **(a) role付与** と **(b) 推定** を追加するのが最小改修です。

現状のドメイン優先順位（`http_host > tls_sni > resolved_domain > dns_qry`）も明確なので、推定はこの“確定ドメイン”を入力にすればOKです。

### 3-2) 推定アルゴリズム（仕様案）

**入力**

* 現イベント `e`（src_ip, time, domain, domain_category, domain_service）
* src_ipごとの「直近一次イベント履歴」リングバッファ

**定義**

* `role == auxiliary` のドメイン（例: gstatic系）を推定対象とする
* `role != auxiliary` を “一次(Primary)” とみなす（SNS/Streaming/EC等）

**履歴の保持**

* key: `src_ip`
* value: deque（最大 N=100、または直近T=120秒以内のみ保持）

**推定ロジック（例）**

* 対象イベントが auxiliary のとき、同じ `src_ip` の履歴から

  * 直近 `T=60秒` の一次イベントを抽出
  * category/service ごとにスコアリング

    * 最新の1件を強く（例: `w = exp(-Δt/τ)`）
    * 同カテゴリ複数件で加点
  * 最大スコアの service/category を `inferred_*` として採用
* “一次イベントが0件”なら推定なし（null）

**出力フィールド案**

* `domain_role`: `"primary" | "auxiliary"`
* `inferred_service`: 例 `"YouTube"`
* `inferred_category`: 例 `"Streaming"`
* `inference_confidence`: 0.0〜1.0（スコア正規化）
* `inference_basis`: 例 `["googlevideo", "youtube"]`（根拠パターンやドメインの集合）

### 3-3) 統計(UI)の見せ方（仕様案）

* デフォルト表示：**Primaryのみ**（Auxiliaryは別枠の“補助通信”）
* トグル：

  * 「補助通信を含める」
  * 「補助通信を一次に帰属して再集計（推定）」
* 表示例：

  * Primary: Streaming 5, SNS 2 …
  * Auxiliary: Google Shared CDN 87 …
  * 推定ON: Streaming(+aux) 70, Cloud(+aux) 10 …

※UI側のフィルタ自体は “Stats表示用に限定” されることが前提なので、挙動の安全性は高いです（既存も同様の思想）。

---

## 4. “YouTube/Instagramが0件”に対する、実装上の追加チェック（意見の反映）

意見で指摘の「QUIC/UDP443取りこぼし」は、現状 **BPFがUDP443を含み**、tshark抽出にもQUIC系SNIが入っているため、コード面では一定対策されています。

ただし、運用上 “0件” が続く場合に備えて、次を改善案に含めるのが良いです：

### 4-1) 設定可視化（UI/Status）

* `include_quic_udp_443` が無効化されていないかを、Status/Config画面で明示（capture.pyの設定に存在）

### 4-2) QUICでSNIが取れない場合のフォールバック

DNSキャッシュの逆引きは「TCP SYNでSNIが無いとき」に書かれているため、同様の考えを UDP443 にも適用：

* `proto==udp` かつ `tls_sni` / `gquic_sni` が空なら
  `dns_cache.get(dst_ip)` を `resolved_domain` に入れて分類へ回す

これで「SNI抽出失敗＝Unknown」になりにくくなります。

---

## 5. 段階導入プラン（おすすめ）

### Phase A（低リスク・即効）

1. **マッチャにprefix対応追加**（ドット付きパターンの `startswith(pattern + ".")`）
2. **`www.gstatic` パターン追加**＋ service名を“Shared CDN”表現に寄せる
3. **role=auxiliary** を辞書に持たせ、APIが `domain_role` を返す

### Phase B（見え方改善：統計分離）

4. UIのStatisticsで

   * Primary / Auxiliary を分離表示
   * 「Auxiliaryを除外」トグル（デフォルトON）
   * “Shared CDNはアプリ帰属不能”の注記表示

### Phase C（高度化：推定）

5. `/api/capture/events` で推定レイヤを実装（上書き禁止）
6. UIで「推定を統計に反映」トグルを追加（デフォルトOFF推奨）

---

## 6. 受け入れ条件（Doneの定義）

* `www.gstatic.com` が出たとき、**serviceが “Google Shared CDN” として明示**される（分類はCDNのまま）
* Statisticsで “CDN 87%” のような状況でも

  * Primary表示では “CDN一色” にならず、**補助枠に退避**される
* YouTube再生などで一次ドメイン（例: googlevideo）が観測される場合、推定ON時に

  * `www.gstatic` が **YouTubeに帰属推定される**（ただし base分類は維持）

---

必要なら、この設計をそのまま `docs/is20s/IMPROVEMENT_DOMAIN_CLASSIFICATION_V2.md` の体裁（要件/非要件/IF/データモデル/疑似コード/テスト項目）で清書した“実装用ドキュメント”まで落として作ります。
