# スキャン結果カテゴリ表示改善 設計ドキュメント

## 1. 概要

### 1.1 目的
カメラスキャン結果の各カテゴリ表示を改善し、ユーザーにとって明確で理解しやすい情報提供を実現する。

### 1.2 対象ファイル
- バックエンド: `src/ipcam_scan/mod.rs` (カテゴリ定義)
- フロントエンド: `frontend/src/components/CameraScanModal.tsx` (表示ロジック)

### 1.3 現状の問題点（Camscan_designers_review.mdより）
| カテゴリ | 現状の問題 |
|---------|----------|
| A: 登録済み | 「登録済み」「認証済み」「カメラ認証済み」と類似文言が混在。カメラ名が表示されない |
| B: 登録可能 | 過去のスキャン結果かどうか不明。スキャン日時が表示されない |
| C: 認証必要 | 試行失敗したクレデンシャルが表示されない |
| D: その他カメラ | ほぼ100%カメラではないのに「その他カメラ」と表示 |
| E: 非カメラ | 問題なし |
| 共通 | 登録済みだが疎通なしのカメラが表示されない |

---

## 2. 改善設計

### 2.1 カテゴリ名称の変更

| 現行 | 変更後 | 説明 |
|------|--------|------|
| カテゴリ A: 登録済み | カテゴリ A: 登録済みカメラ | 変更なし |
| カテゴリ B: 登録可能 | カテゴリ B: 登録可能カメラ | 変更なし |
| カテゴリ C: 認証必要 | カテゴリ C: 認証待ちカメラ | 明確化 |
| カテゴリ D: その他カメラ | カテゴリ D: その他ネットワークデバイス | 誤解防止 |
| カテゴリ E: 非カメラ | カテゴリ E: 非対応デバイス | 変更なし |
| (新規) | カテゴリ F: 通信断カメラ | 登録済みだが疎通なし |

### 2.2 カテゴリ A: 登録済みカメラ

#### 2.2.1 表示要素の整理

**現行表示（問題あり）:**
```
192.168.125.12
カメラ確認済
D8:07:B6:53:47:3F
TP-LINK
Subnet: 192.168.125.0/24
tp-link Tapo C100 (1.3.9 Build 231019 Rel.36065n(4A50))
カメラ確認済み (RTSP応答あり)
全クレデンシャル不一致 - 設定確認が必要
```

**改善後表示:**
```
【ロビーカメラ1】 ← カメラ登録名を太字で表示
192.168.125.12
✓ 登録済み ✓ RTSP応答あり
D8:07:B6:53:47:3F (TP-LINK)
tp-link Tapo C100 (1.3.9)

⚠ 認証状態: 要確認
  登録済みクレデンシャルで接続できません
  試行済み: halecam/***, admin/***
```

#### 2.2.2 ステータス表示の統一

| ステータス | 表示 | 色 |
|-----------|------|-----|
| 登録済み + 認証OK | ✓ 登録済み ✓ 認証済み | 緑 |
| 登録済み + 認証NG | ✓ 登録済み ⚠ 認証要確認 | 黄 |
| 登録済み + 応答なし | ✓ 登録済み ✗ 応答なし | 赤 |

### 2.3 カテゴリ B: 登録可能カメラ

#### 2.3.1 スキャン日時の表示

**現行表示（問題あり）:**
```
192.168.96.80
カメラ確認済
認証済
Subnet: 192.168.96.0/24
認証: ismscam
カメラ確認済み (認証成功)
```

**改善後表示:**
```
192.168.96.80 (過去のスキャン: 2026/01/06 14:28)  ← 日時追加
カメラ確認済 ✓ 認証済み
Subnet: 192.168.96.0/24
認証ユーザー: ismscam

📝 今回のスキャン対象外サブネット
```

#### 2.3.2 サブネット判定ロジック

```rust
struct DeviceDisplayInfo {
    /// 最終スキャン日時
    last_scanned_at: DateTime<Utc>,
    /// 今回のスキャン対象サブネットか
    is_current_scan_target: bool,
    /// サブネット情報
    subnet: String,
}
```

### 2.4 カテゴリ C: 認証待ちカメラ

#### 2.4.1 試行済みクレデンシャルの表示

**現行表示（問題あり）:**
```
192.168.125.14
カメラ確認済
D8:07:B6:53:40:8E
TP-LINK
Subnet: 192.168.125.0/24
カメラ確認済み (RTSP応答あり)
全クレデンシャル不一致 - 設定確認が必要
```

**改善後表示:**
```
192.168.125.14
カメラ確認済（RTSP応答あり）
D8:07:B6:53:40:8E (TP-LINK)

🔐 試行済みクレデンシャル:
  × halecam / halecam12345@
  × admin / admin12345@

💡 登録済みカメラの場合: 【ロビーカメラ2】 ← 登録名があれば表示
```

#### 2.4.2 登録済みカメラとの照合

- IPアドレスが登録済みカメラと一致する場合、カメラ名を表示
- MACアドレスが登録済みカメラと一致する場合（IPが変わっている場合=StrayChild）、特別な警告を表示

### 2.5 カテゴリ D: その他ネットワークデバイス

#### 2.5.1 名称・説明の変更

**現行:**
```
カテゴリ D: その他カメラ
43台
```

**改善後:**
```
カテゴリ D: その他ネットワークデバイス
43台
（RTSP/ONVIF非対応 - カメラとして運用不可）
```

#### 2.5.2 サブカテゴリ表示

| サブカテゴリ | 条件 | 表示 |
|-------------|------|------|
| カメラ可能性あり | OUI一致 + HTTPポート | 📷 カメラの可能性あり |
| ネットワーク機器 | ルーター/スイッチ推定 | 🌐 ネットワーク機器 |
| IoTデバイス | 8443/443のみ | 📱 IoT/スマートデバイス |
| その他 | 上記以外 | ⚙️ 不明なデバイス |

### 2.6 新規カテゴリ F: 通信断カメラ

#### 2.6.1 概要
登録済みだがスキャンで疎通確認できなかったカメラを表示。

**表示例:**
```
カテゴリ F: 通信断カメラ
2台

【バックヤードカメラ】
192.168.125.99 (登録済み)
最終応答: 2026/01/05 18:32
⚠ ネットワーク確認が必要

【駐車場カメラ】
192.168.125.88 (登録済み)
最終応答: 2026/01/06 09:15
⚠ ネットワーク確認が必要
```

---

## 3. データ構造

### 3.1 バックエンドレスポンス拡張

```rust
#[derive(Debug, Serialize, Deserialize)]
pub struct ScannedDevice {
    // 既存フィールド
    pub ip_address: String,
    pub mac_address: Option<String>,
    pub vendor: Option<String>,
    pub score: u32,
    pub open_ports: Vec<u16>,

    // 新規フィールド
    pub registered_camera_name: Option<String>,  // 登録済みカメラ名
    pub last_scanned_at: DateTime<Utc>,          // 最終スキャン日時
    pub tried_credentials: Vec<TriedCredential>, // 試行済みクレデンシャル
    pub is_current_scan_target: bool,            // 今回のスキャン対象か
    pub device_category_detail: DeviceCategoryDetail, // 詳細カテゴリ
}

#[derive(Debug, Serialize, Deserialize)]
pub struct TriedCredential {
    pub username: String,
    pub password_masked: String,  // "***"でマスク、または最初と最後の文字のみ表示
    pub result: CredentialResult,
}

#[derive(Debug, Serialize, Deserialize)]
pub enum CredentialResult {
    Success,
    AuthFailed,
    Timeout,
    ConnectionRefused,
}

#[derive(Debug, Serialize, Deserialize)]
pub enum DeviceCategoryDetail {
    RegisteredAuthenticated,      // A: 登録済み・認証OK
    RegisteredAuthIssue,          // A: 登録済み・認証要確認
    Registrable,                  // B: 登録可能
    AuthRequired,                 // C: 認証待ち
    PossibleCamera,               // D: カメラ可能性あり
    NetworkEquipment,             // D: ネットワーク機器
    IoTDevice,                    // D: IoTデバイス
    UnknownDevice,                // D: 不明
    NonCamera,                    // E: 非カメラ
    LostConnection,               // F: 通信断
}
```

---

## 4. UI/UXガイドライン

### 4.1 色使い

| 状態 | 背景色 | テキスト色 | アイコン |
|------|--------|-----------|---------|
| 正常 | #E8F5E9 | #2E7D32 | ✓ |
| 警告 | #FFF3E0 | #E65100 | ⚠ |
| エラー | #FFEBEE | #C62828 | ✗ |
| 情報 | #E3F2FD | #1565C0 | ℹ |

### 4.2 カメラ名表示

- フォントサイズ: 16px (通常テキストより大きく)
- フォントウェイト: bold
- 表示形式: 【カメラ名】

### 4.3 日時表示フォーマット

- 今日: `今日 HH:mm`
- 昨日: `昨日 HH:mm`
- 今年: `MM/DD HH:mm`
- 去年以前: `YYYY/MM/DD HH:mm`

---

## 5. テスト計画

### 5.1 単体テスト
1. カテゴリ分類ロジックのテスト
2. 日時フォーマットのテスト
3. クレデンシャルマスク処理のテスト

### 5.2 結合テスト
1. 各カテゴリの表示確認
2. 登録済みカメラ名の取得・表示確認
3. 過去スキャン結果の日時表示確認

### 5.3 UIテスト
1. Chromeでの表示確認
2. 色・レイアウトの確認
3. レスポンシブ対応確認

---

## 6. MECE確認

- [x] 全カテゴリ（A〜F）が相互排他的に定義されている
- [x] 表示要素が網羅的に設計されている
- [x] 各問題点に対する解決策が明確に対応している
- [x] 新規カテゴリFで漏れていた「通信断カメラ」をカバー

---

## 7. 承認・実装フロー

1. [ ] 設計レビュー完了
2. [ ] GitHub Issue登録
3. [ ] 実装前コミット
4. [ ] バックエンド実装
5. [ ] フロントエンド実装
6. [ ] 単体テスト実行
7. [ ] 結合テスト実行
8. [ ] UIテスト実行
9. [ ] 完了報告

---

**作成日**: 2026-01-07
**作成者**: Claude Code
**ステータス**: 設計完了・レビュー待ち
