# 強制登録機能 設計ドキュメント

## 1. 概要

### 1.1 目的
クレデンシャル不一致でもカメラであることが確定的な場合に、ユーザーが強制的にカメラを登録できる機能を提供する。

### 1.2 対象ファイル
- バックエンド: `src/web_api/routes.rs` (approve_device)
- フロントエンド: `frontend/src/components/CameraScanModal.tsx`

### 1.3 現状の問題点（Camscan_designers_review.md #10より）
- カテゴリCのデバイスは選択できるが登録時に弾かれる
- 「カメラ全選択」ボタンがあるが認証未成功カメラは選択されない
- ユーザーが「絶対カメラだから登録したい」という要望に対応できない

---

## 2. 設計

### 2.1 強制登録の条件

| 条件 | 必須/任意 |
|------|----------|
| RTSPポート応答あり（554） | 必須 |
| MACアドレス取得済み | 必須 |
| OUI一致（カメラベンダー） | 推奨 |
| 認証成功 | **不要** |

### 2.2 強制登録時のデフォルト値

```rust
struct ForceRegisterDefaults {
    /// RTSPストリームURL（クレデンシャル未設定）
    rtsp_url: String,  // "rtsp://<ip>:554/stream1"
    /// メインストリーム有効
    main_stream_enabled: true,
    /// サブストリーム無効（URLが不明なため）
    sub_stream_enabled: false,
    /// ポーリング無効（接続失敗するため）
    polling_enabled: false,
    /// ステータス: 認証待ち
    status: "pending_auth",
}
```

### 2.3 API設計

```
POST /api/scan/devices/approve
{
    "devices": [
        {
            "ip_address": "192.168.125.14",
            "force_register": true,  // 新規追加
            "force_reason": "Camera confirmed by RTSP response"  // 任意
        }
    ]
}

Response:
{
    "success": true,
    "data": {
        "registered": [
            {
                "ip_address": "192.168.125.14",
                "camera_id": 123,
                "status": "pending_auth",
                "message": "強制登録完了。認証情報の設定が必要です。"
            }
        ]
    }
}
```

### 2.4 UI設計

#### 2.4.1 カテゴリCデバイス表示

```
192.168.125.14
カメラ確認済（RTSP応答あり）
D8:07:B6:53:40:8E (TP-LINK)

🔐 試行済みクレデンシャル:
  × halecam / ***
  × admin / ***

[✓ 選択] [⚠ 強制登録（認証なし）]
```

#### 2.4.2 強制登録確認ダイアログ

```
┌─────────────────────────────────────────────────┐
│ ⚠ 強制登録の確認                                │
├─────────────────────────────────────────────────┤
│ 以下のデバイスを認証なしで登録します:           │
│                                                 │
│ • 192.168.125.14 (TP-LINK)                     │
│                                                 │
│ ⚠ 注意事項:                                    │
│ • 映像取得はできません（認証情報未設定）        │
│ • 登録後にカメラ設定から認証情報を設定してください│
│ • 巡回対象には追加されません                   │
│                                                 │
│        [キャンセル]  [強制登録する]              │
└─────────────────────────────────────────────────┘
```

### 2.5 ボタン文言の変更

| 現行 | 変更後 |
|------|--------|
| カメラを全選択 | 認証可能カメラを全選択 |

---

## 3. テスト計画

### 3.1 単体テスト
1. 強制登録API条件チェックテスト
2. デフォルト値設定テスト

### 3.2 UIテスト
1. 強制登録ボタン表示確認
2. 確認ダイアログ表示確認
3. 登録後のステータス確認

---

## 4. MECE確認

- [x] 強制登録の条件が明確に定義
- [x] 登録後の状態が明確（pending_auth）
- [x] ユーザーへの注意喚起が設計されている

---

**作成日**: 2026-01-07
**作成者**: Claude Code
**ステータス**: 設計完了・レビュー待ち
