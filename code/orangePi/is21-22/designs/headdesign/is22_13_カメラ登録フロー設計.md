# is22 カメラ登録フロー設計

文書番号: is22_13
作成日: 2025-12-31
ステータス: Draft
参照:
- is22_Camserver仕様案 Section 5.1, 6.1-6.2, 8.8
- is22_09_IpcamScan設計
- CLAUDE.md (lacisID仕様)

---

## 1. 概要

### 1.1 目的

IpcamScanで発見されたカメラ候補を、ConfigStore.cameras (SSoT) へ安全に登録するためのフローを定義する。

### 1.2 設計原則

| 原則 | 適用 |
|-----|------|
| SSoT | cameras テーブルが唯一の真実 |
| アンアンビギュアス | 各状態遷移を明確に定義 |
| 自動登録禁止 | 誤検出リスク回避のため管理者承認必須 |
| クレデンシャル検証必須 | 未検証カメラはSSoT昇格不可 |

---

## 2. 状態遷移図

```
[スキャン対象IP]
       ↓ IpcamScan Stage 0-6
[ipcamscan_devices] ← DB永続化
  status: discovered
  verified: false
       ↓ 管理者がクレデンシャル入力
[ipcamscan_devices]
  status: verifying
       ↓ Verify API成功
[ipcamscan_devices]
  status: verified
  verified: true
  rtsp_uri: 確定
       ↓ 管理者が承認（Approve API）
[cameras (SSoT)]
  enabled: true
  lacis_id: 生成・登録
       ↓ araneaDeviceGate連携
[userObjectDetail]
  Typedomain: araneaDevice
```

---

## 3. データモデル

### 3.1 ipcamscan_devices（候補テーブル）

```sql
-- 追加カラム
ALTER TABLE ipcamscan_devices ADD COLUMN status
  ENUM('discovered', 'verifying', 'verified', 'rejected', 'approved')
  NOT NULL DEFAULT 'discovered';
```

| status | 意味 |
|--------|------|
| discovered | スキャンで発見、未検証 |
| verifying | クレデンシャル検証中 |
| verified | 検証成功、承認待ち |
| rejected | 管理者が却下 |
| approved | cameras昇格済み |

### 3.2 cameras (SSoT)

| カラム | 説明 |
|--------|------|
| camera_id | 一意ID (UUID) |
| lacis_id | araneaDevice lacisID (20桁) |
| source_device_id | ipcamscan_devices.device_id (参照元) |
| fid | 施設ID (4桁) |
| ... | 既存カラム |

### 3.3 facility_credentials（施設クレデンシャル）

```sql
CREATE TABLE facility_credentials (
    fid VARCHAR(4) PRIMARY KEY,
    username VARCHAR(64) NOT NULL,
    password_encrypted VARBINARY(256) NOT NULL,
    created_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
    updated_at DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## 4. API設計

### 4.1 クレデンシャル管理

```
POST /api/credentials/facility
```
施設単位のデフォルトクレデンシャル設定

Request:
```json
{
    "fid": "0150",
    "username": "halecam",
    "password": "hale0083@"
}
```

### 4.2 一括検証

```
POST /api/ipcamscan/devices/verify-batch
```
施設クレデンシャルで候補を一括検証

Request:
```json
{
    "fid": "0150",
    "device_ids": ["uuid1", "uuid2", ...],
    "use_facility_credentials": true
}
```

Response:
```json
{
    "ok": true,
    "results": [
        {"device_id": "uuid1", "verified": true, "rtsp_uri": "rtsp://..."},
        {"device_id": "uuid2", "verified": false, "error": "auth_failed"}
    ]
}
```

### 4.3 承認（cameras昇格）

```
POST /api/ipcamscan/devices/:device_id/approve
```
検証済みデバイスをcameras (SSoT) に登録

Request:
```json
{
    "display_name": "ロビーカメラ1",
    "location": "1F ロビー",
    "fid": "0150"
}
```

Response:
```json
{
    "ok": true,
    "camera": {
        "camera_id": "cam-uuid",
        "lacis_id": "30112233445566778899",
        "ip_address": "192.168.125.17"
    }
}
```

### 4.4 一括承認

```
POST /api/ipcamscan/devices/approve-batch
```
複数デバイスを一括承認

---

## 5. lacisID生成フロー

### 5.1 生成タイミング

cameras (SSoT) に登録時に自動生成

### 5.2 lacisID形式

```
[Prefix=3][ProductType=022][MAC=12桁][ProductCode=0001]
```

- Prefix: 3 (araneaDevice)
- ProductType: 022 (is22カメラ)
- MAC: カメラのMAC (取得できない場合はIPハッシュから生成)
- ProductCode: 連番

### 5.3 araneaDeviceGate連携

cameras登録後、バックグラウンドでaraneaDeviceGateに登録リクエスト

---

## 6. UI設計（3ペイン連携）

### 6.1 カメラ管理画面（設定ペイン）

| タブ | 内容 |
|-----|------|
| 登録済み | cameras (SSoT) 一覧 |
| 候補 | ipcamscan_devices (verified=true) 承認待ち |
| 発見 | ipcamscan_devices (verified=false) 未検証 |
| スキャン | スキャンジョブ管理 |

### 6.2 操作フロー

1. **スキャン実行**: サブネット指定してスキャン
2. **一括検証**: 施設クレデンシャルで一括verify
3. **確認**: 成功したものを「候補」タブで確認
4. **承認**: 必要なものを選択して一括approve
5. **運用**: 「登録済み」タブでポーリング/サジェスト対象として管理

---

## 7. 未検証候補の扱い

### 7.1 保存ポリシー

- **DB永続化**: ipcamscan_devicesに保存
- **TTL**: 設定可能（デフォルト30日）
- **再スキャン**: 既存候補とマージ（IPキーでUPSERT）

### 7.2 削除条件

| 条件 | 動作 |
|-----|------|
| TTL経過 | 自動削除 |
| 管理者却下 | status=rejected、保持 |
| 承認済み | status=approved、cameras参照あり |

---

## 8. セキュリティ

### 8.1 クレデンシャル保護

- facility_credentials.password_encrypted: AES-256暗号化
- ログにマスキング
- アクセス監査

### 8.2 承認フロー

- 自動登録禁止（設計原則）
- 管理者UIからの明示的操作のみ
- 承認履歴の記録

---

## 更新履歴

| 日付 | バージョン | 内容 |
|-----|-----------|------|
| 2025-12-31 | 1.0 | 初版作成 |
