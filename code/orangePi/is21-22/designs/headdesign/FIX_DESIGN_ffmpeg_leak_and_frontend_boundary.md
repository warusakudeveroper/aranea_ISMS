# 修正実装 概要設計ドキュメント
# ffmpegプロセスリーク + フロントエンド/バックエンド境界違反

**作成日**: 2026-01-05 11:00 JST
**関連Issue**: [#73](https://github.com/warusakudeveroper/aranea_ISMS/issues/73)
**調査ドキュメント**: [review1.md](./review1.md)
**障害レポート**: [INCIDENT_REPORT_20260105_ffmpeg_leak.md](../../../docs/is22/INCIDENT_REPORT_20260105_ffmpeg_leak.md)

---

# 絶対ルール（大原則の宣言）

本ドキュメントに基づく全ての実装・テスト作業は、以下の大原則を完全遵守する。
フェーズ開始前とフェーズ終了時に必ず全文省略なく復唱すること。

## 大原則（is22_Camserver実装指示.mdより転記）

1. **SSoTの大原則を遵守します**
2. **Solidの原則を意識し特に単一責任、開放閉鎖、置換原則、依存逆転に注意します**
3. **必ずMECEを意識し、このコードはMECEであるか、この報告はMECEであるかを報告の中に加えます。**
4. **アンアンビギュアスな報告回答を義務化しアンアンビギュアスに到達できていない場合はアンアンビギュアスであると宣言できるまで明確な検証を行います。**
5. **根拠なき自己解釈で情報に優劣を持たせる差別コード、レイシストコードは絶対の禁止事項です。情報の公平性原則**
6. **実施手順と大原則に違反した場合は直ちに作業を止め再度現在位置を確認の上でリカバーしてから再度実装に戻ります**
7. **チェック、テストのない完了報告はただのやった振りのためこれは行いません**
8. **依存関係と既存の実装を尊重し、確認し、車輪の再発明行為は絶対に行いません**
9. **作業のフェーズ開始前とフェーズ終了時に必ずこの実施手順と大原則を全文省略なく復唱します**
10. **必須参照の改変はゴールを動かすことにつながるため禁止です。**
11. **このドキュメントを全てのフェーズ前に鑑として再読し基本的な思想や概念的齟齬が存在しないかを確認します。**
12. **ルール無視はルールを無視した時点からやり直すこと。**

## 追加ルール（本実装固有）

13. **全てのテストはChromeブラウザで実施すること**
14. **UIテストでは全ボタン、全入力箇所を実際に操作して検証すること**
15. **「UIがあるからOK」「Diff見た感じ大丈夫そう」などの独善的判定は完了判定にならない**

---

# 1. 経緯（Background）

## 1.1 障害発生の時系列

| 日時 (JST) | イベント |
|------------|----------|
| 2026-01-05 01:23 | is22サービス起動 |
| 2026-01-05 03:10 | **最初のゾンビffmpegプロセス発生** (PID 1504968, 192.168.125.12) |
| 2026-01-05 06:07 | 192.168.125.19への大量蓄積開始 |
| 2026-01-05 07:51 | ゾンビffmpeg 37プロセス蓄積確認 |
| 2026-01-05 08:30 | 障害調査レポート作成開始 |
| 2026-01-05 10:45 | フロントエンド/バックエンド境界問題発見 |

## 1.2 障害の影響

- **主影響**: Tapoカメラ（192.168.125.19）の接続スロット枯渇（2-4接続制限に対し32プロセス占有）
- **副影響**: 同一カメラへの新規接続が全て失敗（垂直依存）
- **波及なし**: カメラ間の障害伝播は発生していない（水平独立確認済み）

## 1.3 調査範囲

1. **ffmpegプロセスリーク問題**: `snapshot_service/mod.rs`のプロセス管理
2. **フロントエンド/バックエンド境界違反**: SuggestPaneの再生トリガー
3. **go2rtc統合の不完全性**: StreamGateway.remove_source()未使用

---

# 2. 調査内容コンテキスト（Investigation Context）

## 2.1 調査方法

| 調査項目 | 手法 | エビデンス |
|----------|------|------------|
| ffmpegプロセス蓄積 | `ps aux | grep ffmpeg` | review1.md Section 2 |
| プロセス親子関係 | `ps -eo pid,ppid,lstart,args` | review1.md Section 7 |
| コードパス分析 | ソースコード静的解析 | review1.md Section 4, 5, 6 |
| 依存関係検証 | エラータイプ別カメラ分布 | review1.md Section 10 |
| フロントエンド動作 | Chromeデベロッパーツール | review1.md Section 12 |

## 2.2 問題1: ffmpegプロセスリーク

### 2.2.1 根本原因

**ファイル**: `src/snapshot_service/mod.rs` (Lines 270-288)

```rust
async fn capture_rtsp(&self, rtsp_url: &str) -> Result<Vec<u8>> {
    let output = Command::new("ffmpeg")
        .args([...])
        .output()  // ← 問題箇所: タイムアウト管理なし、子プロセスPID追跡なし
        .await
        .map_err(...)?;
    // ...
}
```

**問題の連鎖**:
1. ffmpegがRTSP接続でハング（カメラ無応答など）
2. 30秒タイムアウト発生（polling_orchestrator）→ Futureがキャンセル
3. **ffmpegプロセスは生存したまま**（RTSPコネクション保持）
4. 次のポーリングサイクルで新しいffmpegが起動
5. Tapoカメラは最大2-4接続制限 → 接続スロット枯渇

### 2.2.2 設計との乖離

| 設計意図 | 実装状態 | 乖離度 |
|----------|----------|--------|
| ffmpegプロセスkill | **未実装** | 致命的 |
| サブネット巡回終了時クリーンアップ | **未実装** | 高 |
| go2rtc常時利用 | 視聴者がいる時のみ | 中 |
| プロセス監視 | **未実装** | 中 |

## 2.3 問題2: フロントエンド/バックエンド境界違反

### 2.3.1 設計意図

> 「SuggestPaneの再生は推論判定からスタートする。レンダリングはフロントエンドでも、接続ロジックや再生時間カウントはバックエンドロジック」

**つまり**:
- **バックエンドトリガー**: AI推論検出 → WebSocket通知 → 再生開始
- **フロントエンドの役割**: レンダリングのみ（接続判断をしない）

### 2.3.2 問題のシーケンス

**正常フロー（AI推論トリガー）**:
```
IS21 AI推論検出
    ↓
is22バックエンド WebSocket "event_log" 送信
    ↓
フロントエンド受信 → handleEventLog() → fetchLogs()
    ↓
detectionLogs更新 → currentEvent更新
    ↓
SuggestPane: lastEventIdRef != currentEvent.log_id → 再生開始
✅ バックエンドトリガー（正しい）
```

**問題フロー（ページリロード）**:
```
ユーザーがページをリロード
    ↓
App.tsx useEffect → fetchLogs() (マウント時)
    ↓
既存の古い検出ログを取得
    ↓
currentEvent = 古い検出
    ↓
SuggestPane: lastEventIdRef = null (リロードでリセット)
    ↓
古い検出を「新規」として再生開始
❌ フロントエンドトリガー（違反）
```

### 2.3.3 影響

- ページリロード時にAI推論なしでカメラ接続が発生
- go2rtc視聴者検出ロジックに不正な視聴者として影響
- バックエンドのポーリングロジック（go2rtc視聴者検出 → ffmpegスキップ）への干渉

## 2.4 問題3: go2rtc統合の不完全性

### 2.4.1 未使用コード

**ファイル**: `src/stream_gateway/mod.rs` (Lines 111-125)

```rust
/// Remove a stream source
pub async fn remove_source(&self, name: &str) -> Result<()> {
    let url = format!("{}/api/streams?name={}", self.base_url, name);
    let resp = self.client.delete(&url).send().await?;
    // ...
}
```

**問題**: この関数は存在するが、**どこからも呼び出されていない**。

### 2.4.2 設計意図との乖離

- サブネット巡回終了時のストリーム解除が未実装
- コンストラクト-ディストラクト型巡回が未実装

---

# 3. 結論（Conclusions）

## 3.1 MECE分析

| 問題領域 | 問題 | 影響度 | 原因カテゴリ |
|----------|------|--------|--------------|
| **バックエンド/プロセス管理** | ffmpegプロセスリーク | 致命的 | コード欠陥 |
| **バックエンド/リソース管理** | StreamGateway.remove_source()未使用 | 高 | 実装漏れ |
| **フロントエンド/ロジック境界** | ページリロード時の不正再生 | 中 | 設計違反 |
| **統合/go2rtc** | 視聴者なし時のffmpegフォールバック | 中 | 設計判断 |

## 3.2 アンアンビギュアスな結論

1. **ffmpegプロセスリークは確実に発生している** - プロセスリスト、生存時間、接続数のエビデンスあり
2. **フロントエンド/バックエンド境界違反は確実に存在する** - コードパス分析で確認済み
3. **カメラ間の波及は発生していない** - エラータイプ別分析で確認済み（垂直依存のみ）
4. **go2rtc統合は部分的** - 視聴者検出ロジックのみ実装、クリーンアップ未実装

---

# 4. 修正意図（Modification Intent）

## 4.1 修正方針の全体像

```
┌─────────────────────────────────────────────────────────────┐
│                    修正方針サマリー                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [問題1] ffmpegプロセスリーク                               │
│    ↓                                                        │
│  修正: Command::spawn() + child.kill() パターンへ変更       │
│  影響: snapshot_service/mod.rs                              │
│                                                             │
│  [問題2] フロントエンド/バックエンド境界違反                 │
│    ↓                                                        │
│  修正: WebSocket経由イベントのみ再生対象に限定              │
│  影響: frontend/src/App.tsx, frontend/src/components/       │
│        SuggestPane.tsx                                      │
│                                                             │
│  [問題3] go2rtc統合不完全                                   │
│    ↓                                                        │
│  修正: サブネット巡回終了時にremove_source()呼び出し        │
│  影響: polling_orchestrator/mod.rs, stream_gateway/mod.rs   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 4.2 修正項目一覧

| ID | 修正項目 | 優先度 | 難易度 | 影響範囲 |
|----|----------|--------|--------|----------|
| FIX-001 | ffmpegプロセスkill実装 | P0 | 中 | snapshot_service |
| FIX-002 | フロントエンド再生トリガー修正 | P0 | 低 | frontend |
| FIX-003 | サブネット巡回終了時クリーンアップ | P1 | 中 | polling_orchestrator, stream_gateway |
| FIX-004 | ゾンビプロセス定期クリーンアップ | P2 | 中 | 新規モジュール |
| FIX-005 | プロセス監視アラート | P2 | 低 | 運用設定 |

## 4.3 各修正項目の意図

### FIX-001: ffmpegプロセスkill実装

**現状**:
```rust
Command::new("ffmpeg").args([...]).output().await
```

**修正後**:
```rust
let mut child = Command::new("ffmpeg").args([...]).spawn()?;
match tokio::time::timeout(Duration::from_secs(timeout), child.wait_with_output()).await {
    Ok(output) => { /* 正常処理 */ }
    Err(_) => {
        let _ = child.kill().await;  // タイムアウト時に明示的kill
        return Err(...);
    }
}
```

**意図**: タイムアウト発生時に子プロセスを確実に終了させ、ゾンビ蓄積を防止

### FIX-002: フロントエンド再生トリガー修正

**現状**:
- fetchLogs()結果からcurrentEventを算出 → SuggestPane再生

**修正後**:
- WebSocket "event_log"受信時のみcurrentEventを更新
- HTTPフェッチ結果はEventLogPane表示用のみ

**意図**: バックエンド（AI推論）トリガーのみで再生を開始し、設計意図に準拠

### FIX-003: サブネット巡回終了時クリーンアップ

**現状**:
- StreamGateway.remove_source()は存在するが未使用

**修正後**:
- サブネット巡回完了後にremove_source()を呼び出し
- go2rtcからストリームを削除してRTSP接続を解放

**意図**: コンストラクト-ディストラクト型巡回の実現、リソースリーク防止

---

# 5. 実装計画（次ドキュメントへ続く）

本概要設計に基づき、以下のドキュメントを順次作成する：

1. **FIX-001 詳細設計**: `FIX_DETAIL_001_ffmpeg_process_kill.md`
2. **FIX-002 詳細設計**: `FIX_DETAIL_002_frontend_boundary.md`
3. **FIX-003 詳細設計**: `FIX_DETAIL_003_cleanup_on_cycle_end.md`
4. **テスト計画**: `TEST_PLAN_ffmpeg_leak_fix.md`
5. **受け入れ基準**: 各詳細設計に含める

---

# 6. 検証チェックリスト

## 6.1 設計ドキュメント検証

- [ ] 本ドキュメントはreview1.mdの調査結果を正確に反映しているか
- [ ] 本ドキュメントはis22_Camserver実装指示.mdの大原則に準拠しているか
- [ ] 本ドキュメントはMECEであるか
- [ ] 本ドキュメントはアンアンビギュアスであるか

## 6.2 実装・プロセスチェーン検証

- [ ] FIX-001の修正箇所はsnapshot_service/mod.rsのcapture_rtsp()のみで完結するか
- [ ] FIX-002の修正箇所はfrontendのみで完結するか（バックエンド変更不要）
- [ ] FIX-003の修正箇所はpolling_orchestrator + stream_gatewayで完結するか
- [ ] 各修正項目間の依存関係は存在しないか（並列実装可能か）

---

# 更新履歴

| 日時 (JST) | 内容 |
|------------|------|
| 2026-01-05 11:00 | 初版作成 |

---

**作成者**: Claude Code
**ステータス**: 検証待ち
