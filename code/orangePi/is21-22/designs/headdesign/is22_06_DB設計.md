# is22 DB設計

文書番号: is22_06
作成日: 2025-12-29
ステータス: Draft
参照: 特記仕様1 Section 1

---

## 1. 概要

### 1.1 データベース情報
| 項目 | 値 |
|-----|-----|
| DBMS | MariaDB |
| データベース名 | camserver |
| 文字セット | utf8mb4 |
| 照合順序 | utf8mb4_unicode_ci |
| エンジン | InnoDB |

### 1.2 テーブル一覧
| テーブル | 用途 |
|---------|------|
| cameras | カメラ設定 |
| camera_streams | ストリームURL |
| camera_auth | 認証情報 |
| camera_overrides | 個別設定 |
| schema_versions | タグスキーマ |
| frames | スナップショット |
| frame_tags | フレームタグ（検索用） |
| events | イベント（連続検知） |
| event_tags | イベントタグ（検索用） |
| drive_objects | Drive保存情報 |
| llm_reviews | VLMエスカレーション履歴 |
| notifications | 通知履歴 |
| hourly_stats | 時間別統計 |
| settings | 設定KVS |
| inference_jobs | 推論ジョブキュー |

---

## 2. ER図（主要テーブル）

```
cameras ──1:N── camera_streams
    │           camera_auth (1:1)
    │           camera_overrides (1:1)
    │
    └──1:N── frames ──1:N── frame_tags
                 │
                 └── drive_objects (1:1)
                 │
                 └── inference_jobs (1:1)
    │
    └──1:N── events ──1:N── event_tags
                 │
                 └── best_frame_id → frames
```

---

## 3. 主要テーブル詳細

### 3.1 cameras
| カラム | 型 | 説明 |
|-------|-----|------|
| camera_id | VARCHAR(64) PK | カメラ識別子 |
| display_name | VARCHAR(128) | 表示名 |
| location_label | VARCHAR(128) | 場所ラベル |
| site_label | VARCHAR(64) | 拠点ラベル |
| network_zone | ENUM('local','vpn') | ネットワーク種別 |
| enabled | TINYINT(1) | 有効/無効 |
| polling_interval_sec | SMALLINT | 収集間隔 |
| preferred_stream | ENUM('main','sub') | 優先ストリーム |

### 3.2 frames
| カラム | 型 | 説明 |
|-------|-----|------|
| frame_id | BIGINT UNSIGNED PK | 内部ID |
| frame_uuid | CHAR(36) UK | 外部参照用UUID |
| camera_id | VARCHAR(64) FK | カメラID |
| captured_at | DATETIME(3) | キャプチャ時刻 |
| collector_status | ENUM('ok','timeout','error') | 収集結果 |
| diff_ratio | DECIMAL(9,6) | 差分率 |
| luma_delta | SMALLINT | 輝度差 |
| analyzed | TINYINT(1) | 推論実施済み |
| detected | TINYINT(1) | 検知あり |
| primary_event | VARCHAR(32) | 主イベント |
| severity | TINYINT UNSIGNED | 重要度(0-3) |
| confidence | DECIMAL(4,3) | 信頼度(0-1) |
| drive_file_id | VARCHAR(128) | DriveファイルID |
| retention_class | ENUM('normal','quarantine','case') | 保持区分 |

### 3.3 events
| カラム | 型 | 説明 |
|-------|-----|------|
| event_id | BIGINT UNSIGNED PK | 内部ID |
| event_uuid | CHAR(36) UK | 外部参照用UUID |
| camera_id | VARCHAR(64) FK | カメラID |
| start_at | DATETIME(3) | 開始時刻 |
| last_seen_at | DATETIME(3) | 最終検知時刻 |
| end_at | DATETIME(3) | 終了時刻 |
| state | ENUM('open','closed') | 状態 |
| primary_event | VARCHAR(32) | 主イベント |
| severity_max | TINYINT UNSIGNED | 最大重要度 |
| best_frame_id | BIGINT UNSIGNED FK | 代表フレーム |
| retention_class | ENUM | 保持区分 |

### 3.4 inference_jobs
| カラム | 型 | 説明 |
|-------|-----|------|
| job_id | BIGINT UNSIGNED PK | ジョブID |
| frame_id | BIGINT UNSIGNED FK UK | フレームID |
| status | ENUM('queued','running','done','dead') | 状態 |
| priority | TINYINT UNSIGNED | 優先度(0-255) |
| attempt | TINYINT UNSIGNED | 試行回数 |
| max_attempt | TINYINT UNSIGNED | 最大試行 |
| available_at | DATETIME(3) | 処理可能時刻 |
| locked_by | VARCHAR(128) | ロック者 |
| locked_token | CHAR(36) | ロックトークン |

---

## 4. インデックス設計

### 4.1 frames
| インデックス名 | カラム | 用途 |
|--------------|--------|------|
| PRIMARY | frame_id | - |
| uq_frames_uuid | frame_uuid | UUID検索 |
| idx_frames_camera_time | camera_id, captured_at | カメラ別時系列 |
| idx_frames_detected_time | detected, captured_at | 検知フレーム検索 |
| idx_frames_event_time | primary_event, captured_at | イベント種別検索 |
| idx_frames_severity_time | severity, captured_at | 重要度検索 |

### 4.2 events
| インデックス名 | カラム | 用途 |
|--------------|--------|------|
| PRIMARY | event_id | - |
| uq_events_uuid | event_uuid | UUID検索 |
| idx_events_camera_start | camera_id, start_at | カメラ別時系列 |
| idx_events_event_start | primary_event, start_at | イベント種別検索 |

### 4.3 frame_tags / event_tags
| インデックス名 | カラム | 用途 |
|--------------|--------|------|
| PRIMARY | (frame_id, tag_id) | - |
| idx_frame_tags_tag | tag_id | タグ逆引き |

---

## 5. 保持ポリシー

### 5.1 framesテーブル
| 区分 | 条件 | 保持期間 |
|-----|------|---------|
| no_event | detected=0 | 7-14日 |
| detected | detected=1, normal | 30日 |
| quarantine | retention_class=quarantine | 60日 |
| case | retention_class=case | 手動 |

### 5.2 eventsテーブル
| 区分 | 保持期間 |
|-----|---------|
| normal | 90日 |
| quarantine | 180日 |
| case | 手動 |

### 5.3 hourly_stats
- 保持期間: 365日
- 日次バッチでframes集計→hourly_stats INSERT

### 5.4 削除バッチ
```sql
-- no_event frames削除（14日経過）
DELETE FROM frames
WHERE detected = 0
  AND captured_at < DATE_SUB(NOW(), INTERVAL 14 DAY)
LIMIT 10000;

-- 古いnotifications削除（30日経過）
DELETE FROM notifications
WHERE created_at < DATE_SUB(NOW(), INTERVAL 30 DAY)
LIMIT 10000;
```

---

## 6. マイグレーション

### 6.1 初期DDL
`特記仕様1 Section 1` のDDLをそのまま使用

### 6.2 追加マイグレーション
```sql
-- migrations/002_inference_jobs.sql
CREATE TABLE IF NOT EXISTS inference_jobs (
  -- 特記仕様3参照
);

-- migrations/003_events_last_seen.sql
ALTER TABLE events
  ADD COLUMN last_seen_at DATETIME(3) NOT NULL AFTER start_at;
```

---

## 7. バックアップ

### 7.1 日次バックアップ
```bash
#!/bin/bash
# /opt/camserver/scripts/backup.sh
DATE=$(date +%Y%m%d)
mysqldump -u camserver -p camserver \
  --single-transaction \
  --routines \
  --triggers \
  > /backup/camserver_${DATE}.sql

# 7日以上古いバックアップ削除
find /backup -name "camserver_*.sql" -mtime +7 -delete
```

### 7.2 バックアップ対象
| 対象 | 頻度 | 方法 |
|-----|------|------|
| 全テーブル | 日次 | mysqldump |
| 設定テーブル | 変更時 | mysqldump |

---

## 8. 監視項目

### 8.1 容量監視
```sql
SELECT table_name,
       ROUND(data_length / 1024 / 1024, 2) as data_mb,
       ROUND(index_length / 1024 / 1024, 2) as index_mb,
       table_rows
FROM information_schema.tables
WHERE table_schema = 'camserver'
ORDER BY data_length DESC;
```

### 8.2 アラート閾値
| 項目 | 閾値 |
|-----|------|
| framesレコード数 | > 1,000,000 |
| ディスク使用率 | > 80% |
| スロークエリ | > 1秒 |

---

## 9. テスト観点

### 9.1 DDL
- [ ] 全テーブル作成成功
- [ ] 外部キー制約動作
- [ ] インデックス使用確認（EXPLAIN）

### 9.2 データ整合性
- [ ] frames→events連携
- [ ] CASCADE DELETE動作
- [ ] 重複INSERT防止

### 9.3 性能
- [ ] 大量データでの検索性能
- [ ] 削除バッチの実行時間
