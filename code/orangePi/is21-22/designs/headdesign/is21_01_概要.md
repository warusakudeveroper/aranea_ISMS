# is21 概要・責務定義

文書番号: is21_01
作成日: 2025-12-29
ステータス: Draft

---

## 1. デバイス情報

| 項目 | 値 |
|-----|-----|
| デバイスID | ar-is21o |
| 名称 | camimageEdge AI |
| 機材 | Orange Pi 5 Plus |
| OS | Armbian Ubuntu 24.04 (Noble) Minimal/IOT |
| カーネル | Armbian Linux v6.1 |
| NPU | RKNN2 (RK3588) |
| メモリ | 16GB |
| ストレージ | 128GB eMMC |

---

## 2. 役割定義

### 2.1 責務（MUST）
- HTTP APIで推論リクエストを受け付ける
- 画像を解析し、enum/tag形式で結果を返す
- スキーマ（タグ定義）をis22から受け取り保持する
- ヘルスチェックAPIを提供する

### 2.2 責務外（MUST NOT）
- 画像の収集（RTSPアクセス）
- 画像の永続保存
- データベースへの書き込み
- Web UIの提供
- 通知の送信
- 自然言語テキストの生成

---

## 3. 設計原則

### 3.1 ステートレス設計
- 推論リクエストは独立（前後の状態に依存しない）
- スキーマのみをメモリにキャッシュ
- ファイルシステムへの書き込みは行わない（ログ除く）

### 3.2 単一責任
- 推論処理に特化
- 複雑なビジネスロジックはis22に委譲

### 3.3 フォールトトレランス
- is21停止時、is22は推論をスキップしてno_event扱い
- 再起動後、is22がスキーマを再プッシュ

---

## 4. インターフェース概要

### 4.1 入力
| 項目 | 形式 | 発信元 |
|-----|------|-------|
| スキーマ | JSON | is22（PUT /v1/schema） |
| 推論リクエスト | multipart/form-data | is22（POST /v1/analyze） |

### 4.2 出力
| 項目 | 形式 | 送信先 |
|-----|------|-------|
| 推論結果 | JSON（enum/tag配列） | is22 |
| ヘルス状態 | JSON | is22 |

---

## 5. ネットワーク

### 5.1 推奨配置
- is22と同一拠点（同一サブネット）
- VPN越しも可（1分周期・リサイズ済みなら許容）

### 5.2 ポート
| ポート | 用途 |
|-------|------|
| 9000/tcp | 推論API |
| 22/tcp | SSH（管理用） |

### 5.3 通信方向
```
is22 → is21（推論リクエスト）
is22 → is21（スキーマプッシュ）
is21 → is22（応答のみ、自発通信なし）
```

---

## 6. 推論モデル

### 6.1 初期モデル（案）
| 用途 | モデル | 備考 |
|-----|--------|------|
| 人物検出 | YOLO v8 (RKNN) | 軽量版推奨 |
| 動物検出 | YOLO v8 + custom | 鹿・猪対応 |
| 車両検出 | YOLO v8 | オプション |
| 品質判定 | 自前軽量CNN | blur/dark判定 |

### 6.2 属性抽出（観測事実）
- top_color: bbox内ヒストグラム → 代表色
- carry: YOLOオブジェクト検出
- behavior: フレーム単体では困難（オプション）

---

## 7. テスト観点

### 7.1 機能テスト
- [ ] /healthz が200を返す
- [ ] /v1/schema GET/PUT が正常動作
- [ ] /v1/analyze が画像を受け取りenum結果を返す
- [ ] 不正画像でも400でクラッシュしない
- [ ] schema_version不一致で409を返す

### 7.2 性能テスト
- [ ] 640px画像の推論が500ms以内
- [ ] 同時5リクエストでも応答可能
- [ ] 429返却時、既存リクエストは完了する

---

## 8. 次工程への引継ぎ

### 詳細設計で決定すべき事項
1. 推論モデルの具体的な選定（RKNN変換済みモデル）
2. RKNNランタイムのバージョン
3. Python vs Rust実装の最終決定
4. systemdサービス名・設定
