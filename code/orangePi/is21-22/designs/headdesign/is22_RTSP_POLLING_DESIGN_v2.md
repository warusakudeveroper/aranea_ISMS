# IS22 RTSPポーリング設計 v2

## 設計修正履歴
- v1: go2rtc経由でスナップショット取得 → WebSocketでUI更新（誤り）
- v2: RTSP直接取得 → IS21連携 → 検知時のみイベント通知（正）

## コンセプト（is22_Camserver実装指示.mdより）

> このis22は監視や防犯よりも画像を解析するis21との連携で一覧性を重視して
> スタッフの目線に近いところになんとなく映しておく
> "あ、お客さんきた。駐車場に車きたな"
> "お客さん同士でなんかトラブってるみたい"
> くらいの緩い情報粒度とイベント記録

**ポイント**:
- 監視カメラのガチ録画ではなく「なんとなく映しておく」
- IS21との連携で異常/状況検知
- AI Event Logで「{カメラ名}で{何か}」をキルログ形式で表示

---

## アーキテクチャ

### モジュール分離

```
┌─────────────────────────────────────────────────────────────┐
│ 画像巡回ポーリング（PollingOrchestrator + SnapshotService） │
│ - RTSPから直接フレーム取得（ffmpeg）                        │
│ - go2rtc非依存                                               │
│ - 軽量・独立・堅牢                                          │
└─────────────────────────────────────────────────────────────┘
           ↓ キャッシュ画像
┌─────────────────────────────────────────────────────────────┐
│ CameraGrid表示                                               │
│ - /api/snapshots/{camera_id}/latest.jpg を定期GET          │
│ - WebSocket不要                                              │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ ストリーム管理（go2rtc）                                    │
│ - 動画再生用ウォームアップ                                  │
│ - 低速低フレームで接続維持                                  │
│ - 画像巡回とは完全独立                                      │
└─────────────────────────────────────────────────────────────┘
```

---

## 画像ポーリングフロー

```
┌──────────────────────────────────────────────────────────────┐
│ 1. RTSPから1フレーム取得（ffmpeg）                          │
│    ffmpeg -i "rtsp://user:pass@IP/stream1"                  │
│           -frames:v 1 -f image2pipe -vcodec mjpeg -         │
│    → JPEGバイナリ取得                                       │
└──────────────────────────────────────────────────────────────┘
           ↓
┌──────────────────────────────────────────────────────────────┐
│ 2. ローカルキャッシュ保存（表示用）                          │
│    /var/lib/is22/snapshots/{camera_id}/latest.jpg          │
│    ※ 常に上書き、表示用なので保存期間管理対象外            │
└──────────────────────────────────────────────────────────────┘
           ↓
┌──────────────────────────────────────────────────────────────┐
│ 3. IS21にPOST（差分検知用）                                 │
│    POST http://192.168.3.240:9000/v1/analyze                │
│    Body: multipart/form-data                                │
│      - prev_image: 前回の画像（差分検知用）                 │
│      - current_image: 今回の画像                            │
│      - camera_id: カメラID                                  │
│      - camera_context: カメラの設置コンテキスト             │
│    ※ リサイズ設定: 将来実装（現在はそのまま）              │
└──────────────────────────────────────────────────────────────┘
           ↓
┌──────────────────────────────────────────────────────────────┐
│ 4. IS21レスポンス処理                                       │
│                                                              │
│    「何もない」場合:                                         │
│      - 画像保存しない                                        │
│      - イベント通知しない                                    │
│                                                              │
│    「何かある」場合:                                         │
│      - 元画像（リサイズなし）をローカル保存                 │
│        /var/lib/is22/events/{camera_id}/{timestamp}.jpg     │
│      - Google Drive APIでクラウド保存（将来実装）           │
│      - EventLogServiceにイベント追加                        │
│      - RealtimeHubでAI Event Logに通知（WebSocket）         │
└──────────────────────────────────────────────────────────────┘
```

---

## AI Event Log（WebSocket）

### 用途
- IS21からの検知結果を通知
- MMO/FPSのキルログ形式で表示
- 「{カメラ名}で{イベント内容}」+ タイムスタンプ

### メッセージ形式
```json
{
  "type": "event_log",
  "data": {
    "event_id": 12345,
    "camera_id": "cam-xxx",
    "camera_name": "フロント入口",
    "primary_event": "人物を検知",
    "severity": 1,
    "timestamp": "2026-01-02T06:30:00+09:00",
    "details": {
      "person_count": 2,
      "objects": ["person", "suitcase"]
    }
  }
}
```

### 表示例（UI）
```
┌─────────────────────────────────────────┐
│ AI Event Log                            │
├─────────────────────────────────────────┤
│ 06:30:15  フロント入口 → 人物を検知(2)  │
│ 06:28:42  駐車場カメラ → 車両を検知     │
│ 06:25:11  廊下カメラ → 人物を検知(1)    │
│ ...                                     │
└─────────────────────────────────────────┘
```

---

## CameraGrid表示

### 画像取得
- WebSocket不要
- 単純なHTTP GET: `/api/snapshots/{camera_id}/latest.jpg`
- フロントエンドで定期リロード（例: 5秒間隔）またはtimestamp付きURL

### アニメーション
- 当初設計の「上から下にスライド」アニメーションは維持可能
- ただしトリガーはWebSocketではなくフロントエンドのリロードタイミング

---

## 画像保存ルール

### キャッシュ画像（表示用）
- 場所: `/var/lib/is22/snapshots/{camera_id}/latest.jpg`
- 保存期間: N/A（常に上書き）
- 用途: CameraGrid表示用

### イベント画像（検知時のみ）
- 場所: `/var/lib/is22/events/{camera_id}/{timestamp}.jpg`
- 保存期間: 設定で指定（例: 7日）
- 自動バッチ削除: 毎日深夜に期限切れ画像を削除
- クラウド保存: Google Drive API（将来実装）

### 差分検知用一時画像
- 場所: `/var/lib/is22/temp/{camera_id}/prev.jpg`
- IS21送信後に今回画像を prev.jpg に移動

---

## 設定項目

### ポーリング設定（Settings Modal）
- 巡回間隔: 5秒〜60秒（デフォルト: 5秒）
- 画像リサイズ: ON/OFF + サイズ指定（将来実装）

### 保存設定
- ローカル保存期間: 1日〜30日（デフォルト: 7日）
- クラウド保存: ON/OFF（将来実装）

### 表示設定
- アニメーション: ON/OFF
- アニメーション方式: slide-down / fade

---

## 削除する実装

以下は誤った設計に基づく実装のため削除/修正:
1. ~~SnapshotUpdateMessage（WebSocket）~~ → 削除
2. ~~CameraGridのupdatedSnapshotUrl props~~ → 削除（HTTP GETベースに変更）
3. ~~useWebSocketのonSnapshotUpdate~~ → 削除
4. ~~go2rtc依存のスナップショット取得~~ → ffmpeg直接取得に変更

---

## 実装優先順位

1. **SnapshotService修正**: ffmpegでRTSP直接取得
2. **キャッシュ画像保存**: `/api/snapshots/{camera_id}/latest.jpg`エンドポイント
3. **IS21連携**: 差分画像送信、レスポンス処理
4. **EventLogService**: 検知イベントのDB保存 + WebSocket通知
5. **AI Event Log UI**: キルログ形式表示の実装
6. **画像保存ルール**: 検知時のみ保存、自動削除バッチ
7. **Settings Modal**: ポーリング/保存/表示設定
