# AI Event Log 設計ギャップ分析レポート

## 改訂履歴
| 日付 | バージョン | 変更内容 |
|------|----------|----------|
| 2026-01-02 | 1.0.0 | 初版作成 |
| 2026-01-02 | 1.1.0 | 最優先項目補完完了（画像保存、プリセット定義、Frontend詳細、テスト計画、チューニングガイド） |
| 2026-01-02 | 1.2.0 | frame_diffワークフロー補完（prev_image管理、loitering_detected、DBカラム追加） |

---

## 1. 分析対象ドキュメント

| ドキュメント | 最終更新 | 主な内容 |
|-------------|----------|----------|
| is22_AI_EVENT_LOG_DESIGN.md | 2026-01-02 | 全体設計・データフロー |
| is22_CAMERA_PRESET_DESIGN.md | 2026-01-02 | プリセット・テンプレート |
| is21_CAMERA_CONTEXT_EXTENSION.md | 2026-01-02 | camera_context拡張 |
| is21_FEATURE_EXTENSION_v2.md | 2026-01-02 | is21特徴抽出拡張 |

---

## 2. ギャップサマリー

| カテゴリ | 充足度 | 不足項目 | 補完状況 |
|---------|--------|----------|----------|
| バックエンド (is22) | **95%** | ~~BQ同期詳細、画像保存パス~~、リトライ戦略 | ✅ 補完済 |
| バックエンド (is21) | 65% | preset対応、output_schema実装詳細 | 実装時対応 |
| フロントエンド | **90%** | ~~全UIコンポーネント仕様、状態管理、エラー表示~~ | ✅ 補完済 |
| mobes2.0 LLM連携 | 10% | ほぼ未定義（スコープ外記載のみ） | 次ターン |
| バックエンドテスト | **95%** | ~~自動テスト、負荷テスト、異常系テスト~~ | ✅ TEST_PLAN.md作成 |
| UI操作テスト | **90%** | ~~未定義~~ | ✅ TEST_PLAN.md作成 |
| 長期放置テストKPI | **95%** | ~~未定義~~ | ✅ TEST_PLAN.md作成 |
| チューニング計画 | **95%** | ~~詳細手順・指標未定義~~ | ✅ TUNING_GUIDE.md作成 |

---

## 3. 詳細ギャップ分析

### 3.1 バックエンド設計 (is22 Rust)

#### 定義済み ✅
- AiClient構造体・メソッド定義
- DetectionLogService構造体・メソッド定義
- PollingOrchestrator統合フロー
- detection_logsテーブル定義
- WebSocket通知（基本）

#### 不足 ❌

**3.1.1 BQ同期詳細仕様**
```
必要な定義:
- BqSyncService モジュール構造
- bq_sync_queue → BigQuery 送信ロジック
- 認証方式（サービスアカウント）
- 失敗時のリトライ戦略（exponential backoff）
- 部分成功時の処理
- BQテーブル作成DDL
```

**3.1.2 画像保存パス戦略**
```
必要な定義:
- ローカル保存パス構造
  /var/lib/is22/snapshots/{camera_id}/{date}/{timestamp}.jpg
- 保持期間・ローテーション
- ディスク容量監視・アラート
- Google Drive連携フロー（将来）
```

**3.1.3 DetectionLogService詳細**
```
必要な定義:
- preset_id/preset_version取得元
- プリセット定義ファイル読み込み
- キャッシュ戦略
- DB接続プール設定
```

**3.1.4 エラーハンドリング詳細**
```
現状: 簡易な表のみ
必要な定義:
- リトライ回数・間隔の設定値
- 回復不能エラーの定義
- アラート通知条件
- ログ出力フォーマット
- メトリクス収集
```

---

### 3.2 バックエンド設計 (is21 Python)

#### 定義済み ✅
- /v1/analyze API仕様
- PA100K属性活用
- 人物特徴拡張
- カメラ障害検出
- frame_diff分析

#### 不足 ❌

**3.2.1 preset対応実装**
```
必要な定義:
- preset_id受け取り処理
- output_schema別レスポンス生成ロジック
- プリセット定義ファイル読み込み
- プリセットバージョン管理
```

**3.2.2 ナンバープレートOCR詳細**
```
現状: 概要のみ
必要な定義:
- PaddleOCR RKNN変換手順
- モデルファイル配置
- 推論パイプライン統合
- 精度評価基準
```

**3.2.3 パフォーマンス計測・制御**
```
必要な定義:
- 処理時間計測箇所
- 削減レベル自動切替条件
- NPU使用率監視
- メモリ使用量監視
```

---

### 3.3 フロントエンド設計

#### 定義済み ✅
- EventLogPane表示テンプレート
- CameraDetailModalプリセット選択
- PresetInfoPanelコンポーネント

#### 不足 ❌

**3.3.1 全UIコンポーネント仕様**
```
未定義コンポーネント:
- EventLogPane本体（詳細Props/State）
- EventLogItem（1行の詳細構造）
- EventLogFilter（フィルタコンポーネント）
- EventLogDetailModal（詳細表示モーダル）
- BboxOverlay（bbox表示オーバーレイ）
```

**3.3.2 状態管理設計**
```
必要な定義:
- EventLog用Zustand store
- WebSocket接続状態管理
- フィルタ状態永続化
- ページング/無限スクロール
- ローディング状態
```

**3.3.3 エラー表示・リカバリ**
```
必要な定義:
- is21接続エラー時の表示
- WebSocket切断時の表示
- 再接続フロー
- オフラインモード対応
```

**3.3.4 レスポンシブ対応**
```
必要な定義:
- モバイル表示時のレイアウト
- EventLogPaneの折りたたみ
- タッチ操作対応
```

---

### 3.4 mobes2.0 LLM連携（後続タスク）

#### 定義済み ✅
- スコープ外記載のみ

#### 不足 ❌（次ターン向け参考仕様）

**3.4.1 AIチャットパネル設計**
```
必要な定義:
- チャットUI仕様
- 入力フォーマット
- レスポンス表示形式
- ストリーミング対応
```

**3.4.2 detection_logs → LLMクエリ変換**
```
必要な定義:
- BQクエリ生成ロジック
- preset_idによるコンテキスト付与
- 画像参照方法（URL生成）
- プロンプトテンプレート
```

**3.4.3 サマリー生成**
```
必要な定義:
- サマリー種別（hourly/daily/emergency）
- トリガー条件
- キャッシュ戦略
- LLM API呼び出し仕様
```

**3.4.4 AIチャット履歴**
```
定義済み: ai_chat_historyテーブル
不足:
- session_id生成ロジック
- 履歴表示UI
- 履歴検索機能
```

---

### 3.5 バックエンドテスト計画

#### 定義済み ✅
- 基本テストケース（T-001〜T-204）
- PDCAサイクル概要

#### 不足 ❌

**3.5.1 自動テスト仕様**
```
必要な定義:
- ユニットテスト対象関数一覧
- モック戦略（is21、DB、BQ）
- テストデータセット
- CI/CD統合
```

**3.5.2 統合テスト仕様**
```
必要な定義:
- is21→is22 E2Eテストシナリオ
- テスト環境構成
- テストデータ投入手順
- 結果検証方法
```

**3.5.3 負荷テスト仕様**
```
必要な定義:
- 同時カメラ数別シナリオ（10/20/30台）
- 測定メトリクス
- 合格基準
- ボトルネック特定手順
```

**3.5.4 異常系テスト仕様**
```
必要な定義:
- is21ダウン時
- DB接続失敗時
- ディスクフル時
- メモリ枯渇時
- ネットワーク断時
```

---

### 3.6 UI操作テスト計画

#### 定義済み ✅
- なし

#### 不足 ❌

**3.6.1 CameraDetailModal操作テスト**
```
必要なテストケース:
- プリセット選択→説明表示
- プリセット変更→保存
- camera_context編集→保存
- バリデーションエラー表示
- キャンセル→変更破棄
```

**3.6.2 EventLogPane操作テスト**
```
必要なテストケース:
- ログ一覧表示
- フィルタ適用→絞り込み
- ログクリック→カメラ選択
- 詳細展開→bbox表示
- スクロール→追加読み込み
- リアルタイム更新（WebSocket）
```

**3.6.3 CameraGrid連携テスト**
```
必要なテストケース:
- EventLogクリック→該当カメラハイライト
- スナップショット表示
- bbox overlay表示
```

---

### 3.7 長期放置テストKPI

#### 定義済み ✅
- なし

#### 不足 ❌

**3.7.1 運用KPI定義**
```
必要な指標:
| KPI | 測定方法 | 目標値 |
|-----|---------|--------|
| is21応答時間 | processing_ms.total | P95 < 500ms |
| is21可用性 | 成功率 | 99.9% |
| DB書き込み成功率 | INSERT成功/試行 | 99.99% |
| BQ同期遅延 | captured_at - synced_at | < 5分 |
| WebSocket配信遅延 | analyzed_at - UI表示 | < 1秒 |
| メモリ使用量 | RSS | < 2GB |
| ディスク使用量 | /var/lib/is22 | < 80% |
| CPU使用率 | is22プロセス | < 70% |
```

**3.7.2 長期放置テストシナリオ**
```
シナリオ:
- 期間: 72時間連続稼働
- カメラ数: 20台
- ポーリング間隔: 5秒
- 想定ログ数: 約100万件

測定項目:
- メモリリーク有無
- ディスク使用量推移
- レスポンス時間劣化
- エラー発生頻度
- BQ同期遅延推移
```

**3.7.3 アラート閾値**
```
| 項目 | 警告 | 緊急 |
|------|------|------|
| is21応答時間 | P95 > 800ms | P95 > 2000ms |
| DB書き込み失敗 | 10回/時 | 100回/時 |
| BQ同期遅延 | > 10分 | > 30分 |
| メモリ使用量 | > 1.5GB | > 1.8GB |
| ディスク使用量 | > 70% | > 85% |
```

---

### 3.8 チューニング計画

#### 定義済み ✅
- PDCA概要
- パフォーマンス削減レベル

#### 不足 ❌

**3.8.1 プリセットチューニング手順**
```
必要な定義:
1. 現状分析
   - preset別検知精度（TP/FP/FN）
   - suspicious.score分布
   - 処理時間分布

2. 課題特定
   - 誤検知多発プリセット/カメラ
   - 見逃し多発プリセット/カメラ
   - 処理時間超過パターン

3. 調整実施
   - conf_threshold調整
   - suspicious_config調整
   - 検出対象調整

4. 効果検証
   - A/Bテスト実施
   - 精度メトリクス比較
   - ユーザーフィードバック

5. 本番反映
   - プリセットバージョン更新
   - is22/is21への配布
   - ロールバック手順
```

**3.8.2 精度評価メトリクス**
```
| メトリクス | 定義 | 目標値 |
|-----------|------|--------|
| 人物検出Precision | TP / (TP + FP) | > 0.95 |
| 人物検出Recall | TP / (TP + FN) | > 0.90 |
| 車両検出Precision | TP / (TP + FP) | > 0.90 |
| 車両検出Recall | TP / (TP + FN) | > 0.85 |
| ナンバー読取率 | 読取成功 / 車両検出 | > 0.80 |
| suspicious適中率 | 実際の不審 / high以上 | > 0.70 |
| 衛生違反検出率 | TP / (TP + FN) | > 0.85 |
```

**3.8.3 チューニング履歴管理**
```
必要な定義:
- 変更内容の記録フォーマット
- 変更理由・根拠
- 効果測定結果
- ロールバック基準
```

---

## 4. 優先度付け不足項目リスト

### 最優先（実装開始前に必須）

| No | 項目 | 影響範囲 |
|----|------|----------|
| 1 | 画像保存パス戦略 | is22 PollingOrchestrator |
| 2 | プリセット定義ファイル配置・読み込み | is22/is21 共通 |
| 3 | EventLogPane詳細Props/State | Frontend |
| 4 | WebSocket接続状態管理 | Frontend |

### 高優先（実装中に並行定義）

| No | 項目 | 影響範囲 |
|----|------|----------|
| 5 | BQ同期詳細仕様 | is22 BqSyncService |
| 6 | preset対応実装（is21） | is21 main.py |
| 7 | 自動テスト仕様 | テストコード |
| 8 | 統合テストシナリオ | テスト実行 |

### 中優先（実装完了後）

| No | 項目 | 影響範囲 |
|----|------|----------|
| 9 | 長期放置テストKPI | 運用監視 |
| 10 | チューニング手順詳細 | 運用改善 |
| 11 | 負荷テスト仕様 | 性能検証 |
| 12 | UI操作テスト計画 | 品質保証 |

### 低優先（後続ターン）

| No | 項目 | 影響範囲 |
|----|------|----------|
| 13 | mobes2.0 LLM連携詳細 | 次ターン |
| 14 | ナンバープレートOCR詳細 | is21拡張 |
| 15 | モバイルレスポンシブ対応 | Frontend |

---

## 5. 推奨アクション

### 5.1 今回ターンで追加定義すべき項目

1. **is22_AI_EVENT_LOG_DESIGN.md 追記**
   - §12 画像保存戦略
   - §13 BQ同期詳細仕様
   - §14 フロントエンド詳細設計

2. **is22_CAMERA_PRESET_DESIGN.md 追記**
   - §12 プリセット定義ファイル仕様（JSONサンプル完成版）

3. **新規: is22_AI_EVENT_LOG_TEST_PLAN.md**
   - バックエンドテスト詳細
   - UI操作テスト計画
   - 長期放置テストKPI

4. **新規: is22_AI_EVENT_LOG_TUNING_GUIDE.md**
   - チューニング手順詳細
   - 精度評価メトリクス
   - 履歴管理方法

### 5.2 後続ターンで定義すべき項目

1. **mobes2.0 LLM連携設計書**
2. **ナンバープレートOCR実装設計書**
3. **負荷テスト・性能チューニング設計書**

---

## 6. 結論

### 補完完了後の状態（2026-01-02 v1.2.0）

最優先項目およびframe_diffワークフローの補完により、設計ドキュメントは**実装開始可能なレベル**に到達。

#### 補完された項目
1. ✅ **画像保存戦略** - is22_AI_EVENT_LOG_DESIGN.md §11
2. ✅ **BQ同期詳細仕様** - is22_AI_EVENT_LOG_DESIGN.md §12
3. ✅ **フロントエンド詳細設計** - is22_AI_EVENT_LOG_DESIGN.md §13
4. ✅ **プリセット定義ファイル** - is22/config/presets/camera_presets_v1.0.0.json
5. ✅ **テスト計画** - is22_AI_EVENT_LOG_TEST_PLAN.md
6. ✅ **チューニングガイド** - is22_AI_EVENT_LOG_TUNING_GUIDE.md
7. ✅ **frame_diffワークフロー** - prev_image管理、PrevFrameCache、loitering_detected
   - is22_AI_EVENT_LOG_DESIGN.md §5.2 PollingOrchestrator統合
   - migrations/008_detection_logs.sql frame_diff/loitering_detectedカラム追加
   - テストケース T-007〜T-010, T-105〜T-106 追加

#### 残課題（実装時に対応）
- is21 preset対応実装詳細 → is21実装時に決定
- mobes2.0 LLM連携 → 次ターンスコープ

#### 実装開始条件
- [x] バックエンド設計 95%以上
- [x] フロントエンド設計 90%以上
- [x] テスト計画完備
- [x] チューニング手順定義

**→ 実装開始可能**
