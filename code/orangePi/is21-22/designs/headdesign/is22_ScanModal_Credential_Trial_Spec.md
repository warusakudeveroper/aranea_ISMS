# IS22 ScanModal クレデンシャル試行機能仕様書

**作成日**: 2026-01-01
**ステータス**: 承認済み
**対象**: ScanModal.tsx サブネット設定・クレデンシャル試行・カテゴリ分類

---

## 1. 概要

スキャン時にサブネット単位で設定されたクレデンシャルを試行し、カメラのモデル名等の完全情報を取得してから登録可能とする機能。

---

## 2. サブネット設定

### 2.1 設定項目

| 項目 | 必須 | スキャン使用 | 説明 |
|------|------|-------------|------|
| CIDR | ○ | ○ | サブネット (例: 192.168.125.0/24) |
| fid | ○ | × | 施設ID (例: "0150") ※スキャン上不要だが保存 |
| facility_name | ○ | × | 施設名 (例: "HALE京都丹波口") ※スキャン上不要だが保存 |
| trial_credentials | △ | ○ | 試行クレデンシャル (最大10件) |

### 2.2 施設名サジェスト

- fid入力時、同一fidの既存サブネットの施設名をサジェスト表示
- 理由: 同一施設がVLANで複数サブネットに分割されている可能性
- サジェストのみで強制はしない

### 2.3 試行クレデンシャル

```typescript
interface TrialCredential {
  username: string;
  password: string;
  priority: number;  // 試行順序 (1-10)
}
```

- 各サブネットに**最大10件**まで設定可能
- **上位から順に試行**し、成功したら次のクレデンシャルは試行しない
- デバイス個別クレデンシャルとは**別の問題**として管理

---

## 3. クレデンシャル試行ロジック

### 3.1 試行フロー

```
スキャン開始
  ↓
カメラ可能性のある端末を検出
  ↓
サブネットごとに試行クレデンシャルを取得
  ↓
各端末に対して:
  ├── クレデンシャル1で認証試行
  │     ├── 成功 → モデル名取得 → カテゴリb「登録可能」
  │     └── 失敗 → 次のクレデンシャルへ
  ├── クレデンシャル2で認証試行
  │     ├── 成功 → モデル名取得 → カテゴリb「登録可能」
  │     └── 失敗 → 次のクレデンシャルへ
  └── ...
  ↓
全クレデンシャル失敗 → カテゴリc「認証情報確認必要」
```

### 3.2 ONVIF応答の活用

- クレデンシャルが不一致でもONVIFはタイムスタンプ等を返す
- これによりカメラであることは確認できる
- 認証成功時のみモデル名・詳細情報が取得可能

---

## 4. カテゴリ分類

### 4.1 分類定義

| カテゴリ | 名称 | 条件 | 系統 |
|----------|------|------|------|
| **a** | 登録済みカメラ | camerasテーブルに存在 | Tapo |
| **b** | 登録可能カメラ | クレデンシャル成功、モデル名取得済み | Tapo |
| **c** | 認証情報確認必要 | カメラだが全クレデンシャル不一致 | Tapo |
| **d** | 汎用RTSP/別カメラ | 認証方式・URL構築方式が異なる | 非Tapo |
| **e** | 非カメラ | ポート開放だがカメラではない | - |

### 4.2 Tapo系境界

- カテゴリ a, b, c: **Tapo系**（認証方式が同一）
- カテゴリ d, e: **非Tapo系**（別方式または非カメラ）

### 4.3 判定ロジック

```
デバイス検出
  ├── camerasテーブルに存在? → [a] 登録済みカメラ
  └── 存在しない
        ├── ONVIF応答あり?
        │     ├── クレデンシャル認証成功? → [b] 登録可能カメラ
        │     └── 全クレデンシャル失敗 → [c] 認証情報確認必要
        ├── RTSP応答あり（非Tapo）? → [d] 汎用RTSP/別カメラ
        └── カメラ応答なし → [e] 非カメラ
```

---

## 5. UI仕様

### 5.1 モーダルサイズ

```css
height: 90vh;
width: 60vw;
min-width: 800px;
max-width: 1400px;
```

### 5.2 背景色（不透明）

| カテゴリ | 背景色 | 表示状態 |
|----------|--------|----------|
| a | 薄緑 (bg-green-100) | 展開表示 |
| b | 薄青 (bg-blue-200) + 枠線 | **強調展開表示** |
| c | 薄黄 (bg-yellow-100) | 展開表示 |
| d | 薄灰 (bg-gray-100) | **折りたたみ** |
| e | 薄灰 (bg-gray-100) | **折りたたみ** |

### 5.3 カテゴリb強調表示

カテゴリbは以下の情報が**完全に取得済み**のため強調:
- モデル名
- MACアドレス
- ファームウェアバージョン
- ONVIF詳細情報

### 5.4 折りたたみセクション

- カテゴリd, eは「登録できないデバイス」として折りたたみ
- クリックで展開/折りたたみ切り替え

### 5.5 ソート順

1. **カテゴリ順**: a → b → c → d → e
2. **サブネット順**: CIDR昇順
3. **IP順**: IP昇順

### 5.6 1行情報量

カテゴリbのデバイスカードには以下を表示:
- IPアドレス
- MACアドレス
- OUIベンダー
- **モデル名** (強調)
- サブネット
- ステータス

---

## 6. サブネット設定UI

### 6.1 設定フォーム

```
┌─────────────────────────────────────────────────────┐
│ サブネット設定                                       │
├─────────────────────────────────────────────────────┤
│ CIDR: [192.168.125.0/24        ]                    │
│ fid:  [0150    ] 施設名: [HALE京都丹波口   ] ← サジェスト │
├─────────────────────────────────────────────────────┤
│ 試行クレデンシャル (最大10件)                        │
│ ┌───────────────────────────────────────────────┐  │
│ │ 1. [halecam       ] / [********]  [削除]     │  │
│ │ 2. [admin         ] / [********]  [削除]     │  │
│ │ [+ クレデンシャル追加]                        │  │
│ └───────────────────────────────────────────────┘  │
│                                        [保存]      │
└─────────────────────────────────────────────────────┘
```

### 6.2 クレデンシャル優先順

- リスト上位から順に試行
- ドラッグ&ドロップで順序変更可能（実装オプション）

---

## 7. API設計

### 7.1 サブネット設定保存

```
POST /api/subnets/{subnet_id}/credentials
Body: {
  "credentials": [
    { "username": "halecam", "password": "hale0083", "priority": 1 },
    { "username": "admin", "password": "admin123", "priority": 2 }
  ]
}
```

### 7.2 スキャン実行

```
POST /api/ipcamscan/jobs
Body: {
  "targets": ["192.168.125.0/24", "192.168.126.0/24"],
  "try_credentials": true  // クレデンシャル試行を有効化
}
```

### 7.3 スキャン結果

```json
{
  "devices": [
    {
      "ip": "192.168.125.45",
      "mac": "9C:53:22:0A:E7:6C",
      "model": "Tapo C200",           // クレデンシャル成功時のみ
      "firmware": "1.3.11",           // クレデンシャル成功時のみ
      "credential_status": "success", // success/failed/not_tried
      "category": "b"
    }
  ]
}
```

---

## 8. 実装タスク

### Phase 1: バックエンド
- [ ] サブネットテーブルにcredentials列追加
- [ ] クレデンシャル試行ロジック実装
- [ ] スキャン結果にcredential_status追加

### Phase 2: フロントエンド
- [ ] サブネット設定UIにクレデンシャル管理追加
- [ ] fid入力時の施設名サジェスト
- [ ] カテゴリ分類ロジック修正
- [ ] モーダルサイズ・背景色・強調表示

### Phase 3: 統合テスト
- [ ] クレデンシャル試行動作確認
- [ ] カテゴリ分類確認
- [ ] UI表示確認

---

## 9. デバイス個別クレデンシャルとの関係

| 種別 | 用途 | 保存場所 | 最大件数 |
|------|------|----------|----------|
| サブネット試行クレデンシャル | スキャン時試行 | subnets.credentials | 10件/サブネット |
| デバイス個別クレデンシャル | 登録後の接続用 | cameras.credentials | 1件/デバイス |

**これらは別の問題として扱う。**

---

## 10. 参照仕様

- is22_Camserver実装指示.md
- is22_ScanModal_Enhancement_Spec.md
- is22_GAP_ANALYSIS_20260101.md
