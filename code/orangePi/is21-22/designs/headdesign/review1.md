# ffmpegプロセスリーク障害 調査レビュー

**作成日**: 2026-01-05 08:00 JST
**関連Issue**: [#73](https://github.com/warusakudeveroper/aranea_ISMS/issues/73)
**詳細レポート**: [INCIDENT_REPORT_20260105_ffmpeg_leak.md](../../../docs/is22/INCIDENT_REPORT_20260105_ffmpeg_leak.md)

---

## 1. タイムゾーン問題の発見

### 1.1 環境確認結果

| 環境 | タイムゾーン | 現在時刻 |
|------|-------------|----------|
| is22サーバー | **UTC** | 2026-01-04 22:49:46 |
| クライアント | **JST** | 2026-01-05 07:49:45 |

**差分**: 9時間

### 1.2 影響

- ログ解析時に時刻の誤認識が発生
- 初回レポートで「22:00頃」と記載したが、実際はJST 07:50頃の観測
- サーバーログのタイムスタンプはすべてUTC

### 1.3 推奨対応

1. **is22サーバーのタイムゾーン変更検討**: UTCのままとするか、JSTに統一するか
2. **ログ出力時のタイムゾーン明示**: `2026-01-05T07:50:00+09:00` 形式

---

## 2. プロセスリーク進行状況

### 2.1 時系列データ

| 解析時刻 (JST) | ゾンビffmpeg数 | 125.19への接続数 | 増加率 |
|----------------|----------------|------------------|--------|
| 07:24 | 25 | 22 | - |
| 07:51 | 37 | 32 | +12 (+48%) |

**増加ペース**: 約27分で12プロセス増加（約2.2分/プロセス）

### 2.2 最古プロセスの生存時間

```
PID 1504968
起動: Jan 5 03:10:04 JST
解析時: Jan 5 07:51 JST
生存時間: 6時間40分以上（継続中）
```

---

## 3. 連動性確認

### 3.1 is22起動〜障害発生の相関

```
01:23 JST - is22起動
        ↓ (約2時間)
03:10 JST - 最初のゾンビ発生（192.168.125.12）
        ↓ (約3時間、この間もゾンビ発生の可能性）
06:07 JST - 192.168.125.19への大量蓄積開始
        ↓ (継続)
07:51 JST - 37プロセス蓄積確認
```

### 3.2 推定される障害トリガー

1. **カメラ応答遅延/無応答**: 特に192.168.125.19 (Tapo C110)
2. **RTSP接続タイムアウト**: 30秒で発動するが、ffmpegプロセスは生存
3. **ポーリング間隔**: 約2分間隔でリトライ → ゾンビ蓄積

---

## 4. 設計レビュー指摘事項

### 4.1 欠落機能

| 機能 | 設計意図 | 現状 |
|------|----------|------|
| サブネット巡回終了時クリーンアップ | RTSP接続を切断 | **未実装** |
| ffmpegプロセス管理 | タイムアウト時kill | **未実装** |
| go2rtc常時利用 | RTSP競合回避 | **視聴者がいる時のみ** |
| コンストラクト-ディストラクト | クリーンな巡回 | **未実装** |

### 4.2 RtspManagerの限界

```rust
// 現在の実装: 論理的ロックのみ
pub struct RtspLease {
    camera_id: String,
    _guard: tokio::sync::OwnedMutexGuard<()>,  // mutexのみ
}

impl Drop for RtspLease {
    fn drop(&mut self) {
        // ffmpegプロセスは終了しない
        tracing::debug!(...);
    }
}
```

---

## 5. 次のステップ

### 5.1 即時対応（コード修正必要）

- [ ] `capture_rtsp()`にタイムアウト＋kill処理追加
- [ ] ゾンビプロセス定期クリーンアップ実装

### 5.2 中期対応

- [ ] サブネット巡回終了時のストリーム解除
- [ ] go2rtc常時利用化（ffmpeg排除）

### 5.3 運用対応

- [ ] is22サーバーのタイムゾーン設定検討
- [ ] ffmpegプロセス数監視アラート設定

---

**レビュー担当**: Claude Code
**ステータス**: 調査完了、修正実装待ち
