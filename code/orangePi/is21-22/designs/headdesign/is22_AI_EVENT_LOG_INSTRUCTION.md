# IS22 AI Event Log 実装指示書

## 指示日時
2026-01-02

## 概要
IS22 CamServerのAI Event Log機能の本格実装指示

---

## 1. AI Event Logの役割

AI Event Logは巡回して得られた情報をis21に送信して検知結果を得るための仕組みである。

## 2. UIレイアウト仕様

AI Event Logのペインは**上下を50%/50%で分割**する：

### 上半分: is21レスポンスログ
- is21からのレスポンスログを表示
- **何もない系（検知なし）は非表示**
- 検知ログのみを表示

### 下半分: AIチャット＆サマリーパネル
- 時間ベースでmobes2.0系エンドポイントにデータを渡しサマリーを取得
- チャットパネルからの質問応答機能

## 3. データ保存仕様

### 保存対象
- is22は**検知系のログのみ**をDBに保管する

### 必須カラム（BQ/ローカル共通）
| カラム名 | 説明 |
|---------|------|
| tid | テナントID |
| fid | 施設ID |
| timestamp | タイムスタンプ |
| is21_log | is21からのログ |
| camera_id | カメラID |
| lacis_id | カメラのlacisID |
| camera_response | カメラからのレスポンス |
| image_path_local | ローカルファイルパス |
| image_path_cloud | クラウドパス（将来GoogleDrive API対応） |

**重要**: BQのカラムとローカルのデータカラムは**完全に一致**させる必要がある

## 4. is21連携仕様

### 送信パラメータ
検知精度を高めるために以下をis21に送信：
- カメラコンテキスト（施設情報、カメラ情報）
- 一つ前の画像（比較参照用）

### 注意点
- is21はLLMではないため、**構造化された内容**で送信する必要がある
- カメラ詳細のカメラコンテキスト部分で適切にパラメータを渡す

## 5. mobes2.0連携仕様

### サマリー取得
- 時間ベースでmobes2.0系エンドポイントに送信
- 送信内容：カメラコンテキスト、検知情報、施設情報
- サマリー例：「XXXXホテルでは21:30に駐車場に車両が停車、21:45身長高い男性2人がフロントでチェックイン、キャリーケース持ち」

### 実行タイミング
- 設定された時間間隔で実行
- is21から緊急性ありの判定がある場合は即時実行

### BQ同期
- is21のログはオンライン側BQに同期される仕様が必要

## 6. チャット機能仕様

### クエリ例
「白い服きた女性の方、最近こなかった？」

### 応答例
「日時ベースで直近だといついつですね」と回答し、該当する写真のファイル名を提示

### クエリ対象
- BigQueryに問い合わせ
- 日時ベースでの検索

---

## 設計タスク

### 1. is21連携確認
- `code/orangePi/is21`のコード確認
- 実画像を投入してのチェック

### 2. mobes連携（仮実装）
- is22側で手動で仮実装
- その後調整

### 3. スキーマ調整
- is21とのスキーマ調整

### 4. 設計ドキュメント作成
- 関連の依存関係を把握
- **MECE**かつ**Unambiguous**であること
- 詳細レビューを実施

### 5. 既存指示の完全取り込み
- `code/orangePi/is21-22/designs/headdesign/is22_Camserver実装指示.md`の指示内容・手法を完全に取り込み実施

### 6. テスト計画必須項目
- is21との連携動作確認
- is21との相互調整による回答精度チューニングのPDCA
- UIからの確認

---

## 次タスク（本ターン対象外）
- mobes2.0系連携
- go2rtx系の動画再生（モーダル再生、サジェスト再生）

※現ターンでは動画を用いない。巡回取得は成立しているため。
