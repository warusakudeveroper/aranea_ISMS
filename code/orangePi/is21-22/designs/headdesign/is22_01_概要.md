# is22 概要・責務定義

文書番号: is22_01
作成日: 2025-12-29
ステータス: Draft

---

## 1. デバイス情報

| 項目 | 値 |
|-----|-----|
| デバイスID | ar-is22n |
| 名称 | camServer |
| 機材 | GMKtec NucBox G5（N100系） |
| OS | Ubuntu Server 24.04.3 LTS |
| メモリ | 16GB |
| ストレージ | 512GB NVMe |
| ネットワーク | VPN常時接続（192.168.125.0/24） |

---

## 2. 役割定義

### 2.1 責務（MUST）
- RTSPカメラからのスナップショット収集
- 差分判定による推論スキップ（早期リターン）
- is21への推論リクエスト送信
- 推論結果のMariaDB保存
- イベント化（連続検知の束ね）
- Google Driveへのフル画像保存
- Web UI提供（shadcn/ui）
- 通知（Webhook/日次要約）
- is21へのスキーマ配布
- RTSP→HLS/WebRTC変換（ストリーミング）

### 2.2 責務外（MUST NOT）
- 画像推論の実行（is21に委譲）
- 自然言語テキストの生成（テンプレートのみ）

---

## 3. 設計原則

### 3.1 SSoT（Single Source of Truth）
- スキーマ定義: schema_versionsテーブルが唯一の情報源
- カメラ設定: camerasテーブルが唯一の情報源
- イベントDB: eventsテーブルが検索の主役

### 3.2 4サービス分割
| サービス | 責務 |
|---------|------|
| collector | RTSP収集・差分判定・frames INSERT |
| dispatcher | 推論呼出・イベント化・Drive保存・通知 |
| web | UI/API・MediaProxy |
| streamer | RTSP→HLS変換 |

### 3.3 疎結合設計
- サービス間はDBキュー（inference_jobs）で連携
- 各サービスは独立してスケール可能
- サービス障害時も他サービスは継続

---

## 4. インターフェース概要

### 4.1 入力
| 項目 | 発信元 | 受信サービス |
|-----|-------|-------------|
| RTSPストリーム | カメラ×30 | collector |
| 推論結果 | is21 | dispatcher |
| UIリクエスト | ブラウザ | web |
| ストリーム要求 | ブラウザ | streamer |

### 4.2 出力
| 項目 | 送信先 | 発信サービス |
|-----|-------|-------------|
| 推論リクエスト | is21 | dispatcher |
| フル画像 | Google Drive | dispatcher |
| 通知 | Webhook | dispatcher |
| HTML/API | ブラウザ | web |
| HLSストリーム | ブラウザ | streamer |

---

## 5. ネットワーク

### 5.1 サブネット
- 192.168.125.0/24（is22設置拠点）
- 192.168.3.0/24（VPN経由・東京）

### 5.2 ポート
| ポート | 用途 | サービス |
|-------|------|---------|
| 80/tcp | HTTP（Apache） | web |
| 443/tcp | HTTPS（Apache） | web |
| 8080/tcp | Rustバックエンド | web |
| 8081/tcp | 管理UI | web |
| 8082/tcp | ストリーミング | streamer |
| 3306/tcp | MariaDB | 内部 |
| 22/tcp | SSH | 管理 |

### 5.3 外部通信
| 送信先 | ポート | 用途 |
|-------|-------|------|
| is21:9000 | HTTP | 推論API |
| drive.google.com | HTTPS | 画像保存 |
| Webhook先 | HTTPS | 通知 |

---

## 6. データフロー

```
[RTSPカメラ×30]
       ↓ (1) RTSPスナップ取得
[collector]
       ↓ (2) 差分判定
       ↓      ├─ 小 → frames(no_event)で終了
       ↓      └─ 大 → inference_jobs enqueue
       ↓
[dispatcher]
       ↓ (3) is21へ推論リクエスト
[is21]
       ↓ (4) 推論結果
[dispatcher]
       ↓ (5) frames UPDATE
       ↓ (6) events open/merge/close
       ↓ (7) Drive保存（条件付き）
       ↓ (8) 通知（条件付き）
       ↓
[web]
       ↓ (9) UI提供
[ブラウザ]
```

---

## 7. 既存環境

### 7.1 インストール済みサービス（is22_setuplog.md参照）
| サービス | ポート | 用途 |
|---------|-------|------|
| Apache2 | 80, 443 | リバプロ・静的配信 |
| MariaDB | 3306 | データベース |
| Samba | 139, 445 | ファイル共有 |
| Mosquitto | 1883 | MQTT（オプション） |

### 7.2 開発環境
| 環境 | バージョン |
|-----|-----------|
| Node.js | v18.19.1 |
| npm | 9.2.0 |
| Yarn | 1.22.22 |
| Python3 | 3.12.3 |
| Rust | 1.92.0 |
| PHP | 8.3.6 |

### 7.3 アカウント
- システムユーザー: `mijeosadmin` / `mijeos12345@`
- MariaDB root: `root` / `mijeos12345@`
- MariaDB user: `mijeosadmin` / `mijeos12345@`

---

## 8. テスト観点

### 8.1 機能テスト
- [ ] 30台カメラからの同時収集
- [ ] 差分判定でno_event正常記録
- [ ] is21推論結果のDB保存
- [ ] イベント化（open→merge→close）
- [ ] Drive保存・リンク参照
- [ ] 通知送信・クールダウン

### 8.2 性能テスト
- [ ] 30台を1分周期で処理可能
- [ ] VPNカメラの遅延許容
- [ ] DB検索応答 < 1秒

### 8.3 障害テスト
- [ ] is21停止時のフォールバック
- [ ] カメラ個別失敗の隔離
- [ ] DBコネクション枯渇対策

---

## 9. 次工程への引継ぎ

### 詳細設計で決定すべき事項
1. Apacheリバプロ設定の詳細
2. Rustクレート構成の最終化
3. Drive認証トークン管理方法
4. 通知テンプレートの詳細
