
# IS22の実装について。
is22実装指示.md(このファイル)

## 必須参照
`code/orangePi/is21-22/designs/headdesign/is22_Camserver仕様案(基本設計書草案改訂版).md`
`code/orangePi/is21-22/designs/headdesign/is22_Camserver実装指示.md`
  
## aranea_IS21(op5-plus)
**192.168.3.240にIP変更されました。**
```
  | IP              | 192.168.3.240                  |

  | Hostname        | araneais21camimageEdgeAI（※1） |

  | Pretty Hostname | aranea_is21camimageEdgeAI      |

  | Username        | mijeosadmin                    |

  | Password        | mijeos12345@                   |

  | root Password   | mijeos12345@                   |

  | SSH             | 自動起動有効（enabled）        |

  | systemd         | running                        |

  | OS              | Armbian 25.11.2 noble          |

  | Kernel          | Linux 6.1.115-vendor-rk35xx    |
```

## aranea_is22 Camserver
```
IP:192.168.125.246

YourserverName mijeosserverhaletam

username mijeosadmin

pass mijeos12345@


設定済み情報

### ✅ **インストール済みサービス**

  

| サービス | 状態 | ポート | 自動起動 |

|---------|------|--------|----------|

| **Apache2** | ✅ 稼働中 | 80, 443 | 有効 |

| **MariaDB** | ✅ 稼働中 | 3306 | 有効 |

| **Samba** | ✅ 稼働中 | 139, 445 | 有効 |

| **Mosquitto** | ✅ 稼働中 | 1883 | 有効 |

| **SSH** | ✅ 稼働中 | 22 | 有効 |

  

### ✅ **開発環境**

  

| 環境 | バージョン | 備考 |

|------|-----------|------|

| **Node.js** | v18.19.1 | ✅ インストール済み |

| **npm** | 9.2.0 | ✅ インストール済み |

| **Yarn** | 1.22.22 | ✅ グローバルインストール済み |

| **Python3** | 3.12.3 | ✅ pip, venv対応 |

| **Rust** | 1.92.0 | ✅ ~/.cargo/bin に配置 |

| **PHP** | 8.3.6 | ✅ Apache統合済み |

  

### 🔒 **ファイアウォール設定**

  

開放されているポート：

- **22/tcp** - SSH

- **80/tcp** - HTTP (Apache)

- **443/tcp** - HTTPS (Apache)

- **3306/tcp** - MariaDB

- **139/tcp, 445/tcp** - Samba

- **3000-9999/tcp** - 開発用サーバー

  

### 👤 **アカウント情報**

  

- **システムユーザー**: `mijeosadmin` / `mijeos12345@`

- **MariaDB**:

  - rootユーザー: `root` / `mijeos12345@`

  - 一般ユーザー: `mijeosadmin` / `mijeos12345@` (全権限付与済み)

- **Sambaユーザー**: `mijeosadmin` / `mijeos12345@`

  

### 🚀 **次のステップ**

  

1. **Apache仮想ホスト設定**: `/etc/apache2/sites-available/`

2. **Samba共有設定**: `/etc/samba/smb.conf` を編集して共有ディレクトリを追加

3. **Rust環境変数**: `.bashrc`に`source $HOME/.cargo/env`を追加
```

## テストに使って良いカメラ
```
192.168.96.85 カメラアカウント ismscam pass:isms12345@
192.168.125.0/24の全カメラ　 halecam hale0083
192.168.126.0/24の全カメラ　 halecam hale0083
192.168.126.0/24にはvigiのカメラ、googlenestdoorbellもある
192.168.125.0/24にgooglenestdoorbellもある
ArpScan機能が必要な場合は配備済みのis20sが192.168.126.0/24、192.168.125.0/24
にある。
```
### 関連する情報
```
市山水産株式会社　tid T2025120608261484221 fid9000(市山水産(牛深))=192.168.96.0/23
テナントプライマリ:info+ichiyama@neki.tech
テナントプライマリlacisID:12767487939173857894
テナントプライマリCIC:263238

mijeo.inc tid T2025120621041161827 
テナントプライマリ:soejim@mijeos.com
テナントプライマリlacisID:18217487937895888001
テナントプライマリCIC:204965
fid:0150 HALE京都丹波口ホテル=192.168.125.0/24
fid:0151 HALE京都東寺ホテル=192.168.126.0/24

このデバイス(サーバー、AIサーバー)の登録を行うアカウント
mijeo.inc tid T2025120621041161827 
テナントプライマリ:soejim@mijeos.com
テナントプライマリlacisID:18217487937895888001
テナントプライマリCIC:204965

```
# 指示内容
### 概要
ここまでis21の実装を進めて参りました。code/orangePi/is21-22/designs/headdesignの内容に沿って実装を進め多くの修正、多くの調整及び計画通りでは達成できなかったことの修正などを実施、その結果is21は当初要件通りの機能を果たすデバイスとして完全動作するに至りました。ここからはこれらを踏まえis22の実装に入る必要があります。
is22の実装ではis22とis21との連携、araneadevicesの共通仕様、aranearegister系の認証登録なども含め多くの依存関係が存在します。
このサーバー自身がエッジデバイス的なIoT機器の側面を持っております。
その部分については現在はis20sが先行してますがこちらもまだ未完成です。
araneaSDKとの連携、ナレッジ登録を行いながらの連携が必要であり、スキーマ登録など(これはis20もis21もまだしてない)などの関連実装も必要です。
それらの現在の情報などについてはSDKからMetatronへの問い合わせ、SDKのコマンドで対応して下さい。

### コンセプトと注意事項
- このis22は**ページタイトル：mobes AIcam control Tower (mAcT)** とある通り飲食店、宿泊施設のオペレーションルームやVPN接続された本社などでの運用を想定しております。
- このis22はtplinkのTapoシリーズなどの安価なIpcamを用いた総合監視システムを提供します。
- このシステムは監視や防犯よりも画像を解析するis21との連携で一覧性を重視してスタッフの目線に近いところになんとなく映しておく
- "あ、お客さんきた。駐車場に車きたな"
- ”お客さん同士でなんかトラブってるみたい”
- "無人遠隔施設だけど無事チェクインして入れたな"くらいの緩い情報粒度とイベント記録
- それをmobesシステムの多段検証aiチャットぼっとで"昨日のお客さん何時にチェックインしてた？"、"赤い服きたあの人、いつココに来た人だっけ？"、”めちゃくちゃドアに傷ついているんだけど子供がなんかしてなかった？”とaiベースで回答するという仕様があります。
- 開発経緯としては特定の情報を確認するために30台のカメラの3週間分を人力チェックしたというものがあり、そういった用途を想定
- 取得したインデックスはmobesのbqに保存、llm処理はmobesのバックエンドの責務
- mobes側の実装箇所は"Mythtic"これは本来繋がらない色々な他社製のIoTを連携動作させる仕組みでMythtic内の機能としてカメラインデックスの解析aiを実装します(これはmobes2.0実装サイドの責務、araneadevice開発サイドとしては連携のみ)
- そのため外部ディスク接続での録画保存、イベントインデックスとの連携なども考慮する必要があります。
- mobes及びlacisOath,araneaDeviceGate側では必ずエッジデバイスなどはlacisIDを持つuserObjectとして取り扱われこれはスタッフ、ゲスト、ネットワークデバイス、API、IoTデバイス、ゲスト、メニューなどの全てを擬人化したuserObjectとして扱う仕組みで個々のカメラをlacisIDが付与されたTypedomain=araneaDeviceとして登録しステート管理を行います。これはMACアドレス準拠でネットワークトポロジーを取り扱う CelestialGlobe系との連携も必要になります。
- これらmobes系の実装はhttps://github.com/warusakudeveroper/mobes2.0にあり、ここへのアクセス権限はあるため実装などの確認を行うことは可能です。ただし込み入った内容となっており多くの依存関係があるため勝手な解釈で適当に実装するという行為は完全に禁止です。
- 特に権限階層CathedralOrder、テナント権限境界、施設を示すfid（4桁数字）、rid、CIC認証、共通スキーマであるuserObjectスキーマの誤解釈や勝手実装には特段の注意が必要です。
## ネットワーク環境
1. 現在いるこのmacは192.168.66.0/24あるいは192.168.3.0/24です。カメラ環境の192.168.125.0/24,192.168.126.0/24,192.168.96.0/23とはomadaのSite to SiteのVPNで接続されてますがVPN環境のためArpやmdnsは通りません。
2. is20にarpスキャンを積む場合は192.168.125.0/24と192.168.126.0/24に1台ずつ配備されています。code/orangePi/is20sにソースはありますが勝手な実装は禁止です。依頼文を作って下さい。
3. サーバーは上述の通り192.168.125.246で動作してます。

## 完全遵守する手順 ///ルール

1. code/orangePi/is21-22/designs/headdesignの設計ドキュメントの確認、is22だけではなくis21の設計も実装の方が先行してレガシーなっている可能性があるのでcode/orangePi/is21及び192.168.3.240の実機実装の確認と192.168.125.246への疎通確認、導入環境の確認
2. 設計前にカメラの疎通テストを実施。疎通テストの記録を残す。カンニング防止のためいくつかの施設のカメラの直接のIPはブラインドしてます。
3. code/orangePi/is21-22/designs/headdesign内の旧設計ドキュメントと最新実装仕様、必須参照`code/orangePi/is21-22/designs/headdesign/is22_Camserver仕様案(基本設計書草案改訂版).md``code/orangePi/is21-22/designs/headdesign/is22_Camserver実装指示.md`とのギャップを詳細に検証、報告は設計修正項目インデクスのドキュメントを作成し詳細にまとめる
4. 設計修正項目インデクスのドキュメントと現在の実装、旧設計ドキュメントを比較参照してギャップ解消漏れ、必須参照ドキュメントとの抜け漏れがないか詳細に比較、必要な設計ドキュメントを作成、完全に整備、設計ドキュメントの最新インデックスを作成
5. インデックスに基づいて実装計画を作成、issueとして分割して登録する
6. Issueに基づいて実装、必ず1Issueごとに設計ドキュメントとの整合性、必須参照項目との整合性を確認する。特にファイルがあるから実装済み、Diff見た感じ大丈夫そうと言った依存関係無視の独善的実装は完了判定にならない。
7. テスト可能な項目、アクセス可能な項目はすべてテストして次へ進み全項目を実装、実装完了報告ドキュメントを作成
8. 実装完了項目と実際の実装を確認しテストを実施、レビュー依頼時は実装報告レビュー依頼のドキュメントを作成、githubにコミット、pushを行いリンク付きで依頼すること。
9. 上記を完全実装するまで実施して下さい。サーバーの実装ファイルは原則としてcode/orangePi/is22に格納、githubにバックアップ内容、実装利益が残らないため原則ローカルでのコーディング、転送、gitコミットプッシュの手順を推奨するが、サーバー上での実装の方が合理的、サーバー内で展開必要なファイル、gitignore扱いにするようなモジュールファイル、ライブラリなどは実装したという詳細内容報告でも良い
10. 実装が完了したらis21を含めたE2Eテスト計画を作成、適切に完全操作するまでのPDCAを含めた計画とする。必ずchromeでのUI検証、UIからのCrudをフロントエンド、バックエンドからの検証、必ずフロントエンドの全ボタン、全入力箇所のUIからのテストを行うこと、UIがあるからOKなどの判定は許可しない。
11. is21-22の双方を監視しテストすること
12. テスト完了したら最終報告

# 大原則の宣言(必ず復唱必要)
1. SSoTの大原則を遵守します
2. Solidの原則を意識し特に単一責任、開放閉鎖、置換原則、依存逆転に注意します
3. 必ずMECEを意識し、このコードはMECEであるか、この報告はMECEであるかを報告の中に加えます。
4. アンアンビギュアスな報告回答を義務化しアンアンビギュアスに到達できていない場合はアンアンビギュアスであると宣言できるまで明確な検証を行います。
5. 根拠なき自己解釈で情報に優劣を持たせる差別コード、レイシストコードは絶対の禁止事項です。情報の公平性原則
6. 実施手順と大原則に違反した場合は直ちに作業を止め再度現在位置を確認の上でリカバーしてから再度実装に戻ります
7. チェック、テストのない完了報告はただのやった振りのためこれは行いません
8. 依存関係と既存の実装を尊重し、確認し、車輪の再発明行為は絶対に行いません
9. 作業のフェーズ開始前とフェーズ終了時に必ずこの実施手順と大原則を全文省略なく復唱します
10. 必須参照`code/orangePi/is21-22/designs/headdesign/is22_Camserver仕様案(基本設計書草案改訂版).md``code/orangePi/is21-22/designs/headdesign/is22_Camserver実装指示.md`の改変はゴールを動かすことにつながるため禁止です。
11. このcode/orangePi/is21-22/designs/headdesign/is22_Camserver実装指示.mdを全てのフェーズ前に鑑として再読し基本的な思想や概念的齟齬が存在しないかを確認します。
12. ルール無視はルールを無視した時点からやり直すこと。