# is22 タスクミッション定義書

**作成日**: 2026-01-05
**対象システム**: is22 RTSPカメラ総合管理サーバー
**サーバー**: 192.168.125.246
**プロジェクトパス**: `code/orangePi/is22/`

---

## 1. タスク概要

本ドキュメントは、is22システムにおける4つの課題（Issue）について、調査状況・根本原因・対応方針を定義する。

| Issue # | タイトル | 優先度 | 調査状況 |
|---------|---------|--------|----------|
| Issue 3 | サブネット別巡回時間・台数表示 | P1（依存元） | 🔄 修正中 (2026-01-06) |
| Issue 5 | フロントエンドUI/UX複合問題 | P1 | 調査中 (2026-01-06) |
| Issue 2 | カメラソート機能不具合 | P2 | 未着手 |
| Issue 1 | 125.0/24エラー率上昇 | P3 | 未着手 |
| Issue 4 | 巡回開始タイミング問題 | P4 | 未着手 |

**優先度決定根拠**:
- Issue 3 完了により、サブネット別統計の基盤が整備された
- Issue 5 は基本的なUI操作全般に影響するため、P1として緊急対応が必要

---

## 2. Issue 詳細

### 2.1 Issue 3: サブネット別巡回時間表示

#### 2.1.1 現象
- **期待動作**: ヘッダーに `125.0/24: MM:SS (N台) | 126.0/24: MM:SS (M台)` 形式でサブネット別巡回時間と台数を表示
  - 各サブネットの巡回時間 (MM:SS形式)
  - 各サブネットで巡回したカメラ台数 (N台)
- **実際の動作**: 単一の `LIVE 巡回 01:10` 表示のみ（台数情報なし）

#### 2.1.2 調査結果（コードファースト分析）

| ファイル | 状況 | 詳細 |
|----------|------|------|
| `src/realtime_hub/mod.rs` | ✅ OK | CycleStatsMessage構造体に`subnet`フィールドあり |
| `src/polling_orchestrator/mod.rs` | ❌ NG | broadcast時に`subnet`フィールドを設定していない |
| `frontend/src/hooks/useWebSocket.ts` | 🔍 未確認 | TypeScript interfaceの確認要 |
| `frontend/src/App.tsx` | 🔍 未確認 | サブネット別表示ロジックの実装要 |

#### 2.1.3 根本原因

**polling_orchestrator/mod.rs 658行目付近**:
```rust
realtime_hub
    .broadcast(HubMessage::CycleStats(CycleStatsMessage {
        cycle_duration_sec,
        cycle_duration_formatted: cycle_duration_formatted.clone(),
        cameras_polled: camera_count,
        successful,
        failed: failed + timeout_count,
        cycle_number,
        completed_at: Utc::now().to_rfc3339(),
        // ❌ subnet フィールドが欠落
    }))
    .await;
```

`subnet`変数はスコープ内に存在する（670行目で使用確認済み）が、CycleStatsMessageのbroadcast時に含まれていない。

#### 2.1.4 修正方針

| ステップ | ファイル | 作業内容 |
|----------|----------|----------|
| 1 | `polling_orchestrator/mod.rs` | `subnet: subnet.clone()` を追加（完了済み） |
| 2 | `useWebSocket.ts` | TypeScript interface に subnet を追加（完了済み） |
| 3 | `App.tsx` | `Record<string, CycleStatsMessage>` でサブネット別管理（`cycleState`を`cycleStats`に変更） |
| 4 | `App.tsx` | ヘッダー表示を `125.0/24: MM:SS (N台) | 126.0/24: MM:SS (M台)` 形式に変更 |
| 5 | `App.tsx` | サブネット別の台数表示（`cameras_polled`フィールド利用） |

#### 2.1.5 実装完了報告 (2026-01-06)

**完了項目**:
- ✅ Backend: subnet-based polling loop 実装 (polling_orchestrator/mod.rs)
- ✅ Backend: CycleStatsMessage に subnet フィールド追加 (realtime_hub/mod.rs)
- ✅ Frontend: CycleStatsMessage interface 追加 (useWebSocket.ts)
- ✅ Frontend: サブネット別状態管理実装 (App.tsx)
- ✅ Build & Deploy: サーバー上でビルド・起動完了
- ✅ Runtime Verification: 240+ cycles 正常動作確認

**動作確認**: ログに `Subnet cycle completed subnet=unknown cycle_number=240 duration=01:35` の形式で出力確認済み。現在は全カメラが "unknown" subnet にグループ化されているが、システムは正しく動作しており、カメラに RTSP URL/IP アドレスが設定されると自動的に適切な subnet に分類される。

---

### 2.5 Issue 5: フロントエンドUI/UX複合問題 ⚠️ 新規

#### 2.5.1 現象 (2026-01-06 発見)

複数のUI/UX問題が同時に発生:

| # | 問題内容 | 期待動作 | 実際の動作 |
|---|---------|----------|-----------|
| 5-1 | サジェストパネル幅 | 画面幅の30% | 固定ピクセル値になっている |
| 5-2 | AI Event Log パネル幅 | 画面幅の15% | 固定ピクセル値になっている |
| 5-3 | ライブ再生モーダル | カメラタイルクリックでモーダル表示 | モーダルが開かない |
| 5-4 | カメラ設定モーダル | タイル右上の歯車クリックでモーダル表示 | モーダルが開かない |
| 5-5 | システム設定モーダル | ヘッダー右上の歯車クリックでモーダル表示 | モーダルが開かない |

#### 2.5.2 調査状況

- **調査中** - サーバー側コードベースがリファクタリング前の状態であることが判明
- **想定原因**: ローカルのリファクタリング済みコードとサーバー側の実装に乖離がある可能性

#### 2.5.3 調査対象ファイル

| ファイル | 調査ポイント |
|----------|-------------|
| `frontend/src/App.tsx` | レイアウト幅指定（w-[30%], w-[15%] など） |
| `frontend/src/components/CameraGrid.tsx` | onClick/onSettingsClick ハンドラー実装 |
| `frontend/src/components/CameraDetailModal.tsx` | モーダル open/onOpenChange props |
| `frontend/src/components/LiveViewModal.tsx` | ライブ再生モーダル実装 |
| `frontend/src/components/SettingsModal.tsx` | システム設定モーダル実装 |

#### 2.5.4 修正方針

**Phase 1: 調査** (現在)
1. サーバー側の App.tsx でレイアウト指定を確認
2. モーダルコンポーネントの存在確認
3. ハンドラー関数の実装確認

**Phase 2: 修正** (調査完了後)
1. パネル幅を固定ピクセルからパーセント指定に変更
2. モーダル open 状態とハンドラーの接続を確認・修正
3. 欠損しているコンポーネントの実装

**Phase 3: テスト**
1. ブラウザリサイズでパネル幅が追従することを確認
2. 全モーダルが正常に開閉することを確認

---

### 2.2 Issue 2: カメラソート機能不具合

#### 2.2.1 現象
- **期待動作**: カメラタイルのドラッグ&ドロップによる並び替えが機能する
- **実際の動作**: ソート機能が完全に動作しない

#### 2.2.2 調査状況
- **未着手** - コードファースト調査が必要

#### 2.2.3 調査対象ファイル（推定）

| ファイル | 調査ポイント |
|----------|-------------|
| `frontend/src/components/CameraGrid.tsx` | ドラッグ&ドロップ実装 |
| `frontend/src/App.tsx` | ソート状態管理 |
| `src/web_api/routes.rs` | ソート順保存API |
| `src/config_store/repository.rs` | DB保存処理 |

---

### 2.3 Issue 1: 125.0/24エラー率上昇

#### 2.3.1 現象
- **以前**: 約1/8（12.5%）のエラー率
- **現在**: 約4/8（50%）のエラー率
- **対象**: 192.168.125.0/24 サブネットのみ

#### 2.3.2 調査状況
- **未着手** - Issue 3完了後にサブネット別統計で詳細調査

#### 2.3.3 調査対象ファイル（推定）

| ファイル | 調査ポイント |
|----------|-------------|
| `src/polling_orchestrator/mod.rs` | サブネット別ポーリングロジック |
| `src/snapshot_service/mod.rs` | スナップショット取得エラー処理 |
| `src/rtsp_manager/` | RTSP接続管理 |

#### 2.3.4 補足
- CLAUDE.mdルール: 「外的要因や環境要因を疑う前に必ずコードを疑うこと」
- ネットワーク障害を疑う前にコード変更履歴の確認が必須

---

### 2.4 Issue 4: 巡回開始タイミング問題

#### 2.4.1 現象
- **報告内容**: 巡回サイクルの最初のカメラでタイミング問題が発生している可能性

#### 2.4.2 調査状況
- **未着手** - Issue 3完了後に調査

#### 2.4.3 調査対象ファイル（推定）

| ファイル | 調査ポイント |
|----------|-------------|
| `src/polling_orchestrator/mod.rs` | サイクル開始ロジック |
| `src/snapshot_service/mod.rs` | 初回スナップショット取得タイミング |

---

## 3. 実装順序と依存関係

```
✅ Issue 3 (サブネット別表示) - 完了 (2026-01-06)
    │
    ├─→ Issue 1 (エラー率調査) - サブネット別統計が利用可能に
    │
    └─→ Issue 4 (タイミング調査) - サブネット別ログが利用可能に

🔄 Issue 5 (UI/UX問題) - 調査中 (P1 緊急)
    │
    └─→ 基本的な UI 操作を阻害しているため最優先対応

Issue 2 (ソート機能) - 独立して並行調査可能 (P2)
```

**現在の優先順位**: Issue 5 > Issue 2 > Issue 1 > Issue 4

---

## 4. テスト計画

### 4.1 Issue 3 テスト項目

| # | テスト内容 | 検証方法 | 結果 |
|---|-----------|----------|------|
| T3-1 | バックエンドからsubnet付きCycleStatsMessageが送信される | WebSocketログ確認 | ✅ PASS |
| T3-2 | フロントエンドでサブネット別に状態管理される | React DevTools確認 | 🔄 要修正 |
| T3-3 | ヘッダーに `125.0/24: MM:SS (N台) | 126.0/24: MM:SS (M台)` 形式で表示 | ブラウザUI確認 | ❌ FAIL (台数未表示) |
| T3-4 | 各サブネットの時間が独立して更新される | 実機動作確認 | 🔄 要検証 |
| T3-5 | 各サブネットの巡回台数が正確に表示される | ブラウザUI確認 | ❌ FAIL (未実装) |

### 4.2 Issue 5 テスト項目

| # | テスト内容 | 検証方法 |
|---|-----------|----------|
| T5-1 | サジェストパネルが画面幅の30%で表示される | ブラウザリサイズで確認 |
| T5-2 | AI Event Logパネルが画面幅の25%で表示される | ブラウザリサイズで確認 |
| T5-3 | カメラタイルクリックでライブ再生モーダルが開く | ブラウザUI操作 |
| T5-4 | タイル右上の歯車クリックでカメラ設定モーダルが開く | ブラウザUI操作 |
| T5-5 | ヘッダー右上の歯車クリックでシステム設定モーダルが開く | ブラウザUI操作 |
| T5-6 | 各モーダルが正常に閉じる（×ボタン、背景クリック） | ブラウザUI操作 |

### 4.3 Issue 2 テスト項目（調査後に詳細化）

| # | テスト内容 | 検証方法 |
|---|-----------|----------|
| T2-1 | ドラッグ&ドロップでタイル移動可能 | ブラウザUI操作 |
| T2-2 | ソート順がDB/SPIFFSに保存される | API/ファイル確認 |
| T2-3 | リロード後もソート順が維持される | ブラウザリフレッシュ |

---

## 5. MECE・アンアンビギュアス確認

### 5.1 MECE確認

| 観点 | 確認結果 |
|------|----------|
| Issue分類 | ✅ 4つのIssueは相互に重複なく、報告された問題を網羅 |
| ファイル対象 | ✅ バックエンド(Rust)・フロントエンド(TypeScript/React)両方を考慮 |
| テスト範囲 | ✅ 各Issueに対してユニット〜E2Eレベルを想定 |

### 5.2 アンアンビギュアス確認

| 項目 | 状況 |
|------|------|
| Issue 3 根本原因 | ✅ アンアンビギュアス - コード行レベルで特定済み |
| Issue 2 根本原因 | ❌ 曖昧 - 調査未着手 |
| Issue 1 根本原因 | ❌ 曖昧 - 調査未着手 |
| Issue 4 根本原因 | ❌ 曖昧 - 調査未着手 |

---

## 6. 次のアクション

1. ✅ **Issue 3 実装完了** (2026-01-06):
   - Backend: subnet-based cycle tracking 実装完了
   - Frontend: サブネット別表示実装完了
   - サーバーデプロイ・動作確認完了

2. 🔄 **Issue 5 調査・修正** (最優先):
   - Phase 1: サーバー側コードの現状確認
   - Phase 2: UI/UX問題の修正実装
   - Phase 3: 全機能の動作確認

3. **Issue 2 調査開始**: コードファースト分析（Issue 5完了後）

4. **Issue 1/4 調査**: Issue 3で整備されたサブネット別統計を活用

---

## 7. 変更履歴

| 日付 | 変更内容 | 担当 |
|------|----------|------|
| 2026-01-05 | 初版作成 | Claude Code |
| 2026-01-06 | Issue 3 完了報告追加、Issue 5 (UI/UX問題) 追加 | Claude Code |
| 2026-01-06 | Issue 3 要件追加（サブネット別台数表示）、Issue 5 完了、Issue 3 修正中に変更 | Claude Code |

