# is21 運用設計

文書番号: is21_04
作成日: 2025-12-29
ステータス: Draft

---

## 1. サービス構成

### 1.1 systemdサービス
```ini
# /etc/systemd/system/is21-infer.service
[Unit]
Description=is21 camimageEdge AI Inference Server
After=network.target

[Service]
Type=simple
User=is21
Group=is21
WorkingDirectory=/opt/is21
ExecStart=/opt/is21/venv/bin/python -m is21_infer.main
Restart=always
RestartSec=5

# 環境変数
Environment=IS21_PORT=9000
Environment=IS21_MODEL_DIR=/opt/is21/models
Environment=IS21_LOG_LEVEL=INFO

# リソース制限
MemoryMax=4G
CPUQuota=200%

[Install]
WantedBy=multi-user.target
```

### 1.2 ディレクトリ構成
```
/opt/is21/
├── venv/                 # Python仮想環境
├── models/               # RKNNモデル
│   ├── yolov8n-person.rknn
│   ├── yolov8n-animal.rknn
│   └── schema.json       # キャッシュ（is22からプッシュ）
├── logs/                 # ログ
│   └── is21.log
└── is21_infer/           # アプリケーションコード
    ├── __init__.py
    ├── main.py
    ├── api.py
    ├── inference.py
    └── schema.py
```

---

## 2. ログ設計

### 2.1 ログレベル
| レベル | 用途 |
|-------|------|
| ERROR | 推論失敗・モデル読み込みエラー |
| WARNING | schema不一致・画像デコード失敗 |
| INFO | リクエスト受付・完了 |
| DEBUG | 詳細な推論過程 |

### 2.2 ログフォーマット
```json
{
  "timestamp": "2025-12-28T18:59:12.345+09:00",
  "level": "INFO",
  "logger": "is21.api",
  "message": "analyze completed",
  "camera_id": "cam_2f_19",
  "primary_event": "human",
  "processing_ms": 127,
  "request_id": "6b7f1e2a-5a2b-4f33-8cc8-2a9a39f6d9d1"
}
```

### 2.3 ログローテーション
```ini
# /etc/logrotate.d/is21
/opt/is21/logs/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    copytruncate
}
```

---

## 3. ヘルスチェック

### 3.1 /healthz応答内容
```json
{
  "status": "ok",
  "uptime_sec": 3600,
  "model_loaded": true,
  "schema_version": "2025-12-28.1",
  "last_inference_at": "2025-12-28T18:59:12Z"
}
```

### 3.2 is22からの監視
```python
# is22側（dispatcher起動時）
async def check_is21_health():
    try:
        r = await httpx.get("http://is21:9000/healthz", timeout=3)
        if r.status_code == 200:
            return True
    except:
        pass
    return False
```

### 3.3 異常時対応
| 状態 | is22の動作 |
|-----|-----------|
| is21応答なし | 推論スキップ、no_event扱い |
| schema未設定 | PUT /v1/schema 実行 |
| 429 Overloaded | 送信抑制（最新1枚のみ） |

---

## 4. モデル更新

### 4.1 更新手順
1. 新モデルを `/opt/is21/models/` に配置
2. `systemctl restart is21-infer`
3. /v1/capabilities で確認

### 4.2 ロールバック
```bash
# 旧モデルに戻す
mv /opt/is21/models/yolov8n-person.rknn{,.new}
mv /opt/is21/models/yolov8n-person.rknn{.backup,}
systemctl restart is21-infer
```

---

## 5. 監視項目

### 5.1 メトリクス
| メトリクス | 閾値 | アラート |
|-----------|------|---------|
| 推論遅延 | > 500ms | WARNING |
| メモリ使用 | > 3GB | WARNING |
| 推論エラー率 | > 5% | ERROR |
| 応答なし | 30秒 | CRITICAL |

### 5.2 Prometheus Exporter（オプション）
```
# /metrics
is21_inference_total{status="success"} 12345
is21_inference_total{status="error"} 12
is21_inference_duration_ms{quantile="0.5"} 127
is21_inference_duration_ms{quantile="0.99"} 450
is21_schema_version{version="2025-12-28.1"} 1
```

---

## 6. セキュリティ

### 6.1 ネットワーク
- VPN/LAN内のみアクセス可能
- ファイアウォールで9000/tcpを制限

### 6.2 ファイルシステム
- /opt/is21/models は読み取り専用推奨
- ログ以外の書き込み禁止

### 6.3 プロセス権限
- 非rootユーザー（is21）で実行
- sudo不可

---

## 7. 障害対応

### 7.1 推論サービス停止
```bash
# ログ確認
journalctl -u is21-infer -f

# 再起動
systemctl restart is21-infer

# モデルファイル確認
ls -la /opt/is21/models/*.rknn
```

### 7.2 メモリ不足
```bash
# プロセス確認
top -p $(pgrep -f is21_infer)

# 必要に応じて再起動
systemctl restart is21-infer
```

### 7.3 RKNNエラー
- ドライバ確認: `dmesg | grep rknpu`
- 再起動: `systemctl restart is21-infer`

---

## 8. バックアップ

### 8.1 対象
| 対象 | 頻度 | 方法 |
|-----|------|------|
| モデルファイル | 変更時 | rsync |
| 設定ファイル | 変更時 | git |
| ログ | 日次 | logrotate |

### 8.2 リストア
```bash
# モデル復元
rsync -av backup:/opt/is21/models/ /opt/is21/models/

# サービス再起動
systemctl restart is21-infer
```

---

## 9. テスト観点

### 9.1 運用テスト
- [ ] サービス起動/停止/再起動
- [ ] ログローテーション動作
- [ ] ヘルスチェック応答

### 9.2 障害テスト
- [ ] is21停止時のis22動作（推論スキップ）
- [ ] メモリ過使用時の挙動
- [ ] 不正モデルファイル配置時

### 9.3 性能テスト
- [ ] 30台カメラからの同時リクエスト
- [ ] 長時間連続運用（24時間）
