# mobes2.0連携 E2Eテスト計画

## 概要

| 項目 | 内容 |
|------|------|
| 対象バージョン | IS22 CamServer v2.0.1 |
| テスト日 | 2026-01-12 |
| 対象機能 | Paraclate連携、AIサマリー、AIアシスタントチャット |
| 前提コミット | 560c310 |

## テスト環境

| コンポーネント | エンドポイント | 状態 |
|---------------|---------------|------|
| IS22 CamServer | http://192.168.125.246:3000 | 稼働中 |
| IS21 推論サーバー | http://192.168.3.240:9000 | 接続済み |
| Paraclate API | asia-northeast1 | 接続済み |
| カメラ台数 | 17台 | 全台オンライン |
| 検出ログ | 147,368件 | 蓄積中 |

## テスト項目

### 1. AIアシスタントチャット機能

#### 1.1 拡大表示モーダル
| # | テスト項目 | 手順 | 期待結果 |
|---|-----------|------|---------|
| 1.1.1 | 拡大アイコン表示 | チャットパネルのヘッダーを確認 | 🔳アイコンが表示される |
| 1.1.2 | モーダル展開 | 拡大アイコンをクリック | 青色ヘッダーのモーダルが開く |
| 1.1.3 | メッセージ履歴表示 | モーダル内を確認 | 過去のチャット履歴が表示される |
| 1.1.4 | メッセージ送信 | テキスト入力→Enter | メッセージが送信される |
| 1.1.5 | ESCキー閉じる | ESCキーを押下 | モーダルが閉じる |
| 1.1.6 | ×ボタン閉じる | ×ボタンをクリック | モーダルが閉じる |

#### 1.2 検出傾向調整サジェスト
| # | テスト項目 | 手順 | 期待結果 |
|---|-----------|------|---------|
| 1.2.1 | サジェスト表示 | 過検出カメラを待機 | サジェストメッセージが表示される |
| 1.2.2 | 「はい」応答 | 「はい」ボタンをクリック | プリセット変更が適用される |
| 1.2.3 | 「いいえ」応答 | 「いいえ」ボタンをクリック | 却下メッセージが追加される |
| 1.2.4 | 自動削除（1分後） | 「いいえ」後60秒待機 | メッセージがスライドアウトで消える |

### 2. AIサマリー機能

#### 2.1 サマリー生成
| # | テスト項目 | 手順 | 期待結果 |
|---|-----------|------|---------|
| 2.1.1 | 手動サマリー生成 | POST /api/summary/generate | サマリーが生成される |
| 2.1.2 | サマリー履歴取得 | GET /api/summary/history | 履歴リストが返される |
| 2.1.3 | 特定サマリー取得 | GET /api/summary/:id | サマリー詳細が返される |

#### 2.2 GrandSummary
| # | テスト項目 | 手順 | 期待結果 |
|---|-----------|------|---------|
| 2.2.1 | GrandSummary生成 | POST /api/summary/grand | 統合サマリーが生成される |
| 2.2.2 | スケジュール取得 | GET /api/summary/schedules | スケジュールリストが返される |

### 3. Paraclate連携

#### 3.1 設定同期
| # | テスト項目 | 手順 | 期待結果 |
|---|-----------|------|---------|
| 3.1.1 | 設定Push | POST /api/paraclate/push | 設定がParaclateに送信される |
| 3.1.2 | 設定Pull | POST /api/paraclate/pull | Paraclateから設定を取得 |
| 3.1.3 | 同期状態確認 | GET /api/paraclate/status | 接続状態がconnectedで返される |

#### 3.2 PubSub購読
| # | テスト項目 | 手順 | 期待結果 |
|---|-----------|------|---------|
| 3.2.1 | 購読開始 | POST /api/paraclate/subscribe | 購読が開始される |
| 3.2.2 | メッセージ受信 | mobes側から設定変更 | 変更が反映される |

#### 3.3 FID検証
| # | テスト項目 | 手順 | 期待結果 |
|---|-----------|------|---------|
| 3.3.1 | 有効FID検証 | POST /api/paraclate/validate-fid | validがtrueで返される |
| 3.3.2 | 無効FID検証 | 無効なFIDで検証 | validがfalseで返される |

### 4. カメラ同期（Phase 8）

| # | テスト項目 | 手順 | 期待結果 |
|---|-----------|------|---------|
| 4.1 | カメラ一覧同期 | POST /api/camera-sync/push | カメラ情報がParaclateに送信される |
| 4.2 | 同期履歴確認 | GET /api/camera-sync/history | 同期履歴が返される |

### 5. システム健全性

| # | テスト項目 | 手順 | 期待結果 |
|---|-----------|------|---------|
| 5.1 | Health Check | GET /api/health | status: "healthy" |
| 5.2 | システム状態 | GET /api/system | CPU/Memory情報が返される |
| 5.3 | カメラ状態 | GET /api/cameras | 17台全てonlineで返される |

## テスト実行手順

### 準備
```bash
# IS22 CamServer稼働確認
curl http://192.168.125.246:3000/api/health

# フロントエンド接続確認
# ブラウザで http://192.168.125.246:3000 にアクセス
```

### UIテスト（Chrome DevTools併用）
1. Chrome で http://192.168.125.246:3000 にアクセス
2. DevTools (F12) → Network タブを開く
3. 各機能を順番にテスト
4. APIレスポンスとUI表示を確認

### APIテスト（curl/Postman）
```bash
# サマリー生成
curl -X POST http://192.168.125.246:3000/api/summary/generate

# Paraclate状態確認
curl http://192.168.125.246:3000/api/paraclate/status

# GrandSummary生成
curl -X POST http://192.168.125.246:3000/api/summary/grand
```

## 合格基準

| カテゴリ | 基準 |
|---------|------|
| AIアシスタント | 全6項目Pass |
| サジェスト | 全4項目Pass |
| AIサマリー | 全5項目Pass |
| Paraclate連携 | 全6項目Pass |
| カメラ同期 | 全2項目Pass |
| システム | 全3項目Pass |

**合計**: 26項目中24項目以上Pass（92%以上）でテスト合格

## 備考

- entrance プリセットの conf_override を 0.35 → 0.45 に修正済み（unknown_flood対策）
- 静的ファイル配信をRust Axumバックエンドから実施（ポート3000統一）
- 「いいえ」応答メッセージは1分後に自動削除される仕様

## 関連ドキュメント

- [実装報告書](./IMPLEMENTATION_REPORT_AIAssistant.md)
- [Phase 4 ParaclateClient設計](./Phase4_ParaclateClient.md)
- [MASTER_INDEX](./MASTER_INDEX.md)
