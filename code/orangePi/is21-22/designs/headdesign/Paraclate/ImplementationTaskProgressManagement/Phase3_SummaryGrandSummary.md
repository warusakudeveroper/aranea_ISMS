# Phase 3: Summary/GrandSummary å®Ÿè£…ã‚¿ã‚¹ã‚¯

å¯¾å¿œDD: DD02_Summary_GrandSummary.md
ä¾å­˜é–¢ä¿‚: Phase 2ï¼ˆCameraRegistryï¼‰

---

## æ¦‚è¦

æ¤œå‡ºã‚¤ãƒ™ãƒ³ãƒˆã‚’å®šæœŸçš„ã«é›†è¨ˆã—ã€Summaryï¼ˆé–“éš”ãƒ™ãƒ¼ã‚¹ï¼‰ãŠã‚ˆã³GrandSummaryï¼ˆæ™‚åˆ»æŒ‡å®šãƒ™ãƒ¼ã‚¹ï¼‰ã‚’ç”Ÿæˆãƒ»ä¿å­˜ã™ã‚‹ã€‚

---

## Summaryç¨®åˆ¥

| ç¨®åˆ¥ | ãƒˆãƒªã‚¬ãƒ¼ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | ç”¨é€” |
|------|---------|-----------|------|
| Summary | æ™‚é–“é–“éš”çµŒé | 60åˆ† | æœŸé–“å†…ã®æ¤œå‡ºã‚¤ãƒ™ãƒ³ãƒˆè¦ç´„ |
| GrandSummary | æŒ‡å®šæ™‚åˆ»åˆ°é” | 09:00, 17:00, 21:00 | è¤‡æ•°Summaryã®çµ±åˆãƒ»1æ—¥ã®ç·æ‹¬ |
| Emergency | ç•°å¸¸æ¤œå‡ºæ™‚ | severity >= é–¾å€¤ | å³æ™‚å ±å‘Š |

---

## ã‚¿ã‚¹ã‚¯ä¸€è¦§

### T3-1: SummaryOverviewè¨­è¨ˆãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

**çŠ¶æ…‹**: âœ… COMPLETED (2026-01-10)
**å„ªå…ˆåº¦**: P0ï¼ˆãƒ–ãƒ­ãƒƒã‚«ãƒ¼ï¼‰
**è¦‹ç©ã‚‚ã‚Šè¦æ¨¡**: M

**å†…å®¹**:
- `ai_summary_cache`ã«summary_jsonã‚«ãƒ©ãƒ è¿½åŠ 
- `scheduled_reports`ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- SummaryPayloadå‹å®šç¾©

**æˆæœç‰©**:
- `migrations/022_summary_service.sql` âœ…
- `src/summary_service/types.rs` âœ…

**summaryIDå½¢å¼**ï¼ˆCONSISTENCY_CHECK P1-1å¯¾å¿œï¼‰:
- DBã®summary_idï¼ˆBIGINT AUTO_INCREMENTï¼‰ã‚’æ­£æœ¬
- Paraclateé€ä¿¡æ™‚ã¯`SUM-{id}`å½¢å¼

**æ¤œè¨¼æ–¹æ³•**:
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡ŒæˆåŠŸ
- å‹å®šç¾©ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«

---

### T3-2: summary_generator.rs å®Ÿè£…

**çŠ¶æ…‹**: âœ… COMPLETED (2026-01-10)
**å„ªå…ˆåº¦**: P0ï¼ˆãƒ–ãƒ­ãƒƒã‚«ãƒ¼ï¼‰
**è¦‹ç©ã‚‚ã‚Šè¦æ¨¡**: L

**å†…å®¹**:
- `SummaryGenerator`ã‚¯ãƒ©ã‚¹å®Ÿè£…
- æ¤œå‡ºãƒ­ã‚°é›†è¨ˆâ†’summary_text/summary_jsonç”Ÿæˆ

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
- `generate()`: æœŸé–“æŒ‡å®šã§Summaryç”Ÿæˆ
- `generate_summary_text()`: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ™ãƒ¼ã‚¹ã®ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
- `build_summary_json()`: Paraclateé€ä¿¡ç”¨JSONãƒšã‚¤ãƒ­ãƒ¼ãƒ‰æ§‹ç¯‰

**æˆæœç‰©**:
- `src/summary_service/generator.rs` âœ…
- `src/summary_service/payload_builder.rs` âœ…

**æ¤œè¨¼æ–¹æ³•**:
- ç©ºæœŸé–“â†’ç©ºSummary
- æ¤œå‡ºã‚ã‚Šâ†’é›†è¨ˆæ­£ç¢º

---

### T3-3: ai_summary_cache ãƒªãƒã‚¸ãƒˆãƒª

**çŠ¶æ…‹**: âœ… COMPLETED (2026-01-10)
**å„ªå…ˆåº¦**: P0ï¼ˆãƒ–ãƒ­ãƒƒã‚«ãƒ¼ï¼‰
**è¦‹ç©ã‚‚ã‚Šè¦æ¨¡**: M

**å†…å®¹**:
- Summaryä¿å­˜ãƒ»å–å¾—ãƒ»æ¤œç´¢
- expires_atç®¡ç†

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
- `insert()`
- `get_by_id()`
- `get_by_period()`
- `get_latest()`
- `update_summary_json()`

**æˆæœç‰©**:
- `src/summary_service/repository.rs` âœ…

**æ¤œè¨¼æ–¹æ³•**:
- CRUDæ“ä½œãƒ†ã‚¹ãƒˆ

---

### T3-4: å®šæ™‚å®Ÿè¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©

**çŠ¶æ…‹**: âœ… COMPLETED (2026-01-10)
**å„ªå…ˆåº¦**: P0ï¼ˆãƒ–ãƒ­ãƒƒã‚«ãƒ¼ï¼‰
**è¦‹ç©ã‚‚ã‚Šè¦æ¨¡**: L

**å†…å®¹**:
- `SummaryScheduler`å®Ÿè£…ï¼ˆ1åˆ†é–“éš”ãƒã‚§ãƒƒã‚¯ï¼‰
- next_run_atç®¡ç†
- interval_minutes/scheduled_timeså¯¾å¿œ

**ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¯¾å¿œ**:
- scheduled_timesï¼ˆ09:00ç­‰ï¼‰ã¯Asia/TokyoåŸºæº–ã§è§£é‡ˆ
- UTCã¨ã®å¤‰æ›ã‚’æ­£ç¢ºã«å®Ÿè£…

**æˆæœç‰©**:
- `src/summary_service/scheduler.rs` âœ…

**æ¤œè¨¼æ–¹æ³•**:
- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ™‚åˆ»åˆ°é”â†’è‡ªå‹•å®Ÿè¡Œ
- next_run_atæ­£ç¢ºæ›´æ–°

---

### T3-5: Summary APIå®Ÿè£…

**çŠ¶æ…‹**: âœ… COMPLETED (2026-01-10)
**å„ªå…ˆåº¦**: P0ï¼ˆãƒ–ãƒ­ãƒƒã‚«ãƒ¼ï¼‰
**è¦‹ç©ã‚‚ã‚Šè¦æ¨¡**: M

**å†…å®¹**:
- Summaryç”Ÿæˆ/å–å¾—/ä¸€è¦§API

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ |
|---------------|---------|------|
| `/api/summary/generate` | POST | æ‰‹å‹•Summaryç”Ÿæˆ |
| `/api/summary/latest` | GET | æœ€æ–°Summaryå–å¾— |
| `/api/summary/:id` | GET | ç‰¹å®šSummaryå–å¾— |
| `/api/summary/range` | GET | æœŸé–“æŒ‡å®šä¸€è¦§ |
| `/api/grand-summary/latest` | GET | æœ€æ–°GrandSummary |
| `/api/grand-summary/:date` | GET | æ—¥ä»˜æŒ‡å®šGrandSummary |
| `/api/reports/schedule` | GET | ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å–å¾— |
| `/api/reports/schedule` | PUT | ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ›´æ–° |

**æˆæœç‰©**:
- `src/web_api/summary_routes.rs` âœ…

**æ¤œè¨¼æ–¹æ³•**:
- APIå‘¼ã³å‡ºã—ãƒ†ã‚¹ãƒˆ

---

### T3-6: GrandSummaryè¨­è¨ˆ

**çŠ¶æ…‹**: âœ… COMPLETED (2026-01-10)
**å„ªå…ˆåº¦**: P0ï¼ˆãƒ–ãƒ­ãƒƒã‚«ãƒ¼ï¼‰
**è¦‹ç©ã‚‚ã‚Šè¦æ¨¡**: M

**å†…å®¹**:
- è¤‡æ•°hourly Summaryã®çµ±åˆãƒ­ã‚¸ãƒƒã‚¯
- includedSummaryIdsç®¡ç†
- æ—¥æ¬¡å¢ƒç•Œã¯Asia/TokyoåŸºæº–

**æˆæœç‰©**:
- GrandSummary JSONä»•æ§˜ âœ…
- çµ±åˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  âœ…

**æ¤œè¨¼æ–¹æ³•**:
- hourly 24ä»¶â†’daily 1ä»¶çµ±åˆ

---

### T3-7: grand_summary.rs å®Ÿè£…

**çŠ¶æ…‹**: âœ… COMPLETED (2026-01-10)
**å„ªå…ˆåº¦**: P0ï¼ˆãƒ–ãƒ­ãƒƒã‚«ãƒ¼ï¼‰
**è¦‹ç©ã‚‚ã‚Šè¦æ¨¡**: M

**å†…å®¹**:
- `GrandSummaryGenerator`ã‚¯ãƒ©ã‚¹å®Ÿè£…

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:
- `generate()`: æ—¥ä»˜æŒ‡å®šã§GrandSummaryç”Ÿæˆ
- `get_latest()`: æœ€æ–°GrandSummaryå–å¾—
- `get_by_date()`: æ—¥ä»˜æŒ‡å®šå–å¾—

**æˆæœç‰©**:
- `src/summary_service/grand_summary.rs` âœ…

**æ¤œè¨¼æ–¹æ³•**:
- çµ±åˆå€¤æ­£ç¢º
- includedSummaryIdsæ­£ç¢º

---

### T3-8: Summaryâ†’GrandSummaryçµ±åˆãƒ†ã‚¹ãƒˆ

**çŠ¶æ…‹**: ğŸ”„ IN_PROGRESS
**å„ªå…ˆåº¦**: P1ï¼ˆå“è³ªæ”¹å–„ï¼‰
**è¦‹ç©ã‚‚ã‚Šè¦æ¨¡**: M

**å†…å®¹**:
- E2Eçµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè£…
- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©â†’Summaryâ†’GrandSummaryâ†’é€ä¿¡ãƒ•ãƒ­ãƒ¼

**æˆæœç‰©**:
- çµ±åˆãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
- ãƒ†ã‚¹ãƒˆæ‰‹é †æ›¸

**æ¤œè¨¼æ–¹æ³•**:
- ãƒ•ãƒ«ãƒ•ãƒ­ãƒ¼å‹•ä½œç¢ºèª

---

## Summary JSONãƒšã‚¤ãƒ­ãƒ¼ãƒ‰å½¢å¼

```json
{
  "lacisOath": {
    "lacisID": "{is22_lacis_id}",
    "tid": "{tenant_id}",
    "cic": "{cic}",
    "blessing": null
  },
  "summaryOverview": {
    "summaryID": "SUM-{db_summary_id}",
    "firstDetectAt": "{timestamp}",
    "lastDetectAt": "{timestamp}",
    "detectedEvents": "{count}"
  },
  "cameraContext": { ... },
  "cameraDetection": [ ... ]
}
```

---

## ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†API

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ |
|---------------|---------|------|
| `/api/reports/schedule` | GET | ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å–å¾— |
| `/api/reports/schedule` | PUT | ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ›´æ–° |

---

## ãƒ†ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] T3-1: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œç¢ºèª
- [ ] T3-2: ç©ºæœŸé–“Summaryãƒ†ã‚¹ãƒˆ
- [ ] T3-2: æ¤œå‡ºã‚ã‚ŠSummaryãƒ†ã‚¹ãƒˆ
- [ ] T3-3: CRUDæ“ä½œãƒ†ã‚¹ãƒˆ
- [ ] T3-4: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©å®Ÿè¡Œãƒ†ã‚¹ãƒˆï¼ˆJSTåŸºæº–ï¼‰
- [ ] T3-5: APIå‘¼ã³å‡ºã—ãƒ†ã‚¹ãƒˆ
- [ ] T3-6: GrandSummaryçµ±åˆãƒ†ã‚¹ãƒˆ
- [ ] T3-7: includedSummaryIdsæ­£ç¢ºæ€§ãƒ†ã‚¹ãƒˆ
- [ ] T3-8: ãƒ•ãƒ«ãƒ•ãƒ­ãƒ¼E2Eãƒ†ã‚¹ãƒˆ

---

## E2Eçµ±åˆãƒ†ã‚¹ãƒˆï¼ˆPhaseå®Œäº†æ™‚ï¼‰

| ãƒ†ã‚¹ãƒˆID | å†…å®¹ | ç¢ºèªé …ç›® |
|---------|------|---------|
| E2 | ã‚«ãƒ¡ãƒ©æ¤œå‡ºâ†’ãƒ­ã‚°è¨˜éŒ²â†’Summaryç”Ÿæˆ | Phase 2,3 |
| E3 | Summaryâ†’Paraclateé€ä¿¡â†’BQåŒæœŸ | Phase 3,4,5 |

---

## å®Œäº†æ¡ä»¶

1. Phase 2å®Œäº†ãŒå‰æ
2. å…¨ã‚¿ã‚¹ã‚¯ï¼ˆT3-1ã€œT3-8ï¼‰ãŒâœ… COMPLETED
3. ãƒ†ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆå…¨é …ç›®ãƒ‘ã‚¹
4. E2ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¯èƒ½

---

## Issueé€£æº

**Phase Issue**: #116
**è¦ªIssue**: #113

å…¨ã‚¿ã‚¹ã‚¯ã¯#116ã§ä¸€æ‹¬ç®¡ç†ã€‚å€‹åˆ¥ã‚¿ã‚¹ã‚¯ã®ã‚µãƒ–IssueåŒ–ã¯å¿…è¦ã«å¿œã˜ã¦å®Ÿæ–½ã€‚

---

## æ›´æ–°å±¥æ­´

| æ—¥ä»˜ | æ›´æ–°å†…å®¹ |
|------|---------|
| 2026-01-10 | åˆç‰ˆä½œæˆ |
| 2026-01-10 | T3-1ã€œT3-7 COMPLETEDã€T3-8 IN_PROGRESS |
