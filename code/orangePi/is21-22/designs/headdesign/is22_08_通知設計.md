# is22 é€šçŸ¥è¨­è¨ˆ

æ–‡æ›¸ç•ªå·: is22_08
ä½œæˆæ—¥: 2025-12-29
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: Draft
å‚ç…§: åŸºæœ¬è¨­è¨ˆæ›¸ Section 13, ç‰¹è¨˜ä»•æ§˜2 Section E

---

## 1. æ¦‚è¦

### 1.1 è²¬å‹™
- å³æ™‚é€šçŸ¥ï¼ˆWebhookï¼‰
- æ—¥æ¬¡è¦ç´„é€šçŸ¥ï¼ˆ19:00ï¼‰
- Vision LLMã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆunknownæ™‚ã®ã¿ï¼‰
- ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ç®¡ç†

### 1.2 è¨­è¨ˆåŸå‰‡
- **é€šçŸ¥æ–‡ã¯è¦³æ¸¬äº‹å®Ÿã®ã¿**ï¼ˆæ¨æ¸¬ãƒ»æ–­å®šç¦æ­¢ï¼‰
- **notify_allowed=trueã®ã‚¿ã‚°ã®ã¿ä½¿ç”¨**
- **investigation_onlyã‚¿ã‚°ã¯é€šçŸ¥ã«å‡ºã•ãªã„**

---

## 2. å³æ™‚é€šçŸ¥

### 2.1 ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶
| æ¡ä»¶ | é€šçŸ¥ |
|-----|------|
| severity >= 2 | â—‹ |
| hazard.* | â—‹ |
| camera.offline | â—‹ |
| unknown_flag=true | â—‹ |
| ä¸Šè¨˜ä»¥å¤–ã®detected | Ã— |

### 2.2 ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
| å¯¾è±¡ | ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ |
|-----|-------------|
| åŒä¸€ã‚«ãƒ¡ãƒ©ãƒ»åŒä¸€primary_event | 5åˆ† |
| åŒä¸€ã‚«ãƒ¡ãƒ©ãƒ»ä»»æ„ã‚¤ãƒ™ãƒ³ãƒˆ | 1åˆ† |

### 2.3 é€šçŸ¥æ–‡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
```rust
fn build_notification_text(
    camera_id: &str,
    location: &str,
    captured_at: DateTime<Utc>,
    result: &AnalyzeResponse,
    schema: &Schema,
) -> String {
    let mut parts = vec![];

    // å ´æ‰€
    parts.push(format!("ğŸ“ {}", location));

    // ä¸»ã‚¤ãƒ™ãƒ³ãƒˆ
    let event_label = match result.primary_event.as_str() {
        "human" => "äººç‰©ã‚’æ¤œçŸ¥",
        "animal" => "å‹•ç‰©ã‚’æ¤œçŸ¥",
        "hazard" => "ç•°å¸¸ã‚’æ¤œçŸ¥",
        "camera_issue" => "ã‚«ãƒ¡ãƒ©ç•°å¸¸",
        _ => "ä½•ã‹ã‚’æ¤œçŸ¥",
    };
    parts.push(event_label.to_string());

    // notify_allowedã‚¿ã‚°ã®ã¿
    let details: Vec<&str> = result.tags.iter()
        .filter_map(|t| {
            let tag_def = schema.get_tag(t)?;
            if tag_def.notify_allowed {
                Some(tag_def.label_ja.as_str())
            } else {
                None
            }
        })
        .collect();

    if !details.is_empty() {
        parts.push(format!("ï¼ˆ{}ï¼‰", details.join(" / ")));
    }

    // æ™‚åˆ»
    let jst = captured_at.with_timezone(&chrono_tz::Asia::Tokyo);
    parts.push(format!("{}", jst.format("%H:%M")));

    parts.join(" ")
}
```

### 2.4 å‡ºåŠ›ä¾‹
```
ğŸ“ 2F å»Šä¸‹ äººç‰©ã‚’æ¤œçŸ¥ï¼ˆå˜ç‹¬ / ä¸Šè¡£:èµ¤ç³» / æ»åœ¨/ã†ã‚ã¤ãï¼‰18:59
```

```
ğŸ“ ç„é–¢ å‹•ç‰©ã‚’æ¤œçŸ¥ï¼ˆå‹•ç‰©:é¹¿ï¼‰06:15
```

```
ğŸ“ å€‰åº« ç•°å¸¸ã‚’æ¤œçŸ¥ï¼ˆç•°å¸¸:ç…™/æ¹¯æ°—ã£ã½ã„ï¼‰14:32
```

---

## 3. Webhooké€ä¿¡

### 3.1 ãƒªã‚¯ã‚¨ã‚¹ãƒˆå½¢å¼
```http
POST https://webhook.example.com/notify
Content-Type: application/json

{
  "text": "ğŸ“ 2F å»Šä¸‹ äººç‰©ã‚’æ¤œçŸ¥...",
  "camera_id": "cam_2f_19",
  "event_id": 123,
  "frame_uuid": "6b7f1e2a-...",
  "image_url": "https://camserver/media/frame/6b7f1e2a-...?exp=...&sig=...",
  "severity": 2,
  "primary_event": "human",
  "captured_at": "2025-12-28T18:59:12+09:00"
}
```

### 3.2 Slackäº’æ›å½¢å¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
```json
{
  "blocks": [
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "ğŸ“ *2F å»Šä¸‹* äººç‰©ã‚’æ¤œçŸ¥"
      }
    },
    {
      "type": "image",
      "image_url": "https://camserver/media/frame/...",
      "alt_text": "æ¤œçŸ¥ç”»åƒ"
    }
  ]
}
```

---

## 4. æ—¥æ¬¡è¦ç´„é€šçŸ¥

### 4.1 å®Ÿè¡Œæ™‚åˆ»
- æ¯æ—¥ 19:00 JST

### 4.2 é›†è¨ˆå†…å®¹
```sql
SELECT
  camera_id,
  primary_event,
  COUNT(*) as event_count,
  MAX(severity_max) as max_severity
FROM events
WHERE start_at >= CURDATE()
  AND start_at < CURDATE() + INTERVAL 1 DAY
GROUP BY camera_id, primary_event
ORDER BY max_severity DESC, event_count DESC;
```

### 4.3 è¦ç´„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
```
ğŸ“Š æœ¬æ—¥ã®ã‚«ãƒ¡ãƒ©ç›£è¦–ã‚µãƒãƒªãƒ¼ï¼ˆ12/28ï¼‰

ã€é‡è¦ã€‘
- 2F å»Šä¸‹: äººç‰©æ¤œçŸ¥ 5ä»¶ï¼ˆã†ã‚ã¤ã 2ä»¶ï¼‰
- ç„é–¢: å‹•ç‰©æ¤œçŸ¥ 3ä»¶ï¼ˆé¹¿ 2ä»¶ã€çŒª 1ä»¶ï¼‰

ã€é€šå¸¸ã€‘
- 1F ãƒ­ãƒ“ãƒ¼: äººç‰©æ¤œçŸ¥ 12ä»¶
- é§è»Šå ´: è»Šä¸¡æ¤œçŸ¥ 8ä»¶

ã€ã‚«ãƒ¡ãƒ©çŠ¶æ…‹ã€‘
- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³: ãªã—
- ç”»è§’ã‚ºãƒ¬: ãªã—

åˆè¨ˆã‚¤ãƒ™ãƒ³ãƒˆæ•°: 28ä»¶
```

---

## 5. Vision LLMã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

### 5.1 ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶
| æ¡ä»¶ | ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ |
|-----|-----------------|
| unknown_flag=true | â—‹ |
| severity >= 2 ã‹ã¤ confidence < 0.5 | â—‹ |
| ä¸Šè¨˜ä»¥å¤– | Ã— |

### 5.2 ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
- åŒä¸€ã‚«ãƒ¡ãƒ©: 10åˆ†
- ä»£è¡¨ãƒ•ãƒ¬ãƒ¼ãƒ ã®ã¿é€ä¿¡ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå˜ä½ã§1å›ï¼‰

### 5.3 ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
```json
{
  "model": "gemini-pro-vision",
  "contents": [
    {
      "parts": [
        {
          "text": "ã“ã®ç›£è¦–ã‚«ãƒ¡ãƒ©ç”»åƒã«ä½•ãŒå†™ã£ã¦ã„ã¾ã™ã‹ï¼Ÿäº‹å®Ÿã®ã¿ã‚’ç°¡æ½”ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚"
        },
        {
          "inline_data": {
            "mime_type": "image/jpeg",
            "data": "base64..."
          }
        }
      ]
    }
  ]
}
```

### 5.4 çµæœå‡¦ç†
- è¿”å´ãƒ†ã‚­ã‚¹ãƒˆã¯ã€Œèª¿æŸ»ãƒ¡ãƒ¢ã€ã¨ã—ã¦llm_reviewsã«ä¿å­˜
- æ–­å®šçš„è¡¨ç¾ã¯ä½¿ç”¨ã—ãªã„
- é€šçŸ¥ã«ã¯å«ã‚ãªã„ï¼ˆUIèª¿æŸ»ãƒ¢ãƒ¼ãƒ‰ã§ã®ã¿è¡¨ç¤ºï¼‰

---

## 6. ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³å®Ÿè£…

### 6.1 ãƒ¡ãƒ¢ãƒªç®¡ç†ï¼ˆåˆæœŸå®Ÿè£…ï¼‰
```rust
struct CooldownManager {
    cooldowns: HashMap<String, Instant>,
}

impl CooldownManager {
    fn key(kind: &str, camera_id: &str, event: &str) -> String {
        format!("{}:{}:{}", kind, camera_id, event)
    }

    fn is_ok(&self, kind: &str, camera_id: &str, event: &str, duration_sec: u64) -> bool {
        let key = Self::key(kind, camera_id, event);
        match self.cooldowns.get(&key) {
            Some(last) => last.elapsed() > Duration::from_secs(duration_sec),
            None => true,
        }
    }

    fn set(&mut self, kind: &str, camera_id: &str, event: &str) {
        let key = Self::key(kind, camera_id, event);
        self.cooldowns.insert(key, Instant::now());
    }
}
```

### 6.2 DBæ°¸ç¶šåŒ–ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
```sql
CREATE TABLE IF NOT EXISTS cooldowns (
  cooldown_key VARCHAR(255) NOT NULL,
  last_triggered_at DATETIME(3) NOT NULL,
  PRIMARY KEY (cooldown_key)
) ENGINE=InnoDB;

-- ç¢ºèª
SELECT 1 FROM cooldowns
WHERE cooldown_key = ?
  AND last_triggered_at > DATE_SUB(NOW(3), INTERVAL ? SECOND);

-- æ›´æ–°
INSERT INTO cooldowns (cooldown_key, last_triggered_at)
VALUES (?, NOW(3))
ON DUPLICATE KEY UPDATE last_triggered_at = NOW(3);
```

---

## 7. è¨­å®š

### 7.1 ç’°å¢ƒå¤‰æ•°
| å¤‰æ•° | èª¬æ˜ |
|-----|------|
| WEBHOOK_URL | é€šçŸ¥å…ˆURL |
| WEBHOOK_SECRET | HMACç½²åç”¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ |
| NOTIFY_COOLDOWN_SEC | é€šçŸ¥ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆç§’ï¼‰ |
| LLM_COOLDOWN_SEC | LLMã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆç§’ï¼‰ |
| DAILY_SUMMARY_HOUR | æ—¥æ¬¡è¦ç´„æ™‚åˆ»ï¼ˆJSTï¼‰ |
| GEMINI_API_KEY | Gemini APIã‚­ãƒ¼ |

### 7.2 settingsãƒ†ãƒ¼ãƒ–ãƒ«
```sql
INSERT INTO settings (setting_key, setting_json) VALUES
('notification', JSON_OBJECT(
  'webhook_url', 'https://...',
  'notify_cooldown_sec', 300,
  'llm_cooldown_sec', 600,
  'daily_summary_hour', 19
));
```

---

## 8. DBè¨˜éŒ²

### 8.1 notifications
```sql
INSERT INTO notifications (
  event_id, frame_id,
  channel, status, http_status, error_message,
  payload_json
) VALUES (?, ?, 'webhook', 'ok', 200, NULL, ?);
```

### 8.2 llm_reviews
```sql
INSERT INTO llm_reviews (
  frame_id, event_id,
  provider, model, request_id,
  status, error_message,
  request_json, response_json
) VALUES (?, ?, 'gemini', 'gemini-pro-vision', ?, 'ok', NULL, ?, ?);
```

---

## 9. ãƒ†ã‚¹ãƒˆè¦³ç‚¹

### 9.1 å³æ™‚é€šçŸ¥
- [ ] severity >= 2ã§é€šçŸ¥é€ä¿¡
- [ ] notify_allowedã‚¿ã‚°ã®ã¿ä½¿ç”¨
- [ ] ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³å†…ã¯é€šçŸ¥ã—ãªã„
- [ ] Webhookå¤±æ•—æ™‚ã®ãƒªãƒˆãƒ©ã‚¤

### 9.2 æ—¥æ¬¡è¦ç´„
- [ ] 19:00 JSTã«å®Ÿè¡Œ
- [ ] å½“æ—¥ã®ã‚¤ãƒ™ãƒ³ãƒˆé›†è¨ˆ
- [ ] é‡è¦åº¦é †ã‚½ãƒ¼ãƒˆ

### 9.3 LLMã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- [ ] unknown_flag=trueã§ãƒˆãƒªã‚¬ãƒ¼
- [ ] ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³å‹•ä½œ
- [ ] çµæœãŒllm_reviewsã«ä¿å­˜

### 9.4 ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
- [ ] investigation_onlyã‚¿ã‚°ãŒå«ã¾ã‚Œãªã„
- [ ] æ–­å®šçš„è¡¨ç¾ãŒãªã„
