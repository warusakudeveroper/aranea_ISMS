# LostCamTracker - DHCP追随によるカメラ自動復旧機能

## 概要

DHCPやネットワーク再構成によりIPアドレスが変更された登録カメラを自動検出し、IP追随によって復旧する機能。

---

## ⚠️ 重要な設計原則

### カメラへの負荷をかけない

**Tapo等の低処理性能カメラは、ONVIF/RTSPクレデンシャル認証の総当たりアクセスが来ると一時的にロスト（応答不能）になる問題がある。**

したがって、LostCamTrackerは以下の原則で設計する：

| 方式 | カメラ負荷 | 自動実行 | 説明 |
|------|-----------|----------|------|
| **ARPスキャン** | **なし** | ✅ 自動 | L2レベル、カメラに到達しない |
| **ARPスキャナデバイス** | **なし** | ✅ 自動 | is20s等からARP結果取得 |
| **カメラスキャン（フル）** | **高** | ❌ 手動のみ | ONVIF/RTSP認証試行あり |

### 自動 vs 手動の判定

```
┌─────────────────────────────────────────────────────────────┐
│                   LostCamTracker 動作判定                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ロストカメラ検出                                           │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ サブネット種別判定                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│         │                                                   │
│    ┌────┴────┬────────────────┐                            │
│    ▼         ▼                ▼                            │
│ ローカル   is20s管理      VPN越し/                         │
│ サブネット  サブネット     リモート                         │
│    │         │                │                            │
│    ▼         ▼                ▼                            │
│ ┌────────┐ ┌────────┐    ┌────────────────────┐          │
│ │ARP実行 │ │ARP API │    │ 自動実行しない     │          │
│ │(自動)  │ │(自動)  │    │ UI通知のみ         │          │
│ └────────┘ └────────┘    │「手動スキャン推奨」│          │
│    │         │           └────────────────────┘          │
│    └────┬────┘                                             │
│         ▼                                                   │
│  MAC照合 → IP更新 → EVENT LOG                             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**禁止事項:**
- LostCamTrackerからのONVIF Probe送信
- LostCamTrackerからのRTSP認証試行
- LostCamTrackerからのポートスキャン
- LostCamTrackerからのクレデンシャル総当たり

**ARPスキャンがカメラに負荷をかけない理由:**
- ARPはOSI Layer 2（データリンク層）で動作
- カメラのアプリケーション層（RTSPサーバ等）に到達しない
- カメラのCPU/メモリを消費しない
- ネットワークスタックの最下層で自動応答

---

## 背景・課題

- 多くのIPカメラはDHCP運用されており、ルーター再起動やリース期限切れでIPが変わる
- IPアドレス変更時、カメラが「Internal Error」となり映像取得不可になる
- 手動でのスキャン・再登録は運用負担が大きい
- 特に多メーカーIPカメラ混在環境では頻発する問題
- **Tapo等の低処理性能カメラは認証試行で一時ロストする**

---

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│                        is22 CamServer                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────┐    ┌──────────────────────────────────┐  │
│  │ PollingOrchestrator │   │      LostCamTracker Service     │  │
│  │                    │   │                                  │  │
│  │ カメラ死活監視     │──▶│ ・ロストカメラ検出              │  │
│  │ (15秒間隔)        │   │ ・閾値判定 (デフォルト30分)     │  │
│  └──────────────────┘   │ ・ARPスキャントリガー           │  │
│                          │ ・IP自動更新                     │  │
│                          │ ・イベントログ出力               │  │
│                          └──────────────────────────────────┘  │
│                                     │                           │
│                    ┌────────────────┴────────────────┐         │
│                    ▼                                 ▼         │
│           ┌──────────────┐              ┌──────────────────┐  │
│           │ローカルARP   │              │ARPスキャナ       │  │
│           │スキャン      │              │デバイス (is20s等)│  │
│           │              │              │                  │  │
│           │・軽量        │              │・リモート        │  │
│           │・カメラ負荷0 │              │ サブネット対応   │  │
│           │・自動実行    │              │・自動実行        │  │
│           └──────────────┘              └──────────────────┘  │
│                                                                 │
│  ※ VPN越し等ARP不可サブネットは手動カメラスキャンを促す       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 機能仕様

### 1. ロストカメラ検出

**条件:**
- `camera_status = 'error'` または `last_snapshot_at` が閾値を超えて古い
- `enabled = true` のカメラのみ対象

**閾値:**
- デフォルト: 30分
- 設定モーダルで変更可能（10分〜24時間）
- 0 = 機能無効

### 2. ARPスキャン（自動実行）

**対象サブネット判定:**

| サブネット種別 | ARP可能 | 自動実行 | 方法 |
|---------------|---------|----------|------|
| ローカル (192.168.125.0/24等) | ○ | ✅ 自動 | is22直接実行 |
| is20s管理サブネット | ○ | ✅ 自動 | is20s ARP API経由 |
| VPN越し・リモート | × | ❌ 手動 | ユーザーにカメラスキャン促す |

**ARPスキャンの特性:**
- **カメラ負荷ゼロ**: L2レベル、アプリケーション層に到達しない
- **超軽量**: ICMPなし、TCPなし、UDPなし
- **高速**: サブネット全体を1-2秒でスキャン可能
- **非侵入**: ファイアウォール・IDSに検知されにくい
- **MAC確実取得**: L2レベルで動作

### 3. ARPスキャナデバイス連携

**is20s等のARPスキャナデバイスからの取得形式:**

```json
["192.168.125.45,A842A1B95323", "192.168.126.30,DC62798D08EA"]
```

- シンプルな `"IP,MAC"` 形式の配列
- MACは正規化済み（大文字、セパレータなし）

**API例:**
```
GET http://192.168.125.248:8080/api/arp-cache
→ ["192.168.125.45,A842A1B95323", "192.168.125.62,DC62798D08EA", ...]
```

### 4. VPN越し等ARP不可サブネットの扱い

**自動実行しない。UI通知のみ:**

```
┌──────────────────────────────────────────────────────────────┐
│ ⚠️ Toj-Entrance (192.168.126.124) がロストしています        │
│                                                              │
│    このカメラはARPスキャン対象外のサブネットにあります。    │
│    IPアドレス変更を確認するには「カメラスキャン」を         │
│    実行してください。                                        │
│                                                              │
│    [カメラスキャンを開く]                                    │
└──────────────────────────────────────────────────────────────┘
```

---

## IP自動更新フロー

```
┌─────────────┐
│ロストカメラ │
│検出         │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────┐
│閾値経過？                        │
│(last_error_at > 30分前)          │
└──────┬──────────────────────────┘
       │ Yes
       ▼
┌─────────────────────────────────┐
│サブネット種別判定                │
└──────┬──────────────────────────┘
       │
   ┌───┴───┬─────────────┐
   │       │             │
   ▼       ▼             ▼
 ローカル  is20s管理   VPN越し
   │       │             │
   ▼       ▼             ▼
 ARP実行   ARP API    UI通知のみ
   │       │          (手動促す)
   └───┬───┘
       │
       ▼
┌─────────────────────────────────┐
│ARPスキャン済みフラグ確認         │
│(arp_scan_attempted_at)           │
└──────┬──────────────────────────┘
       │ 未実施 or 1時間経過
       ▼
┌─────────────────────────────────┐
│ARPスキャン実行                   │
│※ カメラへのアクセスなし        │
└──────┬──────────────────────────┘
       │
       ▼
┌─────────────────────────────────┐
│MAC照合                           │
│lacis_id[4:16] vs ARP結果         │
└──────┬──────────────────────────┘
       │ マッチ
       ▼
┌─────────────────────────────────┐
│IP自動更新                        │
│cameras.ip_address                │
│cameras.rtsp_main/sub             │
└──────┬──────────────────────────┘
       │
       ▼
┌─────────────────────────────────┐
│AI EVENT LOG出力                  │
│「IPアドレスの変更を追跡          │
│  しました。192.168.125.45」      │
└─────────────────────────────────┘
```

---

## 再スキャン抑制フラグ

**目的:** ロストしっぱなしのカメラで無限ループ防止

**フラグ設計:**

```sql
ALTER TABLE cameras ADD COLUMN arp_scan_attempted_at DATETIME NULL;
ALTER TABLE cameras ADD COLUMN arp_scan_result VARCHAR(50) NULL;
-- 'found_updated', 'not_found', 'subnet_unreachable', 'arp_not_supported'
```

**再スキャン条件:**
- `arp_scan_attempted_at` が NULL または 1時間以上経過
- カメラ状態が再度正常→エラーに遷移した場合はリセット

**抑制ロジック:**
```
if arp_scan_attempted_at is NULL:
    → スキャン実行
elif now - arp_scan_attempted_at > 1 hour:
    → スキャン実行（リトライ）
elif arp_scan_result == 'not_found':
    → スキップ（UI通知のみ）
else:
    → スキップ
```

---

## 設定UI

### 設定モーダル（カメラ管理タブ）

```
┌─────────────────────────────────────────────────────────────────┐
│  📷 カメラ自動復旧設定                                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  □ DHCPなどによる登録カメラロストに追随する                     │
│                                                                 │
│    検出閾値: [  30  ] 分  (カメラ異常から自動スキャンまでの時間)│
│                                                                 │
│    リトライ間隔: [  60  ] 分  (見つからない場合の再試行間隔)   │
│                                                                 │
│    ℹ️ ARPスキャンのみ使用（カメラに負荷をかけません）           │
│    ℹ️ VPN越しサブネットは手動カメラスキャンが必要です          │
│                                                                 │
│  ──────────────────────────────────────────────────────────────│
│                                                                 │
│  現在のロストカメラ: 2台                                        │
│  ┌────────────────────────────────────────────────────────┐    │
│  │ ⚠️ Tam-StorageArea (192.168.125.78)                    │    │
│  │    最終正常: 2026-01-15 10:30                          │    │
│  │    ARPスキャン: 未実施                                  │    │
│  │    サブネット: ローカル ✅ 自動追跡対象                 │    │
│  ├────────────────────────────────────────────────────────┤    │
│  │ ⚠️ Toj-VPN-Camera (10.8.0.45)                          │    │
│  │    最終正常: 2026-01-15 09:00                          │    │
│  │    サブネット: VPN越し ❌ 手動スキャン必要             │    │
│  │    [カメラスキャンを開く]                               │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## AI EVENT LOG表示

### IP変更追跡成功時

```json
{
  "event_type": "camera_ip_relocated",
  "camera_id": "cam-8d928bd9-be87-4b11-a06e-859ac94d4a0b",
  "camera_name": "Tam-StorageArea",
  "old_ip": "192.168.125.78",
  "new_ip": "192.168.125.45",
  "detection_method": "arp_scan",
  "message": "IPアドレスの変更を追跡しました。192.168.125.45"
}
```

### UI表示

```
┌──────────────────────────────────────────────┐
│ 📍 Tam-StorageArea                  13:07:56 │
│    IPアドレスの変更を追跡しました            │
│    192.168.125.78 → 192.168.125.45           │
└──────────────────────────────────────────────┘
```

---

## 負荷評価

### ARPスキャン（カメラ負荷: ゼロ）

| 項目 | 値 |
|------|-----|
| パケット数 | 254パケット (/24サブネット) |
| 所要時間 | 1-3秒 |
| 帯域使用 | 約10KB |
| **カメラCPU負荷** | **0%（到達しない）** |
| is22 CPU負荷 | 無視できるレベル |
| 実行頻度 | ロストカメラ発生時のみ |

### カメラスキャン（参考・手動のみ）

| 項目 | 値 |
|------|-----|
| パケット数 | 254 × ポート数 (数千〜数万) |
| 所要時間 | 30秒〜数分 |
| 帯域使用 | 数MB |
| **カメラCPU負荷** | **高（認証試行あり）** |

**→ カメラスキャンはLostCamTrackerでは使用しない**

---

## データベース変更

### cameras テーブル追加カラム

```sql
-- Migration: 026_lost_cam_tracker.sql

ALTER TABLE cameras ADD COLUMN arp_scan_attempted_at DATETIME NULL;
ALTER TABLE cameras ADD COLUMN arp_scan_result VARCHAR(50) NULL;
ALTER TABLE cameras ADD COLUMN last_healthy_at DATETIME NULL;
ALTER TABLE cameras ADD COLUMN ip_relocation_count INT DEFAULT 0;
```

### config テーブル（設定保存）

```sql
-- lost_cam_tracker設定
INSERT INTO config (key, value) VALUES
  ('lost_cam_tracker_enabled', 'true'),
  ('lost_cam_tracker_threshold_minutes', '30'),
  ('lost_cam_tracker_retry_minutes', '60');
```

---

## API設計

### GET /api/lost-cameras

ロストカメラ一覧取得

```json
{
  "ok": true,
  "data": [
    {
      "camera_id": "cam-xxx",
      "name": "Tam-StorageArea",
      "ip_address": "192.168.125.78",
      "last_healthy_at": "2026-01-15T10:30:00Z",
      "error_duration_minutes": 45,
      "arp_scan_attempted_at": null,
      "arp_scan_result": null,
      "subnet_type": "local",
      "auto_track_supported": true
    },
    {
      "camera_id": "cam-yyy",
      "name": "Toj-VPN-Camera",
      "ip_address": "10.8.0.45",
      "last_healthy_at": "2026-01-15T09:00:00Z",
      "error_duration_minutes": 120,
      "arp_scan_attempted_at": null,
      "arp_scan_result": null,
      "subnet_type": "remote",
      "auto_track_supported": false
    }
  ]
}
```

### POST /api/lost-cameras/{camera_id}/arp-scan

手動ARPスキャントリガー（ローカル/is20sサブネットのみ）

```json
// Response
{
  "ok": true,
  "data": {
    "result": "found_updated",
    "old_ip": "192.168.125.78",
    "new_ip": "192.168.125.45",
    "message": "IPアドレスの変更を追跡しました。192.168.125.45"
  }
}
```

### PUT /api/config/lost-cam-tracker

設定更新

```json
{
  "enabled": true,
  "threshold_minutes": 30,
  "retry_minutes": 60
}
```

---

## 実装タスク

### Phase 1: 基盤実装

- [ ] T1-1: DB Migration (026_lost_cam_tracker.sql)
- [ ] T1-2: LostCamTrackerService 構造体作成
- [ ] T1-3: ARPスキャン実行モジュール (arp-scan wrapper)
- [ ] T1-4: MAC照合ロジック（正規化比較）
- [ ] T1-5: IP自動更新処理（既存 `update_camera_ip` 活用）

### Phase 2: 自動検出・復旧

- [ ] T2-1: ロストカメラ検出ロジック
- [ ] T2-2: 閾値判定・スキャントリガー
- [ ] T2-3: 再スキャン抑制フラグ管理
- [ ] T2-4: 定期実行タスク（5分間隔チェック）
- [ ] T2-5: サブネット種別判定（自動追跡可否）

### Phase 3: API・UI

- [ ] T3-1: GET /api/lost-cameras エンドポイント
- [ ] T3-2: POST /api/lost-cameras/{id}/arp-scan エンドポイント
- [ ] T3-3: PUT /api/config/lost-cam-tracker エンドポイント
- [ ] T3-4: 設定モーダルUI実装
- [ ] T3-5: AI EVENT LOG統合
- [ ] T3-6: VPN越しサブネット用UI通知

### Phase 4: ARPスキャナデバイス連携

- [ ] T4-1: is20s ARP API設計
- [ ] T4-2: is22からis20s ARP API呼び出し
- [ ] T4-3: ARPスキャナデバイス登録UI

---

## 関連ドキュメント

- [ARP_Scan_Technical_Spec.md](./ARP_Scan_Technical_Spec.md) - ARPスキャン技術仕様
- [is22_ScanModal_LacisID_SSoT.md](../Paraclate/is22_ScanModal_LacisID_SSoT.md) - lacisID SSoT設計
- [MAC正規化比較実装](../../is22/src/ipcam_scan/mod.rs) - sync_camera_ips_by_mac()

---

## 変更履歴

| 日付 | 版 | 内容 |
|------|-----|------|
| 2026-01-16 | 1.0 | 初版作成 |
| 2026-01-16 | 1.1 | カメラ負荷ゼロ設計原則を明記、ARPスキャナデバイス形式追加 |
