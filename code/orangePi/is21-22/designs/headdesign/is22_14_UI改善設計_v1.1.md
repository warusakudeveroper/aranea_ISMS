# IS22 UI改善設計書 v1.1

文書番号: is22_14
作成日: 2026-01-02
ステータス: 設計確定
関連Issue: -

---

## 0. 本書の目的

スキャンモーダル・カメラグリッドのUX改善要件を定義し、実装・テストの基準とする。

**変更理由**:
- スキャン結果がモーダル閉じで消失する問題
- スキャン完了時のフィードバック不足
- カメラグリッド表示情報の明確化

---

## 1. スキャン結果永続化

### 1.1 要件

| 項目 | 内容 |
|------|------|
| 目的 | モーダルを閉じても前回スキャン結果を保持・呼び出し可能にする |
| 保存先 | LocalStorage (`is22_lastScanResult`) |
| 保存内容 | 発見デバイス一覧、スキャン日時、対象サブネット |
| 有効期間 | 24時間（期限切れは自動クリア） |

### 1.2 保存データ構造

```typescript
interface CachedScanResult {
  timestamp: string;          // ISO8601
  expiry: string;             // ISO8601 (timestamp + 24h)
  subnets: string[];          // スキャン対象サブネット
  devices: ScannedDevice[];   // 発見デバイス一覧
  summary: {
    total_ips: number;
    hosts_alive: number;
    cameras_found: number;
    cameras_verified: number;
  };
}
```

### 1.3 UI動作

| シナリオ | 動作 |
|----------|------|
| モーダル開く（キャッシュあり） | 「前回スキャン結果を表示」ボタン表示 |
| モーダル開く（キャッシュなし） | 通常のサブネット選択画面 |
| スキャン完了 | 自動でLocalStorageに保存 |
| 24時間経過 | 次回モーダル表示時に自動クリア |

### 1.4 UI表示

```
┌──────────────────────────────────────────────────┐
│  🔍 カメラスキャン                            [×] │
├──────────────────────────────────────────────────┤
│                                                  │
│  ┌────────────────────────────────────────────┐  │
│  │ 💾 前回スキャン結果があります               │  │
│  │    2026-01-02 15:30 | 63台検出              │  │
│  │    192.168.125.0/24, 192.168.126.0/24      │  │
│  │                                            │  │
│  │   [前回結果を表示]  [新規スキャン]           │  │
│  └────────────────────────────────────────────┘  │
│                                                  │
│  ─────────── または ───────────                  │
│                                                  │
│  スキャン対象サブネット（複数選択可）             │
│  ...                                             │
└──────────────────────────────────────────────────┘
```

---

## 2. ヘッダーUI変更

### 2.1 変更内容

| 項目 | 変更前 | 変更後 |
|------|--------|--------|
| スキャンボタン | 「🔍 スキャン」ボタン表示 | **削除** |

### 2.2 理由

- スキャン機能はカメラ追加フローの一部であり、ヘッダーに独立ボタンとして存在する必要がない
- カメラグリッドのブランクカードまたは追加ボタンからアクセスで十分

### 2.3 ヘッダー構成（変更後）

```
┌─────────────────────────────────────────────────────────────────────┐
│ 🎬 mobes AIcam control Tower  mAcT  │  CPU 0.3%  MEM 7.1%  Modals 0/35  Healthy  │  ⚙️ │
└─────────────────────────────────────────────────────────────────────┘
```

| 要素 | 内容 | 位置 |
|------|------|------|
| ロゴ | ビデオアイコン | 左 |
| タイトル | mobes AIcam control Tower | 左 |
| バッジ | mAcT | タイトル横 |
| システムステータス | CPU/MEM/Modals/Healthy | 右 |
| 設定ボタン | 歯車アイコン | 右端 |

---

## 3. ブランクカード・カメラ追加ボタン変更

### 3.1 変更内容

| 項目 | 変更前 | 変更後 |
|------|--------|--------|
| ブランクカードボタン | 「＋ カメラを追加」 | 「🔍 カメラをスキャン」 |
| カメラ存在時の追加ボタン | 「＋ カメラを追加」 | 「🔍 カメラをスキャン」 |

### 3.2 ブランクカード（変更後）

```
┌─────────────────────────────────────┐
│         [カメラアイコン]              │
│                                     │
│    カメラが登録されていません          │
│                                     │
│   ┌─────────────────────────────┐   │
│   │  🔍 カメラをスキャン         │   │  ← クリックでスキャンモーダル
│   └─────────────────────────────┘   │
│                                     │
│   ONVIF / RTSP対応カメラを自動検出   │
└─────────────────────────────────────┘
```

---

## 4. 発見カメラのスタック表示

### 4.1 要件

スキャン中、発見されたカメラをログウィンドウの上にスタック表示する。

### 4.2 表示形式

```
登録可能なカメラ  192.168.125.78  TP-Link  Tapo C100  {cameraname}
```

**表示要素**:
| 要素 | 内容 | 必須 |
|------|------|------|
| ラベル | 「登録可能なカメラ」 | ○ |
| IPアドレス | 192.168.XX.XX | ○ |
| メーカー | TP-Link, Axis等 | ○ |
| モデル | Tapo C100, VIGI C340等 | △（取得可能な場合）|
| カメラ名 | 識別名（未設定の場合は省略）| △ |

### 4.3 UI配置

```
┌──────────────────────────────────────────────────┐
│  🔍 カメラスキャン - スキャン中                [×] │
├──────────────────────────────────────────────────┤
│                                                  │
│  [レーダーアニメーション]                          │
│                                                  │
│  ネットワークをスキャン中... 35%                   │
│                                                  │
│  [Phase表示]                                      │
│  ────────────────────────────────────────        │
│                                                  │
│  ┌─ 登録可能なカメラ ──────────────────────────┐  │
│  │ ✅ 192.168.125.78  TP-Link  Tapo C100       │  │  ← 新規追加
│  │ ✅ 192.168.125.85  TP-Link  Tapo C110       │  │
│  │ ✅ 192.168.126.27  TP-Link  Tapo C100       │  │
│  └─────────────────────────────────────────────┘  │
│                                                  │
│  [スキャン詳細ログ]                               │
│  ┌────────────────────────────────────────────┐  │
│  │ 12:34:56 192.168.125.1  - ARP応答あり      │  │
│  │ 12:34:56 192.168.125.78 - Port 554 open    │  │
│  │ 12:34:57 192.168.125.78 - OUI: TP-Link     │  │
│  │ ...                                        │  │
│  └────────────────────────────────────────────┘  │
│                                                  │
│  検出デバイス: 5台                               │
│                                                  │
└──────────────────────────────────────────────────┘
```

### 4.4 表示条件

| 条件 | 動作 |
|------|------|
| credential_status === 'success' | 「登録可能なカメラ」に追加 |
| device_type === 'camera_confirmed' かつ credential_status !== 'failed' | 「登録可能なカメラ」に追加 |
| その他 | ログウィンドウのみに表示 |

---

## 5. スキャン完了フロー

### 5.1 フロー概要

```
スキャン完了 → フェード → サマリー表示 → フェード → 登録画面へ遷移
```

**目的**: 情報の正しさを伝えるフィードバック
- スキャン中 → 発見したものをちゃんと処理している → スキャン完了をわかりやすく
- サマリーを表示（検出結果を適切に使っている安心感）→ 登録の画面へ

### 5.2 フェーズ詳細

#### Phase A: スキャン完了表示（2秒）

```
┌──────────────────────────────────────────────────┐
│  🔍 カメラスキャン                            [×] │
├──────────────────────────────────────────────────┤
│                                                  │
│                   ✅                              │
│                                                  │
│              スキャン完了                         │
│                                                  │
│         63台のデバイスを検出しました              │
│                                                  │
└──────────────────────────────────────────────────┘
```

**表示時間**: 2秒
**アニメーション**: フェードイン (opacity 0→1, 300ms)

#### Phase B: フェードトランジション（500ms）

**アニメーション**: フェードアウト/イン

#### Phase C: サマリー表示（3秒）

```
┌──────────────────────────────────────────────────┐
│  🔍 カメラスキャン - スキャン結果              [×] │
├──────────────────────────────────────────────────┤
│                                                  │
│  📊 スキャンサマリー                             │
│                                                  │
│  ┌────────────────────────────────────────────┐  │
│  │                                            │  │
│  │   スキャン対象: 512 IP (2サブネット)         │  │
│  │   応答ホスト:   63台                        │  │
│  │   カメラ検出:   42台                        │  │
│  │   認証成功:     38台                        │  │
│  │                                            │  │
│  │   ──────────────────────────────           │  │
│  │                                            │  │
│  │   🟢 登録可能: 38台                         │  │
│  │   🟡 認証必要:  4台                         │  │
│  │   ⚪ その他:   21台                         │  │
│  │                                            │  │
│  └────────────────────────────────────────────┘  │
│                                                  │
│         登録画面へ進みます...                     │
│                                                  │
└──────────────────────────────────────────────────┘
```

**表示時間**: 3秒
**下部**: プログレスバーまたはカウントダウン表示

#### Phase D: 登録画面へ遷移

既存の「登録候補表示」画面（IS22_UI_DETAILED_SPEC Section 3.3）へ遷移

---

## 6. カメラグリッド表示要件

### 6.1 カメラタイル表示項目

| 項目 | 表示位置 | 必須 | データソース |
|------|----------|------|--------------|
| サムネイル | タイル上部 | ○ | snapshot_url |
| カメラ名 | サムネイル下 | ○ | name |
| IPアドレス | カメラ名下 | ○ | ip_address |
| モデル名 | IPアドレス下 | ○ | model (fallback: manufacturer, family) |
| 施設名+fid | モデル名下 | ○ | location + fid |
| 最終更新 | タイル右下 | ○ | updated_at (相対時間) |
| ステータスバッジ | タイル右上 | ○ | enabled + last_verified_at |

### 6.2 カメラタイル構造

```
┌─────────────────────────────────────┐
│ [サムネイル画像]               🟢  │  ← ステータスバッジ
│                                     │
├─────────────────────────────────────┤
│ フロント玄関カメラ                   │  ← カメラ名
│ 192.168.125.78                      │  ← IPアドレス
│ Tapo C100                           │  ← モデル名
│ HALE京都丹波口 (0150)               │  ← 施設名 + fid
│                          3分前 更新  │  ← 最終更新
└─────────────────────────────────────┘
```

### 6.3 表示フォールバック

| 項目 | 優先順位1 | 優先順位2 | 優先順位3 | 最終フォールバック |
|------|-----------|-----------|-----------|-------------------|
| カメラ名 | name | model | - | Camera-{IP末尾} |
| モデル名 | model | manufacturer | family | Unknown |
| 施設名 | location | subnet | - | 不明 |

### 6.4 ステータスバッジ

| 状態 | バッジ | 条件 |
|------|--------|------|
| オンライン | 🟢 | enabled && last_verified_at が5分以内 |
| オフライン | 🔴 | enabled && last_verified_at が5分超過 |
| 無効 | ⚪ | !enabled |

---

## 7. 実装チェックリスト

### 7.1 バックエンド（変更なし）

既存APIで対応可能。追加実装不要。

### 7.2 フロントエンド

| ID | 項目 | ファイル | 状態 |
|----|------|----------|------|
| FE-001 | スキャン結果LocalStorage保存 | ScanModal.tsx | 未実装 |
| FE-002 | 前回結果表示UI | ScanModal.tsx | 未実装 |
| FE-003 | ヘッダースキャンボタン削除 | App.tsx | 未実装 |
| FE-004 | ブランクカードボタン文言変更 | CameraGrid.tsx | 未実装 |
| FE-005 | 登録可能カメラスタック表示 | ScanModal.tsx | 未実装 |
| FE-006 | スキャン完了フロー実装 | ScanModal.tsx | 未実装 |
| FE-007 | カメラタイル表示項目追加 | CameraTile.tsx | 未実装 |

---

## 8. テスト項目

### 8.1 スキャン結果永続化

| ID | テスト内容 | 期待結果 |
|----|-----------|---------|
| PERSIST-001 | スキャン完了後にLocalStorageを確認 | `is22_lastScanResult`にデータ保存 |
| PERSIST-002 | モーダル閉じて再度開く | 「前回結果を表示」ボタン表示 |
| PERSIST-003 | 「前回結果を表示」クリック | 保存されたデバイス一覧表示 |
| PERSIST-004 | 24時間後にモーダル開く | キャッシュクリア、通常画面表示 |

### 8.2 UI変更

| ID | テスト内容 | 期待結果 |
|----|-----------|---------|
| UI-001 | ヘッダー確認 | スキャンボタンが存在しない |
| UI-002 | カメラ0件時ブランクカード | 「🔍 カメラをスキャン」ボタン表示 |
| UI-003 | ブランクカードボタンクリック | スキャンモーダル表示 |

### 8.3 スキャン完了フロー

| ID | テスト内容 | 期待結果 |
|----|-----------|---------|
| FLOW-001 | スキャン完了後の表示 | 「スキャン完了」表示（2秒） |
| FLOW-002 | 完了表示後 | サマリー表示（3秒） |
| FLOW-003 | サマリー表示後 | 登録画面へ自動遷移 |
| FLOW-004 | フロー中の×ボタン | 確認ダイアログ表示 |

### 8.4 カメラグリッド

| ID | テスト内容 | 期待結果 |
|----|-----------|---------|
| GRID-001 | カメラタイル表示 | IP/モデル/施設名/最終更新が表示される |
| GRID-002 | ステータスバッジ | オンライン/オフライン/無効が正しく表示 |
| GRID-003 | フォールバック表示 | model未設定時にmanufacturerが表示 |

---

## 9. 影響範囲

### 9.1 変更ファイル

| ファイル | 変更内容 |
|----------|---------|
| `frontend/src/components/ScanModal.tsx` | 結果永続化、スタック表示、完了フロー |
| `frontend/src/components/CameraGrid.tsx` | ブランクカードボタン文言 |
| `frontend/src/components/CameraTile.tsx` | 表示項目追加 |
| `frontend/src/App.tsx` | ヘッダースキャンボタン削除 |

### 9.2 新規ファイル

なし

### 9.3 バックエンド変更

なし（既存APIで対応可能）

---

## 10. 更新履歴

| 日付 | バージョン | 内容 |
|------|-----------|------|
| 2026-01-02 | 1.0 | 初版作成 |
| 2026-01-02 | 1.1 | カメラグリッド表示要件追加 |
