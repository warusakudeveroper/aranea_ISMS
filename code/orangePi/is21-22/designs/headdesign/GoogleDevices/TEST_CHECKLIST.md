# GoogleDevices (SDM/Nest統合) テストチェックリスト

## 基本情報

| 項目 | 内容 |
|------|------|
| プロジェクト | is22 RTSPカメラ総合管理サーバー |
| 機能名 | Google Nest Doorbell SDM統合 |
| 作成日 | 2026-01-07 |
| テスト環境 | http://192.168.125.246:3000 |
| 関連タスク | TASK_INDEX.md Phase 6-7 |

---

## テストカテゴリ

1. **バックエンド単体テスト** (Rust)
2. **バックエンド統合テスト** (API + Mock)
3. **フロントエンドコンポーネントテスト** (React)
4. **E2Eテスト** (Chrome実UI/UX)
5. **セキュリティテスト** (secrets, RBAC, CSRF)
6. **非機能テスト** (長時間運用, 性能)
7. **退行テスト** (既存機能への影響)

---

## 1. バックエンド単体テスト (Rust)

### 1.1 sdm_config バリデーション

| ID | テスト項目 | 期待結果 | PASS | 備考 |
|----|------------|----------|------|------|
| BE-1-1 | project_id必須チェック | 空文字で400エラー | | |
| BE-1-2 | enterprise_project_id必須チェック | 空文字で400エラー | | |
| BE-1-3 | client_id必須チェック | 空文字で400エラー | | |
| BE-1-4 | client_secret必須チェック | 空文字で400エラー | | |
| BE-1-5 | refresh_token空文字は「変更なし」 | 既存値維持 | | |
| BE-1-6 | 不正JSON形式 | 400エラー | | |

### 1.2 token交換エラー分岐

| ID | テスト項目 | 期待結果 | PASS | 備考 |
|----|------------|----------|------|------|
| BE-2-1 | auth_code有効→refresh_token取得成功 | 200 + has_refresh_token:true | | |
| BE-2-2 | auth_code無効(401) | status=error, error_reason設定 | | |
| BE-2-3 | redirect_uri不一致(400) | 適切なエラーメッセージ | | |
| BE-2-4 | Google疎通失敗(5xx) | 500エラー + ログ出力 | | |
| BE-2-5 | 指数バックオフ(1s,5s,30s) | 3回リトライ後にerror遷移 | | |

### 1.3 トークンライフサイクル

| ID | テスト項目 | 期待結果 | PASS | 備考 |
|----|------------|----------|------|------|
| BE-3-1 | status: not_configured→configured_pending_auth | client_secret保存後に遷移 | | |
| BE-3-2 | status: configured_pending_auth→authorized | refresh_token取得後に遷移 | | |
| BE-3-3 | status: authorized→error (401) | refresh_token失効で即時遷移 | | |
| BE-3-4 | status: error→authorized (再認可) | 新refresh_token保存で復旧 | | |
| BE-3-5 | 429 quota超過 | statusはerrorにしない、10分待機 | | |

### 1.4 devices.list正規化

| ID | テスト項目 | 期待結果 | PASS | 備考 |
|----|------------|----------|------|------|
| BE-4-1 | Doorbellデバイス正常取得 | type/name/structure/traits返却 | | |
| BE-4-2 | 0件デバイス | 空配列返却（エラーではない） | | |
| BE-4-3 | SDM API 401 | status=error遷移 | | |
| BE-4-4 | SDM API 429 | エラーカウント増、status維持 | | |
| BE-4-5 | quota保護(1分/1回) | 連続呼び出しで429返却 | | |

### 1.5 RBAC/CSRF

| ID | テスト項目 | 期待結果 | PASS | 備考 |
|----|------------|----------|------|------|
| BE-5-1 | 管理者以外のアクセス | 403エラー | | |
| BE-5-2 | CSRFトークンなし(Cookie運用時) | 403エラー | | |
| BE-5-3 | 有効なCSRFトークン | 正常処理 | | |

---

## 2. バックエンド統合テスト (API + Mock)

### 2.1 設定保存・取得フロー

| ID | テスト項目 | 期待結果 | PASS | 備考 |
|----|------------|----------|------|------|
| INT-1-1 | PUT /api/sdm/config → GET /api/sdm/config | 保存値が取得できる（secrets除く） | | |
| INT-1-2 | client_secret/refresh_tokenが返却されない | has_refresh_token:boolのみ | | |
| INT-1-3 | 空文字更新で既存値維持 | refresh_token空→既存維持 | | |

### 2.2 認可コード交換フロー

| ID | テスト項目 | 期待結果 | PASS | 備考 |
|----|------------|----------|------|------|
| INT-2-1 | POST /api/sdm/exchange-code (正常) | refresh_token保存、status=authorized | | |
| INT-2-2 | POST /api/sdm/exchange-code (無効code) | 400エラー、status=error | | |

### 2.3 カメラ登録フロー

| ID | テスト項目 | 期待結果 | PASS | 備考 |
|----|------------|----------|------|------|
| INT-3-1 | POST /api/sdm/devices/:id/register (正常) | cameras INSERT + go2rtc登録 + cache refresh | | |
| INT-3-2 | camera_id重複 | 409エラー | | |
| INT-3-3 | sdm_device_id重複 | 409エラー | | |
| INT-3-4 | go2rtc登録失敗 | DBロールバック、502エラー | | |
| INT-3-5 | 登録後 enabled=true | PollingOrchestrator巡回対象に追加 | | |

### 2.4 Reconcileフロー

| ID | テスト項目 | 期待結果 | PASS | 備考 |
|----|------------|----------|------|------|
| INT-4-1 | go2rtcに存在しないNestカメラ | add_source呼び出し | | |
| INT-4-2 | 既に存在するカメラ | スキップ（冪等） | | |
| INT-4-3 | add_source失敗 | warnログ、次周期で再試行 | | |

### 2.5 テストAPI

| ID | テスト項目 | 期待結果 | PASS | 備考 |
|----|------------|----------|------|------|
| INT-5-1 | GET /api/sdm/test/go2rtc-version | version, compatible返却 | | |
| INT-5-2 | v1.9.9未満の場合 | compatible:false | | |
| INT-5-3 | GET /api/sdm/test/token | 200/401/429を色分け | | |
| INT-5-4 | GET /api/sdm/test/device/:id | traits取得可否 | | |

---

## 3. フロントエンドコンポーネントテスト (React)

### 3.1 状態表示

| ID | テスト項目 | 期待結果 | PASS | 備考 |
|----|------------|----------|------|------|
| FE-1-1 | NotConfigured状態 | 「はじめる」ボタン表示 | | |
| FE-1-2 | ConfiguredPendingAuth状態 | 「認可URLを開く」ボタン表示 | | |
| FE-1-3 | Authorized状態 | 「デバイス一覧を取得」ボタン表示 | | |
| FE-1-4 | Error状態 | 「再認可する」ボタン + エラー文言 | | |

### 3.2 ウィザードStep1: 概要・必要なもの

| ID | テスト項目 | 期待結果 | PASS | 備考 |
|----|------------|----------|------|------|
| FE-2-1 | チェックボックス未完了 | 「次へ」非活性 | | |
| FE-2-2 | 全チェック完了 | 「次へ」活性化 | | |
| FE-2-3 | $5課金注意表示 | 赤字で表示 | | |

### 3.3 ウィザードStep2: SDM設定入力

| ID | テスト項目 | 期待結果 | PASS | 備考 |
|----|------------|----------|------|------|
| FE-3-1 | 必須項目未入力 | 保存ボタン非活性 | | |
| FE-3-2 | 全必須項目入力 | 保存ボタン活性化 | | |
| FE-3-3 | 保存成功 | 「保存しました」フィードバック | | |
| FE-3-4 | client_secretマスク入力 | パスワード形式で非表示 | | |

### 3.4 ウィザードStep3: 認可コード取得

| ID | テスト項目 | 期待結果 | PASS | 備考 |
|----|------------|----------|------|------|
| FE-4-1 | 認可URL生成 | URLコピーボタン表示 | | |
| FE-4-2 | 「ブラウザで開く」ボタン | 別タブで開く | | |
| FE-4-3 | code入力・交換成功 | Step4へ遷移 | | |
| FE-4-4 | code交換失敗(401) | エラーメッセージ表示 | | |

### 3.5 ウィザードStep4: デバイス一覧

| ID | テスト項目 | 期待結果 | PASS | 備考 |
|----|------------|----------|------|------|
| FE-5-1 | デバイス取得成功 | テーブル表示 | | |
| FE-5-2 | 0件デバイス | チェックリスト表示 | | |
| FE-5-3 | 行ごとに「登録する」ボタン | クリック可能 | | |

### 3.6 ウィザードStep5: 登録ダイアログ

| ID | テスト項目 | 期待結果 | PASS | 備考 |
|----|------------|----------|------|------|
| FE-6-1 | camera_id自動提案 | `nest-<短縮device_id>` | | |
| FE-6-2 | camera_idバリデーション | 英小文字/数字/ハイフンのみ | | |
| FE-6-3 | fid/tid必須 | 未選択で送信不可 | | |
| FE-6-4 | 登録成功 | Step6へ遷移 | | |
| FE-6-5 | 409重複エラー | エラーメッセージ表示 | | |

### 3.7 ウィザードStep6: 接続確認

| ID | テスト項目 | 期待結果 | PASS | 備考 |
|----|------------|----------|------|------|
| FE-7-1 | snapshotプレビュー成功 | 緑バッジ「つながりました」 | | |
| FE-7-2 | snapshotプレビュー失敗 | 赤バッジ + 再試行ボタン | | |
| FE-7-3 | 「完了」ボタン | ウィザード終了 | | |

### 3.8 高度な設定パネル

| ID | テスト項目 | 期待結果 | PASS | 備考 |
|----|------------|----------|------|------|
| FE-8-1 | go2rtcバージョン表示 | 1.9.9以上で緑、未満で赤 | | |
| FE-8-2 | tokenテスト | 200緑、401/403赤、429黄 | | |
| FE-8-3 | デバイス疎通テスト | 成功/失敗表示 | | |

---

## 4. E2Eテスト (Chrome実UI/UX)

### 4.1 ウィザード通し操作

| ID | テスト項目 | 操作 | 期待結果 | PASS | 備考 |
|----|------------|------|----------|------|------|
| E2E-1-1 | 設定モーダル開く | ヘッダSettings→Google/Nestタブ | タブ表示 | | |
| E2E-1-2 | Step1→Step2 | チェック完了→次へ | Step2表示 | | |
| E2E-1-3 | Step2保存 | 設定入力→保存 | フィードバック表示 | | |
| E2E-1-4 | Step3認可 | 認可URL開く→code貼付→交換 | Step4へ遷移 | | |
| E2E-1-5 | Step4デバイス取得 | デバイス取得ボタン | テーブル表示 | | |
| E2E-1-6 | Step5登録 | 登録ダイアログ入力→送信 | Step6へ遷移 | | |
| E2E-1-7 | Step6確認 | プレビュー表示 | 緑バッジ | | |
| E2E-1-8 | CameraGrid反映 | 完了後メイン画面 | 登録カメラ表示 | | |

### 4.2 エラーリカバリ

| ID | テスト項目 | 操作 | 期待結果 | PASS | 備考 |
|----|------------|------|----------|------|------|
| E2E-2-1 | refresh_token失効→再認可 | 401発生→再認可フロー | 復旧 | | |
| E2E-2-2 | go2rtc停止→reconcile復旧 | go2rtc再起動 | 自動復旧(<5分) | | |
| E2E-2-3 | 無効code入力 | Step3でエラーcode | エラーメッセージ | | |

### 4.3 ナビゲーション

| ID | テスト項目 | 操作 | 期待結果 | PASS | 備考 |
|----|------------|------|----------|------|------|
| E2E-3-1 | 戻るボタン | 各ステップで「戻る」 | 前ステップ表示 | | |
| E2E-3-2 | 進捗インジケータ | ウィザード進行中 | 1/6〜6/6表示 | | |
| E2E-3-3 | モーダル閉じて再開 | 途中でモーダル閉じる | 状態維持 | | |

---

## 5. セキュリティテスト

### 5.1 secretsマスク確認

| ID | テスト項目 | 確認場所 | 期待結果 | PASS | 備考 |
|----|------------|----------|----------|------|------|
| SEC-1-1 | GET /api/sdm/config | レスポンス | client_secret/refresh_token非表示 | | |
| SEC-1-2 | サーバログ | /var/log/is22/ | 秘密値マスク | | |
| SEC-1-3 | ブラウザDevTools | Network | 秘密値非露出 | | |
| SEC-1-4 | エラーログ | Google API失敗時 | 秘密値マスク | | |

### 5.2 アクセス制御

| ID | テスト項目 | 操作 | 期待結果 | PASS | 備考 |
|----|------------|------|----------|------|------|
| SEC-2-1 | 非管理者アクセス | /api/sdm/* | 403 | | |
| SEC-2-2 | CSRFトークンなし | PUT /api/sdm/config | 403 | | |
| SEC-2-3 | 監査ログ記録 | 任意操作 | 操作ログ記録 | | |

---

## 6. 非機能テスト

### 6.1 長時間運用

| ID | テスト項目 | 条件 | 期待結果 | PASS | 備考 |
|----|------------|------|----------|------|------|
| NF-1-1 | go2rtc再起動復旧 | go2rtc停止→再起動 | reconcileで<1周期復旧 | | |
| NF-1-2 | 24時間連続運用 | 放置 | snapshot継続取得 | | |
| NF-1-3 | refresh_tokenリフレッシュ | 長期運用 | 自動更新 | | |

### 6.2 レート制限

| ID | テスト項目 | 条件 | 期待結果 | PASS | 備考 |
|----|------------|------|----------|------|------|
| NF-2-1 | /api/sdm/devices quota | 連続呼び出し | 1分/1回制限 | | |
| NF-2-2 | SDM API 429応答 | quota超過 | 10分待機後再試行 | | |

---

## 7. 退行テスト

### 7.1 既存機能への影響

| ID | テスト項目 | 操作 | 期待結果 | PASS | 備考 |
|----|------------|------|----------|------|------|
| REG-1-1 | Tapoカメラ検出 | Camscan実行 | 従来通り検出 | | |
| REG-1-2 | VIGIカメラ検出 | Camscan実行 | 従来通り検出 | | |
| REG-1-3 | Hikvisionカメラ検出 | Camscan実行 | 従来通り検出 | | |
| REG-1-4 | PollingOrchestrator | 巡回 | 既存カメラ継続 | | |
| REG-1-5 | go2rtcストリーム | 既存カメラ | 配信継続 | | |

### 7.2 Camscan導線連携（Phase 7後）

| ID | テスト項目 | 操作 | 期待結果 | PASS | 備考 |
|----|------------|------|----------|------|------|
| REG-2-1 | Google OUIデバイス検出 | Camscan実行 | suggested_action=SdmRegister | | |
| REG-2-2 | 「SDM登録へ」ボタン | Scan結果から | SystemSettingsModal開く | | |
| REG-2-3 | SDM未設定時 | SDM登録へ | 警告メッセージ表示 | | |

---

## テスト結果サマリ

| カテゴリ | 項目数 | PASS | FAIL | N/A | N/T |
|----------|--------|------|------|-----|-----|
| バックエンド単体 | 25 | | | | |
| バックエンド統合 | 15 | | | | |
| フロントエンドコンポーネント | 24 | | | | |
| E2Eテスト | 14 | | | | |
| セキュリティテスト | 7 | | | | |
| 非機能テスト | 5 | | | | |
| 退行テスト | 8 | | | | |
| **合計** | **98** | | | | |

---

## 凡例

| 記号 | 意味 |
|------|------|
| PASS | テスト合格 |
| FAIL | テスト不合格 |
| N/A | 該当なし/適用外 |
| N/T | 未テスト |

---

## MECE確認

- [x] バックエンド（単体・統合）を分離
- [x] フロントエンド（コンポーネント・E2E）を分離
- [x] セキュリティ・非機能を独立カテゴリ化
- [x] 退行テストで既存機能影響を確認
- [x] Phase 7（Camscan導線）を別セクションで管理

## アンアンビギュアス確認

- [x] 各テストに明確なID・期待結果を付与
- [x] 操作手順を具体的に記載
- [x] エラー条件とリカバリを明示

---

## 参照ドキュメント

- [TASK_INDEX.md](./TASK_INDEX.md)
- [GD-03] GoogleDevices_introduction_DetailedDesign.md (11章テスト計画)
- [GD-05] GoogleDevices_settings_wizard_spec.md (6章テスト計画)
- [The_golden_rules.md](/The_golden_rules.md)
