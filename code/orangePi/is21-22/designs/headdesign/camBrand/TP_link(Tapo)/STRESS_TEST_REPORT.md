# TP-link Tapo シリーズ ストレステスト報告書

## テスト実施日
- C200: 2026-01-17
- C110: 2026-01-17

---

# 🔥 Tapoモデル別性能比較（重要）

| テスト項目 | C110 | C200 | 差異 |
|-----------|------|------|------|
| 解像度(Main) | 1920x1080 | 1280x720 | C110優位 |
| 急速再接続 | ✅ 100% | ✅ 100% | 同等 |
| 2並列接続 | ✅ **100%** | ❌ 0% | **C110圧勝** |
| 3並列接続 | ⚠️ 67% | ❌ 11% | **C110優位** |
| Main+Sub同時 | ✅ **100%** | ❌ 0% | **C110圧勝** |
| 推奨max_concurrent | **2** | **1** | C110は2並列可 |
| go2rtc必要性 | 低い | **必須** | C110は直接可 |

### 結論
**C110はC200より明らかに優れたマルチストリーム性能を持つ。**
- C200: max_concurrent=1, require_exclusive_lock=TRUE
- C110: max_concurrent=2, require_exclusive_lock=FALSE

Tapoファミリーでも**モデルごとに個別の設定が必要**。

---

# Part 1: Tapo C200 ストレステスト

## テスト環境

| 項目 | 値 |
|------|-----|
| カメラ | TP-link Tapo C200 |
| カメラIP | 192.168.125.45 |
| テストサーバー | IS22 (192.168.125.246) |
| ONVIFポート | 2020 |
| RTSPポート | 554 |
| 認証情報 | halecam:hale0083@ |
| 解像度(Main) | 1280x720 (720p) |
| RTSPパス | /stream1, /stream2 |

---

## 1. テスト結果サマリー

| テスト項目 | 結果 | 評価 |
|-----------|------|------|
| RTSP順次接続 | 5/5成功（100%） | ✅ 良好 |
| RTSP急速再接続（インターバルなし） | 20/20成功（100%） | ✅ 良好 |
| RTSP再接続（0.5秒間隔） | 10/10成功（100%） | ✅ 良好 |
| RTSP再接続（1秒間隔） | 10/10成功（100%） | ✅ 良好 |
| RTSP再接続（2秒間隔） | 10/10成功（100%） | ✅ 良好 |
| RTSP長時間ストリーム（30秒） | 成功（DTS警告あり） | ⚠️ 注意 |
| RTSP 2並列接続 | 0/6成功（0%） | ❌ **致命的** |
| RTSP 3並列接続 | 1/9成功（11%） | ❌ **致命的** |
| RTSP 5並列接続 | 1/10成功（10%） | ❌ **致命的** |
| Main + Sub同時 | 0/3成功（0%） | ❌ **致命的** |
| ONVIF（認証なし） | 0/20成功 | ⚠️ 要認証 |

---

## 2. 詳細テスト結果

### 2.1 RTSP順次接続テスト

| 接続 | 結果 | 応答時間 | 解像度 |
|------|------|---------|--------|
| 1 | ✅ SUCCESS | 2208ms | 1280x720 |
| 2 | ✅ SUCCESS | 2256ms | 1280x720 |
| 3 | ✅ SUCCESS | 2261ms | 1280x720 |
| 4 | ✅ SUCCESS | 2282ms | 1280x720 |
| 5 | ✅ SUCCESS | 2217ms | 1280x720 |

**平均応答時間**: 約2.2秒

---

### 2.2 RTSP再接続テスト（シングル接続）

| インターバル | 成功率 | 詳細 |
|-------------|--------|------|
| 0秒（急速） | **100%** (20/20) | ✅ 完全成功 |
| 0.5秒 | **100%** (10/10) | ✅ 完全成功 |
| 1秒 | **100%** (10/10) | ✅ 完全成功 |
| 2秒 | **100%** (10/10) | ✅ 完全成功 |

**所見**: **シングル接続では安定**。急速再接続も問題なし。

---

### 2.3 長時間ストリームテスト

```
結果: SUCCESS（警告あり）
フレーム数: 418フレーム
平均FPS: 約15fps
実行時間: 30秒
警告: "non monotonically increasing dts" (タイムスタンプ不整合)
```

**所見**: ストリーム自体は完走するが、DTSタイムスタンプに不整合が発生。録画システムでは注意が必要。

---

### 2.4 RTSP並列接続テスト ❌ **重大な問題**

| 並列数 | 試行回数 | 成功率 | 詳細 |
|--------|---------|--------|------|
| 2 | 3回 | **0%** (0/6) | ❌ 全失敗 |
| 3 | 3回 | **11%** (1/9) | ❌ ほぼ全失敗 |
| 5 | 2回 | **10%** (1/10) | ❌ ほぼ全失敗 |

#### 詳細ログ

**2並列テスト:**
```
Run 1: A: FAIL, B: FAIL
Run 2: A: OK, B: FAIL
Run 3: A: FAIL, B: FAIL
```

**スタッガード開始テスト（0.5秒間隔で順次接続）:**
```
Stream 1: OK (先行接続のみ成功)
Stream 2: FAIL
Stream 3: FAIL
```

**所見**:
- **Tapo C200は同時に1接続しかRTSPストリームを提供できない**
- 2番目以降の接続は拒否される
- これはハードウェア/ファームウェアの制限と考えられる

---

### 2.5 Main + Sub 同時接続テスト ❌

| 試行 | Main結果 | Sub結果 | 評価 |
|------|---------|--------|------|
| 1 | FAIL | FAIL | ❌ |
| 2 | FAIL | FAIL | ❌ |
| 3 | FAIL | FAIL | ❌ |

**所見**: **Main/Subの同時取得は不可能**。並列接続制限に起因。

---

### 2.6 接続失敗後の回復テスト

| 試行 | 結果 |
|------|------|
| 1 | ✅ OK |
| 2 | ✅ OK |
| 3 | ✅ OK |
| 4 | ✅ OK |
| 5 | ✅ OK |

**所見**: 並列接続失敗後でも、シングル接続に戻れば正常に回復する。

---

## 3. 重大な制限事項

### ⚠️ Tapo C200の致命的制限

```
┌────────────────────────────────────────────────────────────┐
│  Tapo C200は同時に1つのRTSPストリームしかサポートしない  │
│                                                            │
│  - 2番目の接続は拒否される                                │
│  - Main/Subの同時取得は不可能                             │
│  - go2rtcなどのプロキシ経由が必須                         │
└────────────────────────────────────────────────────────────┘
```

---

## 4. 性能特性

### 強み ✅
- **シングル接続では安定**
- **急速再接続対応**（インターバル不要）
- **接続失敗後の回復が早い**

### 弱み ❌
- **並列接続に非対応**（最大の問題）
- **Main/Sub同時取得不可**
- **DTSタイムスタンプ不整合**
- 720p限定（高解像度モデルは別）

---

## 5. IS22運用への推奨事項

### 5.1 アクセスガード設定（必須）

```
必須設定:
- 最大並列接続数: 1 ★重要★
- 接続排他制御: 有効
- 接続キュー: 必須（並列リクエストをシリアル化）
```

### 5.2 スナップショット取得

```
推奨設定:
- Main/Sub同時取得: 不可（直列で取得）
- スナップショット間隔: 制限なし
- Main → Sub の順に取得する場合は1秒間隔を推奨
```

### 5.3 ポーリング実装

```
必須対策:
- ポーリングオーケストレーターでTapoカメラは直列処理
- 複数Tapoがある場合は1台ずつ順番に処理
- または go2rtc プロキシ経由でストリーム共有
```

### 5.4 go2rtc プロキシ設定（推奨）

```yaml
# go2rtc.yaml
streams:
  tapo_c200_main:
    - rtsp://halecam:hale0083%40@192.168.125.45:554/stream1
  tapo_c200_sub:
    - rtsp://halecam:hale0083%40@192.168.125.45:554/stream2
```

go2rtc経由であれば複数クライアントからの同時アクセスが可能。

---

## 6. 結論

**Tapo C200は単一接続では安定するが、並列接続に致命的な制限がある。**

### 評価
| 項目 | スコア |
|------|--------|
| 再接続安定性（シングル） | ★★★★★ (5/5) |
| 並列接続 | ★☆☆☆☆ (1/5) |
| 長時間安定性 | ★★★★☆ (4/5) |
| Main/Sub同時 | ★☆☆☆☆ (1/5) |
| **総合評価** | **★★★☆☆ (2.75/5)** |

### IS22での運用

| 運用方法 | 推奨度 |
|----------|--------|
| 直接接続（排他制御あり） | ⚠️ 可能だが制限あり |
| go2rtc プロキシ経由 | ✅ **推奨** |
| 複数Tapoの並列ポーリング | ❌ **不可** |

---

## 付録: テストコマンド

### RTSP接続テスト
```bash
ffprobe -rtsp_transport tcp -v error -show_entries stream=width,height -of csv=p=0 \
    "rtsp://halecam:hale0083%40@192.168.125.45:554/stream1"
```

### 長時間ストリームテスト
```bash
timeout 35 ffmpeg -rtsp_transport tcp -i "rtsp://halecam:hale0083%40@192.168.125.45:554/stream1" \
    -t 30 -f null -
```

### 並列接続テスト（失敗を確認）
```bash
# 以下を同時実行すると2番目が失敗する
ffprobe -rtsp_transport tcp ... &
ffprobe -rtsp_transport tcp ... &
wait
```

---

# Part 2: Tapo C110 ストレステスト

## テスト環境

| 項目 | 値 |
|------|-----|
| カメラ | TP-link Tapo C110 |
| カメラIP | 192.168.125.52 |
| テストサーバー | IS22 (192.168.125.246) |
| ONVIFポート | 2020 |
| RTSPポート | 554 |
| 認証情報 | halecam:hale0083@ |
| 解像度(Main) | 1920x1080 (1080p) |
| 解像度(Sub) | 640x360 |
| RTSPパス | /stream1, /stream2 |

---

## 1. テスト結果サマリー

| テスト項目 | 結果 | 評価 |
|-----------|------|------|
| RTSP基本接続 | Main: OK, Sub: OK | ✅ 良好 |
| RTSP急速再接続（インターバルなし） | 20/20成功（100%） | ✅ 良好 |
| RTSP 2並列接続 | 6/6成功（100%） | ✅ **良好** |
| RTSP 3並列接続 | 6/9成功（67%） | ⚠️ 部分成功 |
| Main + Sub同時 | 3/3成功（100%） | ✅ **良好** |
| RTSP長時間ストリーム（30秒） | 成功（DTS警告あり） | ✅ 良好 |
| ONVIF（認証なし） | 0/20成功 | ⚠️ 要認証 |
| HTTPポート | 閉じている | N/A |

---

## 2. 詳細テスト結果

### 2.1 基本接続テスト

| ストリーム | 解像度 | コーデック | 結果 |
|-----------|--------|-----------|------|
| Main (/stream1) | 1920x1080 | h264 + pcm_alaw | ✅ OK |
| Sub (/stream2) | 640x360 | h264 + pcm_alaw | ✅ OK |

---

### 2.2 RTSP再接続テスト

| インターバル | 成功率 | 詳細 |
|-------------|--------|------|
| 0秒（急速） | **100%** (20/20) | ✅ 完全成功 |

**所見**: C200同様、シングル接続の再接続は問題なし。

---

### 2.3 RTSP並列接続テスト ✅ **C200との重要な違い**

| 並列数 | 試行回数 | 成功率 | 詳細 |
|--------|---------|--------|------|
| 2 | 3回 | **100%** (6/6) | ✅ 全成功 |
| 3 | 3回 | **67%** (6/9) | ⚠️ 部分成功（2/3のみ成功） |

#### 詳細ログ

**2並列テスト:**
```
Run 1: conn1=1, conn2=1 ✅
Run 2: conn1=1, conn2=1 ✅
Run 3: conn1=1, conn2=1 ✅
```

**3並列テスト:**
```
Run 1: conn1=1, conn2=1, conn3=0 (2/3)
Run 2: conn1=1, conn2=1, conn3=0 (2/3)
Run 3: conn1=0, conn2=1, conn3=1 (2/3)
```

**所見**:
- **C110は2並列接続を安定して処理可能**
- 3並列では3番目の接続が不安定
- **C200（max=1）とは大きく異なる**

---

### 2.4 Main + Sub 同時接続テスト ✅

| 試行 | Main結果 | Sub結果 | 評価 |
|------|---------|--------|------|
| 1 | ✅ OK | ✅ OK | ✅ |
| 2 | ✅ OK | ✅ OK | ✅ |
| 3 | ✅ OK | ✅ OK | ✅ |

**所見**: **Main+Sub同時取得が可能**。C200では不可能だった。

---

### 2.5 長時間ストリームテスト

```
結果: SUCCESS
フレーム数: 454フレーム
平均FPS: 約15fps
実行時間: 30秒
警告: "non monotonically increasing dts" (軽微)
```

**所見**: C200同様、長時間ストリームは安定。

---

### 2.6 ONVIFテスト

```
ポート: 2020 (OPEN)
エンドポイント: /onvif/device_service
結果: "Authority failure" (認証必要)
```

**所見**: C200同様、ONVIF認証が必要。

---

## 3. 性能特性

### 強み ✅
- **2並列接続が可能**（C200は1のみ）
- **Main+Sub同時取得が可能**
- **1080p対応**（C200は720p）
- 急速再接続に対応
- 長時間ストリームが安定

### 弱み ⚠️
- 3並列接続は不安定
- DTSタイムスタンプ不整合（軽微）
- ONVIF認証必要

---

## 4. IS22運用への推奨事項

### 4.1 Access Absorber設定

```
推奨設定:
- family: tapo_c110（C200と別管理を推奨）
- max_concurrent_streams: 2
- min_reconnect_interval_ms: 0
- require_exclusive_lock: FALSE
```

### 4.2 スナップショット取得

```
推奨設定:
- Main/Sub同時取得: 可能
- スナップショット間隔: 制限なし
```

### 4.3 go2rtcプロキシ

```
推奨: 不要（2並列で十分な場合）
理由: C110は直接2並列接続が可能
```

---

## 5. 結論

**Tapo C110はC200より優れたマルチストリーム性能を持つ。**

### 評価
| 項目 | スコア |
|------|--------|
| 再接続安定性 | ★★★★★ (5/5) |
| 並列接続 | ★★★★☆ (4/5) |
| 長時間安定性 | ★★★★★ (5/5) |
| Main/Sub同時 | ★★★★★ (5/5) |
| **総合評価** | **★★★★☆ (4.75/5)** |

### C200との比較

| 項目 | C110 | C200 |
|------|------|------|
| 総合評価 | **4.75/5** | 2.75/5 |
| 推奨接続数 | 2 | 1 |
| go2rtc | 不要 | 必須 |
| 排他ロック | 不要 | 必須 |

---

## 6. DB投入SQL

```sql
-- Tapo C110用（C200とは別設定）
INSERT INTO camera_access_limits
(family, display_name, max_concurrent_streams, min_reconnect_interval_ms, require_exclusive_lock, notes)
VALUES
('tapo_c110', 'TP-Link Tapo C110', 2, 0, FALSE, 'Stress test 2026-01-17');

-- 既存のTapo C200設定との共存
-- family='tapo' は C200用として維持
-- 新規登録カメラはモデル判定が必要
```

---

## 付録: C110テストコマンド

### RTSP接続テスト
```bash
ffprobe -rtsp_transport tcp -v error -show_entries stream=width,height,codec_name -of csv=p=0 \
    "rtsp://halecam:hale0083%40@192.168.125.52:554/stream1"
```

### Main+Sub同時テスト
```bash
ffprobe ... /stream1 &
ffprobe ... /stream2 &
wait
```
