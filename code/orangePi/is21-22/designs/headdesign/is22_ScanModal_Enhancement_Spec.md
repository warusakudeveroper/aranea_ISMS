# IS22 ScanModal 拡張仕様書

**作成日**: 2026-01-01
**ステータス**: 承認済み
**対象**: ScanModal.tsx サブネット設定・デバイス分類機能

---

## 1. 概要

スキャンモーダルの機能拡張。サブネット単位のクレデンシャル管理とデバイスカテゴリ分類による視認性向上を実現する。

---

## 2. サブネット設定

### 2.1 設定項目

各サブネットに以下の設定を保持:

| 項目 | 型 | 説明 |
|------|-----|------|
| cidr | string | サブネットCIDR (例: 192.168.125.0/24) |
| fid | string | 施設ID (例: "0150") |
| facility_name | string | 施設名 (例: "HALE京都丹波口") |
| trial_credentials | Credential[] | 試行クレデンシャル (最大10件) |

### 2.2 試行クレデンシャル

```typescript
interface TrialCredential {
  username: string;
  password: string;
  priority: number;  // 試行順序 (1-10)
}
```

- 各サブネットに最大10件まで設定可能
- スキャン時に優先度順で認証試行
- 成功したクレデンシャルを自動記憶

---

## 3. デバイスカテゴリ分類

### 3.1 カテゴリ定義

| カテゴリ | 名称 | 条件 | 表示 |
|----------|------|------|------|
| a | 登録済み | cameras テーブルに存在 | 表示・背景色あり |
| b | 登録可能 | カメラ確認済み + 認証OK + 未登録 | **強調表示** |
| c | 認証必要 | カメラ検出 + 認証未実施/失敗 | 表示・警告色 |
| d | その他カメラ | カメラ可能性あり + 条件不足 | **折りたたみ** |
| e | 非カメラ | カメラでないデバイス | **折りたたみ** |

### 3.2 判定ロジック

```
デバイス検出
  ├── cameras テーブルに存在? → [a] 登録済み
  └── 存在しない
        ├── device_type == camera_confirmed?
        │     ├── 認証成功? → [b] 登録可能 ★強調
        │     └── 認証未実施/失敗 → [c] 認証必要
        ├── device_type == camera_likely/possible?
        │     └── → [d] その他カメラ (折りたたみ)
        └── device_type == other?
              └── → [e] 非カメラ (折りたたみ)
```

---

## 4. UI仕様

### 4.1 モーダルサイズ

```css
height: 90vh;
width: 60vw;
min-width: 800px;
max-width: 1200px;
```

### 4.2 背景色（不透明）

| カテゴリ | 背景色 | Tailwind |
|----------|--------|----------|
| a | 薄緑 | bg-green-100 |
| b | 薄青（強調） | bg-blue-200 border-2 border-blue-500 |
| c | 薄黄（警告） | bg-yellow-100 |
| d,e | 薄灰 | bg-gray-100 |

### 4.3 表示構成

```
┌─────────────────────────────────────────┐
│ [スキャン設定] [サブネット管理]          │
├─────────────────────────────────────────┤
│ ◆ カテゴリ a: 登録済み (3台)             │
│   ┌───────────────────────────────────┐ │
│   │ 192.168.125.45 | 9C:53:22:... |...│ │
│   └───────────────────────────────────┘ │
│                                         │
│ ◆ カテゴリ b: 登録可能 (5台) ★           │
│   ┌───────────────────────────────────┐ │
│   │ 192.168.125.78 | TP-LINK | Tapo  │ │
│   │ [チェックボックス] [登録ボタン]    │ │
│   └───────────────────────────────────┘ │
│                                         │
│ ◆ カテゴリ c: 認証必要 (2台)             │
│   ┌───────────────────────────────────┐ │
│   │ 192.168.126.12 | 認証エラー       │ │
│   │ [クレデンシャル入力フォーム]       │ │
│   └───────────────────────────────────┘ │
│                                         │
│ ▶ カテゴリ d: その他カメラ (8台)   [展開]│
│ ▶ カテゴリ e: 非カメラ (72台)      [展開]│
└─────────────────────────────────────────┘
```

### 4.4 ソート順

1. **カテゴリ順**: a → b → c → d → e
2. **サブネット順**: CIDR昇順
3. **IP順**: IP昇順

---

## 5. データフロー

### 5.1 サブネット設定保存

```
Frontend → POST /api/subnets/{cidr}/settings
           Body: { fid, facility_name, credentials }
         → Backend saves to subnets table
```

### 5.2 カテゴリ判定

```
Frontend: スキャン結果受信
  → GET /api/cameras (登録済みカメラ取得)
  → デバイスとカメラをIPで照合
  → カテゴリ振り分け
  → UI表示
```

---

## 6. 実装タスク

### Phase 1: 型定義拡張
- [ ] SubnetSettings 型追加
- [ ] TrialCredential 型追加
- [ ] DeviceCategory enum追加

### Phase 2: UI基盤
- [ ] モーダルサイズ変更
- [ ] カテゴリ別セクションコンポーネント
- [ ] 折りたたみ機能

### Phase 3: 機能実装
- [ ] サブネット設定フォーム
- [ ] クレデンシャル管理UI
- [ ] カテゴリ判定ロジック

### Phase 4: 統合テスト
- [ ] 全カテゴリ表示確認
- [ ] ソート動作確認
- [ ] クレデンシャル保存確認

---

## 7. 参照仕様

- is22_Camserver実装指示.md
- is22_GAP_ANALYSIS_20260101.md
- is22_Camserver仕様案(基本設計書草案改訂版).md
