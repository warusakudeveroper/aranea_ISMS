# AIEventLog テスト計画

文書番号: Layout＆AIlog_Settings/AIEventLog_TestPlan
作成日: 2026-01-08
関連Issue: #100
設計ドキュメント: AIEventLog_Redesign_v4.md
タスクリスト: AIEventLog_TaskList.md
ステータス: 実装前

---

## 大原則の確認

本テスト計画はThe_golden_rules.mdに完全準拠:

- [x] Rule 9: 「チェック、テストのない完了報告は報告と見做されない」
- [x] Rule 15: 「テストリストの無い受け入れ条件が曖昧な実装は禁止」
- [x] 手順5: 「テストは必ずフロントエンド、バックエンド、chromeアクセスでの実UI/UXのテストとし、テストの簡素化は原則として認められない」

---

## テスト環境

### バックエンド

- **IS22サーバー**: 192.168.125.246
- **ユーザー**: mijeosadmin
- **パスワード**: mijeos12345@
- **テストコマンド**: `cargo build --release`, `cargo test`

### フロントエンド

- **ディレクトリ**: `code/orangePi/is22/frontend/`
- **ビルドコマンド**: `npm run build`
- **型チェック**: `npx tsc --noEmit`

### Chrome UIテスト

- **URL**: `http://192.168.125.246:3000/`
- **ブラウザ**: Chrome（最新版）
- **テスト方法**: MCP claude-in-chrome 使用

---

## 1. バックエンドテスト（BE-01〜BE-20）

### 1.1 ビルドテスト

| ID | テスト内容 | コマンド | 期待結果 |
|----|-----------|---------|----------|
| BE-01 | リリースビルド | `cargo build --release` | エラーなし、警告許容 |

### 1.2 画像保存条件テスト

| ID | テスト内容 | 入力条件 | 期待結果 | 根拠 |
|----|-----------|----------|----------|------|
| BE-02 | none+no_unknown | event="none", unknown_flag=false | 画像保存**されない** | none=無保存 |
| BE-03 | none+unknown | event="none", unknown_flag=true | 画像保存**されない** | none優先 |
| BE-04 | unknown+unknown | event="unknown", unknown_flag=true | 画像保存**される** | unknownイベント |
| BE-05 | severity>0 | severity=1, any | 画像保存**される** | severity優先 |

#### 真理値表

| severity | primary_event | unknown_flag | should_save | 理由 |
|----------|---------------|--------------|-------------|------|
| 0 | "none" | false | false | 何もない |
| 0 | "none" | true | false | none優先 |
| 0 | "unknown" | true | **true** | 不明だが何かある |
| 0 | "human" | false | true | イベントあり |
| 1+ | any | any | true | severity>0 |

### 1.3 ストレージクォータテスト

| ID | テスト内容 | 入力条件 | 期待結果 |
|----|-----------|----------|----------|
| BE-06 | 枚数クォータ強制 | カメラに1100枚 | 100枚削除、1000枚残存 |
| BE-07 | 容量クォータ強制 | カメラに600MB | 100MB分削除、500MB以下 |
| BE-08 | 手動unknown削除（確認あり） | 100枚unknown, confirmed=true | 90枚削除、最新10枚残存 |
| BE-08a | 手動unknown削除（確認なし） | 100枚unknown, confirmed=false | プレビューのみ、削除なし |

### 1.4 診断・復旧APIテスト

| ID | テスト内容 | 条件 | 期待結果 |
|----|-----------|------|----------|
| BE-09 | 診断API: 欠損検出 | ファイル手動削除済み | `missing_on_disk > 0` |
| BE-12 | 復旧API: RefetchCurrent | モード=RefetchCurrent | 現スナップショットで画像再保存 |
| BE-13 | 復旧API: PurgeOrphans | モード=PurgeOrphans | 欠損レコードDB削除 |

### 1.5 二枚画像送信テスト

| ID | テスト内容 | 条件 | 期待結果 |
|----|-----------|------|----------|
| BE-10 | 二枚画像送信確認 | 2回目巡回 | `had_previous=true`, `comparison_method="full_image"` |
| BE-11 | IS21ログ確認 | 二枚送信後 | 両画像バイト数がログに記録 |

### 1.6 ストリーム選択テスト

| ID | テスト内容 | 条件 | 期待結果 |
|----|-----------|------|----------|
| BE-14 | メインストリーム成功 | メイン取得成功 | `source="main"`でログ |
| BE-15 | フォールバック | メイン失敗、サブ成功 | `source="sub"`でログ、警告出力 |

### 1.7 誤検知報告テスト

| ID | テスト内容 | 入力 | 期待結果 |
|----|-----------|------|----------|
| BE-16 | 誤検知報告保存 | POST /api/feedback/misdetection | `feedback_id`返却、DBに保存 |
| BE-17 | 誤検知統計取得 | GET /api/feedback/stats/{camera_id} | カメラ別・ラベル別の集計 |

### 1.8 閾値調整テスト

| ID | テスト内容 | 入力 | 期待結果 |
|----|-----------|------|----------|
| BE-18 | 閾値変更: 正常 | threshold=0.5（範囲0.2-0.8） | 更新成功、履歴記録 |
| BE-19 | 閾値変更: 範囲外 | threshold=0.1 | エラー返却 |
| BE-20 | 閾値推論適用 | 変更後の推論 | ログに`conf_override`出力 |

---

## 2. フロントエンドテスト（FE-01〜FE-02）

| ID | テスト内容 | コマンド | 期待結果 |
|----|-----------|---------|----------|
| FE-01 | プロダクションビルド | `npm run build` | エラーなし |
| FE-02 | TypeScript型チェック | `npx tsc --noEmit` | エラーなし |

---

## 3. Chrome UIテスト（UI-01〜UI-14）

### 3.1 色スキーム検証

| ID | テスト内容 | 期待結果 | 検証方法 |
|----|-----------|----------|----------|
| UI-01 | 人検知イベント表示 | 背景`#FFFF00`、文字`#222222`、ボーダー`#B8B800` | DevTools要素検査 |
| UI-02 | 車両検知イベント表示 | 背景`#6495ED`、文字`#FFFFFF`、ボーダー`#4169E1` | DevTools要素検査 |
| UI-03 | 異常検知イベント表示 | 背景`#FF0000`、文字`#FFFF00`、ボーダー`#CC0000` | DevTools要素検査 |
| UI-04 | unknownイベント表示 | 背景`#D3D3D3`、文字`#222222`、ボーダー`#A9A9A9` | DevTools要素検査 |
| UI-05 | camera_lost表示 | 背景`#333333`、文字`#FFFFFF`、ボーダー`#1A1A1A` | DevTools要素検査 |
| UI-06 | camera_recovered表示 | 背景`#FFFFFF`、文字`#444444`、ボーダー`#CCCCCC` | DevTools要素検査 |

### 3.2 ラベル検証

| ID | テスト内容 | 期待結果 | 検証方法 |
|----|-----------|----------|----------|
| UI-07 | 人検知ラベル | 「人物検知」と表示 | テキスト確認 |
| UI-08 | unknownラベル | 「不明」と表示 | テキスト確認 |

### 3.3 インタラクション検証

| ID | テスト内容 | 期待結果 | 検証方法 |
|----|-----------|----------|----------|
| UI-09 | Severityホバー | ツールチップ表示（説明文あり） | ホバー操作 |
| UI-10 | ストレージ設定 | 枚数・容量設定フォーム表示、保存可能 | 設定モーダル操作 |
| UI-11 | 診断結果表示 | 欠損件数・サイズ表示 | 診断実行→結果確認 |

### 3.4 追加UIテスト

| ID | テスト内容 | 期待結果 | 検証方法 |
|----|-----------|----------|----------|
| UI-12 | 手動unknownクリーンアップUI | 確認ダイアログ表示、プレビュー件数表示 | ボタンクリック |
| UI-13 | 誤検知報告UI | 報告フォーム表示、送信成功メッセージ | モーダル操作 |
| UI-14 | 閾値調整UI | スライダー表示、変更反映 | 設定モーダル操作 |

---

## 4. 受け入れ条件

### 4.1 Critical（必須）

| 条件ID | 内容 | テストID |
|--------|------|----------|
| AC-C01 | 画像保存条件がnone=保存しない、unknown=保存する | BE-02〜BE-05 |
| AC-C02 | 枚数+容量クォータが強制される | BE-06, BE-07 |
| AC-C03 | ユーザーがストレージ設定を変更可能 | UI-10 |
| AC-C04 | 二枚画像が実際にIS21に送信される | BE-10, BE-11 |
| AC-C05 | ストリーム選択が推論と保存で同一 | BE-14, BE-15 |

### 4.2 High（重要）

| 条件ID | 内容 | テストID |
|--------|------|----------|
| AC-H01 | 全色スキームがhex code完全一致 | UI-01〜UI-06 |
| AC-H02 | 全ラベルが日本語翻訳 | UI-07, UI-08 |
| AC-H03 | unknown画像診断機能が動作 | BE-09, UI-11 |
| AC-H04 | 画像送信失敗がログに記録される | BE-15 |
| AC-H05 | unknown画像復旧フローが動作 | BE-12, BE-13 |
| AC-H06 | ストリームフォールバックがログに記録される | BE-14, BE-15 |
| AC-H07 | 誤検知報告がバックエンドに保存される | BE-16 |
| AC-H08 | 閾値変更が推論に適用される | BE-18, BE-20 |

### 4.3 Medium（望ましい）

| 条件ID | 内容 | テストID |
|--------|------|----------|
| AC-M01 | 推論統計タブ表示 | - |
| AC-M02 | IS21ヘルスチェック動作 | - |
| AC-M03 | 誤検知報告UI動作 | UI-13 |
| AC-M04 | 誤検知統計の集計・表示 | BE-17 |
| AC-M05 | 閾値変更履歴の記録 | BE-18 |
| AC-M06 | 自動閾値調整の提案（オプション） | - |

---

## 5. テスト実行チェックリスト

### Phase 1完了時

- [ ] BE-01: cargo build --release
- [ ] BE-02〜BE-05: 画像保存条件
- [ ] BE-06〜BE-07: ストレージクォータ
- [ ] BE-08, BE-08a: 手動unknownクリーンアップ

### Phase 2完了時

- [ ] FE-01: npm run build
- [ ] FE-02: npx tsc --noEmit
- [ ] UI-01〜UI-06: 色スキーム
- [ ] UI-07〜UI-08: ラベル

### Phase 3完了時

- [ ] BE-09: 診断API
- [ ] BE-10〜BE-11: 二枚画像送信
- [ ] BE-12〜BE-13: 復旧API
- [ ] BE-14〜BE-15: ストリーム選択
- [ ] UI-11: 診断結果表示
- [ ] UI-12: 手動クリーンアップUI

### Phase 4完了時

- [ ] BE-16〜BE-17: 誤検知報告
- [ ] BE-18〜BE-20: 閾値調整
- [ ] UI-13: 誤検知報告UI
- [ ] UI-14: 閾値調整UI

### Phase 6完了時（最終確認）

- [ ] 全BE-XXテスト合格
- [ ] 全FE-XXテスト合格
- [ ] 全UI-XXテスト合格
- [ ] 全AC-CXX条件充足
- [ ] 全AC-HXX条件充足

---

## 6. テスト結果記録テンプレート

```markdown
### テスト実行記録

実行日: YYYY-MM-DD
実行者:
環境: IS22 192.168.125.246

#### バックエンドテスト

| ID | 結果 | 備考 |
|----|------|------|
| BE-01 | [ ] Pass / [ ] Fail | |
| BE-02 | [ ] Pass / [ ] Fail | |
...

#### Chrome UIテスト

| ID | 結果 | スクリーンショット |
|----|------|------------------|
| UI-01 | [ ] Pass / [ ] Fail | [リンク] |
...

#### 総合判定

- [ ] 全テスト合格
- [ ] 受け入れ条件充足
- [ ] リリース可能
```

---

## 7. 依存関係

```
AIEventLog_Redesign_v4.md（設計）
        ↓
AIEventLog_TaskList.md（タスク）
        ↓
AIEventLog_TestPlan.md（本ドキュメント）
        ↓
GitHub Issue #100
        ↓
実装 → テスト実行 → 完了報告
```

---

**文書終端**
