# mobes AIcam control Tower 画面仕様書

## 概要

3ペイン構成のカメラ監視・AI検知インターフェース

| ペイン | 位置 | 幅比率 | 主な機能 |
|--------|------|--------|----------|
| サジェストビュー | 左 | 30% | AI検知カメラの動画再生 |
| カメラタイル | 中央 | 55% | 全カメラのサムネイル表示 |
| AI Event Log | 右 | 15% | イベントログ + AIチャット |

**重要**: 幅はパーセンテージ指定。ピクセル固定や上限設定は禁止（4K対応のため）

---

## 1. サジェストビュー (左ペイン 30%)

### 1.1 基本仕様

- **幅**: 画面横幅の30%（パーセンテージ指定、ピクセル上限なし）
- **機能**: AI Event検知されたカメラの動画をgo2rtcを利用してリアルタイム表示
- **最大表示数**: 3カメラ

### 1.2 動画再生ルール

#### 再生開始
- AIイベント検知時に該当カメラの動画を自動再生開始
- 新規検知カメラは**スライドインアニメーション**で最上部に挿入
- 既存の動画は下に押し込まれる（再生は止めない）

#### 再生時間管理
- **onairtime設定**: 設定モーダルで設定可能（デフォルト: 180秒）
- **延長ロジック**: 再生中に該当カメラのイベント検知があれば再生延長
- **終了条件**: 最後のイベント検知から`onairtime`秒経過で自動終了

#### 3カメラ超過時
- 最古（最下部）のビューを押し流して再生終了
- 新規カメラが最上部にスライドイン

#### イベント延長時の順序変更
- 中間や下部のカメラがイベント延長した場合、最新イベント順に並び替え
- 上下のカメラが入れ替わる可能性あり

### 1.3 アニメーション要件

| シーン | アニメーション |
|--------|---------------|
| 新規挿入 | スライドイン（上から） |
| 押し出し | 下方向へスライドアウト |
| 順序入替 | スムーズな位置交換 |

### 1.4 UX重要事項

- **自動開始・自動終了**: ユーザー操作不要で再生が開始・終了すること
- **連続再生**: 動画再生中に他の操作があっても再生を止めない

---

## 2. カメラタイル (中央ペイン 55%)

### 2.1 基本仕様

- **幅**: 画面横幅の55%（パーセンテージ指定）
- **列数**: 4列固定
- **最大カメラ数**: 31台（4列×8段=32 - 1カメラスキャンボタン）

### 2.2 タイル表示ルール

#### アスペクト比
- デフォルト: 1:1（スクエア）
- カメラ数に応じて動的調整:
  - ≤16タイル (4行): 1:1 (square)
  - 17-24タイル (5-6行): 4:3
  - 25-32タイル (7-8行): 16:9 (video)

#### 画面収まり（スクロール禁止）
- **重要**: タイルは画面下端を超えない
- 行数が増えた場合はタイル自体を縦方向に圧縮
- 文字サイズは維持（タイル内の画像部分のみ圧縮）
- **スクロールは発生させない**

### 2.3 インタラクション

#### タイルクリック（画像部分）
- モーダルを開き該当カメラの動画をgo2rtcで再生
- 設定歯車アイコン以外の領域がクリック対象

#### 設定歯車クリック
- カメラ詳細設定モーダルを開く

### 2.4 オンエアハイライト

- サジェストビューで再生中（オンエア中）のカメラ
- タイル外周を**黄色**でハイライト表示

---

## 3. AI Event Log (右ペイン 15%)

### 3.1 基本仕様

- **幅**: 画面横幅の15%（パーセンテージ指定、ピクセル上限なし）
- **構成**: 上下2分割

### 3.2 上半分: イベントログ表示

- is21の推論ログを表示
- severity > 0 の検知イベントを時系列で表示
- パトロールティッカー: 「動いてる安心感」を提供する巡回フィードバック

### 3.3 下半分: AIチャットウインドウ

#### UIコンポーネント
- **チャット履歴エリア**: ユーザーとAIの会話履歴
- **入力フィールド**: 下端固定
  - 文字数に応じて自動で縦伸縮
  - 最大高さ制限あり（120px）
- **送信ボタン**: 入力フィールド右側

#### 機能（mobes2.0連携）
- AIイベントログとカメラコンテキスト情報から直近サマリーをLLM生成
- 件数および時間ベースで報告表示
- ユーザーはチャットで会話ベースの確認が可能
  - 例: 「〇〇な人来なかった？」
  - 例: 「今日の検知件数は？」

---

## 4. 設定項目

### 4.1 設定モーダル項目

| 設定名 | デフォルト値 | 説明 |
|--------|-------------|------|
| onairtime | 180秒 | サジェストビューでの動画再生時間 |
| 検知感度閾値 | (TBD) | カメラ単位での検知感度調整 |

### 4.2 カメラ単位設定

- プリセット選択
- 検知感度スライダー（反応レベル閾値）
- is21判定ログの全文表示機能

---

## 5. 技術仕様

### 5.1 動画配信

- **プロトコル**: go2rtc (WebRTC/MSE)
- **遅延**: 低遅延ストリーミング

### 5.2 WebSocket連携

- snapshot_updated: スナップショット更新通知
- event_log: AI検知イベント通知
- cycle_stats: ポーリングサイクル統計

### 5.3 依存関係

```
is21 (AI推論) → イベント検知 → サジェストビュー再生開始
                            → カメラタイルハイライト
                            → AI Event Log更新
```

---

## 6. 実装ステータス

### 6.1 完了済み (2025/01/03)

- [x] 3ペインレイアウト (30%/55%/15%)
- [x] パーセンテージベース幅指定
- [x] カメラタイル4列表示
- [x] タイル圧縮（スクロール抑制）
- [x] ChatInputコンポーネント
- [x] AIチャットUI（スタブ実装）
- [x] パトロールティッカー
- [x] イベントログ表示

### 6.2 未実装

- [ ] go2rtcサジェストビュー動画再生
- [ ] go2rtcタイルクリックモーダル再生
- [ ] onairtime設定
- [ ] オンエアハイライト（黄色枠）
- [ ] 検知感度スライダー
- [ ] is21判定ログ全文表示
- [ ] mobes2.0 AIチャット連携

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025/01/03 | 初版作成、レイアウト実装完了 |
