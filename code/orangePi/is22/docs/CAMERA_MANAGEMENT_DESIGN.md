# IS22 カメラ管理システム設計書

## 1. 概要

一般的なカメラ管理システムのワークフローを実装する。
複数サブネットの管理、ARPスキャンによるMAC/OUI推測、段階的な情報収集、一括・個別登録をサポート。

## 2. スキャンワークフロー

### 2.1 情報収集フロー（Stage順序）

```
┌─────────────────────────────────────────────────────────────────┐
│ Stage 0: 準備                                                    │
│   - CIDR解析                                                     │
│   - 自己IPとの比較 → L2/L3判定                                   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ Stage 1: ホスト発見                                              │
│   - L2: ARPスキャン（高速、MAC取得可能）                         │
│   - L3: TCPポートスキャン（554, 80, 443, 8080）                  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ Stage 2: MAC/OUI判定（L2のみ）                                   │
│   - ARPで取得したMACからOUI抽出                                  │
│   - TP-LINK, Google等のカメラベンダー判定                        │
│   - 推測タグ付与: "TP-Link OUI検出"                              │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ Stage 3: ポートスキャン                                          │
│   - カメラ関連ポート: 554, 2020, 80, 443, 8000, 8080, 8443, 8554│
│   - 開放ポートからカメラ推測                                     │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ Stage 4: プロトコル検出（認証不要）                              │
│   - ONVIF GetSystemDateAndTime（認証不要）                       │
│   - RTSP OPTIONS（認証不要）                                     │
│   - 推測タグ付与: "ONVIF対応", "RTSP応答あり"                    │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ Stage 5: スコアリング・推測                                      │
│   - 各証拠の重み付け合計                                         │
│   - カメラファミリー推測: "TP-Linkかも？", "不明カメラ"          │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ Stage 6: DB保存                                                  │
│   - discovered状態で保存                                         │
│   - 推測情報・タグ保存                                           │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 推測タグ（evidence_tags）

| タグ | 意味 | 付与条件 |
|------|------|----------|
| `oui:tp-link` | TP-Link OUI検出 | MAC OUIがTP-Link |
| `oui:google` | Google OUI検出 | MAC OUIがGoogle/Nest |
| `onvif:detected` | ONVIF応答あり | GetSystemDateAndTime成功 |
| `onvif:port2020` | Tapo型ONVIF | ポート2020でONVIF応答 |
| `rtsp:detected` | RTSP応答あり | OPTIONS成功 |
| `port:camera` | カメラポート開放 | 554 or 2020 開放 |

### 2.3 カメラファミリー推測ロジック

```
if onvif:port2020 && (oui:tp-link || port:554)
  → family: "tapo" (confidence: high)
  → display: "Tapo カメラ（推測）"

if oui:tp-link && rtsp:detected && !onvif:detected
  → family: "tp-link-other"
  → display: "TP-Link カメラ？（RTSPのみ）"

if oui:google
  → family: "nest"
  → display: "Google/Nest カメラ（推測）"

if rtsp:detected && !oui:known
  → family: "unknown"
  → display: "不明カメラ（RTSP応答）"
```

## 3. 登録ワークフロー

### 3.1 一括登録フロー

```
┌─────────────────────────────────────────────────────────────────┐
│ 1. スキャン結果一覧表示                                          │
│    - 登録済み: ✓マーク、グレーアウト                             │
│    - 未登録: チェックボックス選択可能                            │
│    - 推測情報表示: "Tapo C113（推測）", "不明カメラ"             │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 2. 一括登録ボタン → クレデンシャル入力モーダル                   │
│    - ファミリー別にグループ化表示                                │
│    - Tapo系: username/password入力欄                             │
│    - 不明カメラ: 個別設定を促すメッセージ                        │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 3. 検証実行（バッチ）                                            │
│    - 選択デバイスにクレデンシャル適用                            │
│    - RTSP検証 + ONVIF認証でデバイス情報取得                      │
│    - 結果表示: ✓成功 / ✗失敗（理由表示）                        │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 4. 確認・登録                                                    │
│    - 成功デバイス: 名前・場所入力（自動生成候補あり）            │
│    - 失敗デバイス: 再試行 or 個別設定へ                          │
│    - 一括登録実行                                                │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 個別登録フロー

```
┌─────────────────────────────────────────────────────────────────┐
│ 1. デバイス選択 → 詳細パネル表示                                 │
│    - IP, MAC, 開放ポート, 推測情報                               │
│    - カスタムクレデンシャル入力欄                                │
│    - RTSP URL手動入力オプション                                  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 2. 検証ボタン → 単体検証                                         │
│    - クレデンシャルでRTSP/ONVIF検証                              │
│    - 成功: デバイス情報表示                                      │
│    - 失敗: エラー理由表示、再入力促す                            │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 3. 登録                                                          │
│    - 名前、場所、コンテキスト入力                                │
│    - 登録実行                                                    │
└─────────────────────────────────────────────────────────────────┘
```

## 4. サブネット管理

### 4.1 データモデル

```sql
CREATE TABLE scan_subnets (
    subnet_id VARCHAR(36) PRIMARY KEY,
    cidr VARCHAR(18) NOT NULL,           -- e.g., "192.168.96.0/24"
    name VARCHAR(100),                    -- e.g., "本館1F", "外部カメラ"
    is_local BOOLEAN DEFAULT FALSE,       -- 自己サブネットか（L2スキャン対象）
    default_credentials_id VARCHAR(36),   -- デフォルトクレデンシャル
    last_scanned_at DATETIME(3),
    camera_count INT DEFAULT 0,
    enabled BOOLEAN DEFAULT TRUE,
    created_at DATETIME(3) DEFAULT NOW(3),
    updated_at DATETIME(3) DEFAULT NOW(3) ON UPDATE NOW(3)
);

CREATE TABLE facility_credentials (
    credential_id VARCHAR(36) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,           -- e.g., "Tapo標準", "施設A用"
    username VARCHAR(100) NOT NULL,
    password_encrypted BLOB,              -- AES-256暗号化
    encryption_iv BLOB,
    camera_family VARCHAR(50),            -- 対象ファミリー（NULL=汎用）
    created_at DATETIME(3) DEFAULT NOW(3)
);
```

### 4.2 サブネット管理UI

```
┌─────────────────────────────────────────────────────────────────┐
│ 📡 スキャン対象サブネット                          [+ 追加]     │
├─────────────────────────────────────────────────────────────────┤
│ ☑ 192.168.96.0/24   本館カメラ       📷 2台  🕐 5分前          │
│ ☑ 192.168.125.0/24  HALEカメラ(L2)   📷 8台  🕐 1時間前        │
│ ☐ 192.168.126.0/24  外部カメラ       📷 6台  🕐 昨日           │
│ ☑ 10.0.50.0/24      監視室          📷 0台  🕐 未スキャン      │
├─────────────────────────────────────────────────────────────────┤
│ [選択したサブネットを再スキャン]  [全サブネット再スキャン]      │
└─────────────────────────────────────────────────────────────────┘
```

### 4.3 API設計

```
# サブネット管理
GET    /api/subnets                    # 一覧
POST   /api/subnets                    # 追加
PUT    /api/subnets/:id                # 更新
DELETE /api/subnets/:id                # 削除

# スキャン
POST   /api/ipcamscan/scan             # 選択サブネットスキャン
  body: { "subnet_ids": ["...", "..."] }

# クレデンシャル管理
GET    /api/credentials                # 一覧
POST   /api/credentials                # 追加
DELETE /api/credentials/:id            # 削除

# 一括操作
POST   /api/ipcamscan/verify-batch     # 一括検証
  body: {
    "device_ips": ["192.168.96.83", "192.168.96.85"],
    "credential_id": "..."             # or inline credentials
  }

POST   /api/ipcamscan/approve-batch    # 一括承認
  body: {
    "devices": [
      { "ip": "...", "display_name": "...", "location": "..." },
      ...
    ]
  }
```

## 5. UI設計

### 5.1 メイン画面構成

```
┌─────────────────────────────────────────────────────────────────┐
│ IS22 Camserver - カメラ管理                                      │
├─────────────────────────────────────────────────────────────────┤
│ [タブ: カメラ一覧] [タブ: デバイス検出] [タブ: サブネット設定]   │
├─────────────────────────────────────────────────────────────────┤
```

### 5.2 デバイス検出タブ

```
┌─────────────────────────────────────────────────────────────────┐
│ 🔍 デバイス検出                                                  │
├─────────────────────────────────────────────────────────────────┤
│ スキャン対象: [☑本館] [☑HALE] [☐外部]  [スキャン開始]          │
├─────────────────────────────────────────────────────────────────┤
│ フィルタ: [すべて ▼] [未登録のみ] [登録済み]                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│ ┌─ 未登録デバイス (5) ─────────────────────────────────────────┐│
│ │ ☑ 192.168.96.200  Tapo カメラ（推測）   📶80  🔌554,2020    ││
│ │ ☑ 192.168.125.50  TP-Link？（RTSPのみ） 📶60  🔌554         ││
│ │ ☐ 192.168.125.51  不明カメラ            📶40  🔌554         ││
│ │ ☑ 192.168.126.10  Tapo カメラ（推測）   📶85  🔌554,2020    ││
│ │ ☐ 192.168.126.11  不明カメラ            📶35  🔌8080        ││
│ └──────────────────────────────────────────────────────────────┘│
│                                                                  │
│ ┌─ 登録済みデバイス (10) ──────────────────────────────────────┐│
│ │ ✓ 192.168.96.83   Tapo C113 - ISMS Room    登録済み         ││
│ │ ✓ 192.168.96.85   Tapo C530WS - Outdoor    登録済み         ││
│ │ ...                                                          ││
│ └──────────────────────────────────────────────────────────────┘│
│                                                                  │
│ [選択したデバイスを一括登録]  [個別登録...]                      │
└─────────────────────────────────────────────────────────────────┘
```

### 5.3 一括登録モーダル

```
┌─────────────────────────────────────────────────────────────────┐
│ 一括登録                                              [×]       │
├─────────────────────────────────────────────────────────────────┤
│ 選択デバイス: 4台                                                │
│                                                                  │
│ ┌─ Tapo系 (3台) ───────────────────────────────────────────────┐│
│ │ クレデンシャル: [保存済みを使用 ▼]                           ││
│ │   または                                                      ││
│ │   ユーザー名: [ismscam        ]                              ││
│ │   パスワード: [••••••••••     ]                              ││
│ └──────────────────────────────────────────────────────────────┘│
│                                                                  │
│ ┌─ 不明カメラ (1台) ───────────────────────────────────────────┐│
│ │ ⚠ 不明カメラは個別設定が必要です                             ││
│ │ [個別登録へ進む]                                              ││
│ └──────────────────────────────────────────────────────────────┘│
│                                                                  │
│                              [キャンセル] [検証して登録]         │
└─────────────────────────────────────────────────────────────────┘
```

## 6. 実装フェーズ

### Phase 1: ARPスキャン実装
- [ ] `arp-scan`コマンド呼び出し（L2判定時）
- [ ] OUI判定の前倒し（Stage 2で実行）
- [ ] evidence_tagsカラム追加

### Phase 2: サブネット管理
- [ ] scan_subnetsテーブル作成
- [ ] サブネットCRUD API
- [ ] 選択スキャン機能

### Phase 3: クレデンシャル管理
- [ ] facility_credentialsテーブル拡張
- [ ] クレデンシャルCRUD API
- [ ] AES暗号化実装

### Phase 4: 一括操作API
- [ ] verify-batch API
- [ ] approve-batch API改善
- [ ] 進捗通知（SSE/WebSocket）

### Phase 5: UI実装
- [ ] デバイス検出タブ
- [ ] サブネット設定タブ
- [ ] 一括登録モーダル
- [ ] 個別登録パネル

### Phase 6: 統合テスト
- [ ] 複数サブネットスキャン
- [ ] L2/L3混在環境
- [ ] エラーハンドリング

## 7. 注意事項

### 7.1 ARPスキャンの制約
- **root権限必要**: `arp-scan`はraw socketを使用
- **L2のみ有効**: ルーター越えでは使用不可
- **代替手段**: `/proc/net/arp`読み取り（既存ARPキャッシュ）

### 7.2 パフォーマンス考慮
- 20サブネット全スキャンは避ける
- 1サブネット/24 ≈ 254ホスト × 8ポート × 500ms = 約17分
- 並列度制御: concurrency=10〜50で調整
- 進捗表示必須

### 7.3 セキュリティ
- クレデンシャルは必ず暗号化保存
- ログにパスワード出力禁止
- APIアクセス制御（将来的にJWT等）
