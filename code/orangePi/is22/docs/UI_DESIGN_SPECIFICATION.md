# IS22 Camserver UI設計仕様書

**作成日**: 2025-12-31
**バージョン**: 1.0
**準拠ルール**: is22_Camserver実装指示.md

---

## 0. 文書目的

本書はis22 CamserverのUI実装に関する詳細設計仕様を定義する。
実装指示.mdの手順に従い、設計→検証→実施→チェックのサイクルで進行する。

---

## 1. 全体レイアウト

### 1.1 3ペイン構成

```
+------------------------------------------+
|  mobes AIcam control Tower (mAcT)        |
+----------+------------------+------------+
|          |                  |            |
| サジェスト |   カメラ一覧     |  AIログ    |
|  (左)    |    (中央)        |   (右)     |
|          |                  |            |
| 25%      |    50%          |   25%      |
+----------+------------------+------------+
```

### 1.2 各ペインの責務

| ペイン | 幅 | 責務 |
|--------|-----|------|
| 左(サジェスト) | **25%** (現状より広げる) | サジェスト動画表示、検知イベント時の自動切替 |
| 中央(カメラ一覧) | **50%** | カメラサムネ一覧(**3列**固定)、クリックでモーダル |
| 右(ログ) | **25%** | AI検知ログのストリーム表示 |

---

## 2. 改善必須項目

### 2.1 サジェストカラム幅拡大
- **現状**: 狭い
- **改善**: 左ペインを25%に拡大、動画表示エリアを確保

### 2.2 カメラサムネ3列化
- **現状**: 列数未固定
- **改善**: 中央ペインで常に3列グリッド表示
- **実装**: CSS Grid `grid-template-columns: repeat(3, 1fr)`

### 2.3 ログカラーリング改善
- **現状**: 見えない問題
- **改善**: ダークテーマ対応のカラースキーム

```typescript
const LOG_COLORS = {
  // 検知レベル別
  detection_high: '#FF6B6B',    // 赤系(人検知等)
  detection_medium: '#FFA94D',  // オレンジ系
  detection_low: '#69DB7C',     // 緑系(正常)

  // ステータス別
  error: '#FF4444',
  warning: '#FFD93D',
  info: '#4DABF7',

  // 背景コントラスト
  bg_odd: '#1E1E2E',
  bg_even: '#252535',
  text_primary: '#FFFFFF',
  text_secondary: '#A0A0A0',
  timestamp: '#6C757D',
};
```

---

## 3. カメラ登録UI仕様

### 3.1 空状態（カメラ0件）

カメラが1台も登録されていない場合、中央ペインに以下を表示:

```
+----------------------------------+
|                                  |
|      [+] カメラを追加            |
|                                  |
|   カメラが登録されていません。    |
|   スキャンして検出してください。  |
|                                  |
+----------------------------------+
```

### 3.2 CameraScanモーダル

"+カメラを追加"クリックで開くモーダル:

```
+--------------------------------------------------+
|  カメラスキャン                            [×]   |
+--------------------------------------------------+
|                                                  |
|  [サブネット設定]                                |
|  +--------------------------------------------+  |
|  | Subnet          | Credentials               | |
|  | 192.168.125.0/24| halecam:*****, admin:*** | |
|  | 192.168.126.0/24| halecam:*****            | |
|  | 192.168.96.0/23 | ismscam:*****            | |
|  +--------------------------------------------+  |
|  [+ サブネット追加]  [クレデンシャル編集]        |
|                                                  |
|  [スキャン開始]                                  |
|                                                  |
+--------------------------------------------------+
```

### 3.3 スキャン進行UI

スキャン中は以下を必ず可視化:

```
+--------------------------------------------------+
|  カメラスキャン - 実行中                   [×]   |
+--------------------------------------------------+
|                                                  |
|  [レーダースピナー]  ◉ 192.168.125.0/24         |
|                                                  |
|  Phase 1: Host Discovery ✓ 完了                  |
|    └─ 254 IP → 53 hosts alive                   |
|                                                  |
|  Phase 2: Port Scan ✓ 完了                       |
|    └─ 53 hosts → 38 with camera ports           |
|                                                  |
|  Phase 3: ONVIF/RTSP Probe [実行中]              |
|    └─ 25/38 probed...                           |
|    └─ 現在: 192.168.125.45 - ONVIF応答あり      |
|                                                  |
|  Phase 4: Scoring                                |
|    └─ 待機中                                    |
|                                                  |
|  [キャンセル]                                    |
|                                                  |
+--------------------------------------------------+
```

### 3.4 レーダースピナー

```css
/* レーダー風スピナー */
.radar-spinner {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 2px solid #333;
  position: relative;
  animation: radar-sweep 2s linear infinite;
}

.radar-spinner::before {
  content: '';
  position: absolute;
  width: 50%;
  height: 50%;
  top: 0;
  left: 50%;
  transform-origin: 0% 100%;
  background: linear-gradient(
    90deg,
    transparent 0%,
    rgba(74, 222, 128, 0.4) 100%
  );
  animation: radar-beam 2s linear infinite;
}

@keyframes radar-beam {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
```

### 3.5 スキャン結果表示

```
+--------------------------------------------------+
|  スキャン完了 - 登録候補                   [×]   |
+--------------------------------------------------+
|  [全選択] [全解除]                  [登録: 0件]  |
|                                                  |
|  +--------------------------------------------+  |
|  | [✓] 192.168.125.12                         | |
|  |     Tapo C310 | TP-Link | ONVIF応答あり   | |
|  |     ← 登録可能                             | |
|  +--------------------------------------------+  |
|  | [✓] 192.168.125.17                         | |
|  |     Tapo C310 | TP-Link | ONVIF応答あり   | |
|  |     ← 登録可能                             | |
|  +--------------------------------------------+  |
|  | [  ] 192.168.125.45 [登録済み]             | |
|  |     Tapo C200 | TP-Link                    | |
|  |     ← すでに登録されています               | |
|  +--------------------------------------------+  |
|  | [  ] 192.168.125.66                         | |
|  |     TP-Linkデバイス | カメラか要確認       | |
|  |     ← クレデンシャル設定が必要             | |
|  |     [クレデンシャル編集] [再検証]          | |
|  +--------------------------------------------+  |
|                                                  |
|  [選択したカメラを登録 (2件)]                   |
|                                                  |
+--------------------------------------------------+
```

### 3.6 デバイスステータス表示

DetectionReasonに基づくユーザーフィードバック:

| device_type | 表示 | バッジ色 | アクション |
|-------------|------|----------|------------|
| camera_confirmed | カメラ確認済み | 緑 | 登録可能 |
| camera_likely | カメラの可能性あり | 黄 | クレデンシャル設定→再検証 |
| camera_possible | 要確認 | オレンジ | 手動確認推奨 |
| nvr_likely | NVRの可能性 | 青 | 手動確認 |
| network_device | ネットワーク機器 | グレー | 無視推奨 |
| other_device | その他 | グレー | 無視 |

### 3.7 モーダル閉じ確認ダイアログ

モーダル外クリックまたは×ボタンで:

```
+------------------------------------------+
|  CameraScanを終了しますか？              |
+------------------------------------------+
|                                          |
|  ・登録済み: 5件                         |
|  ・新規検出: 3台                         |
|  ・未登録の登録可能デバイス: 2台         |
|                                          |
|  登録されていないデバイスがあります。    |
|  終了すると検出結果は破棄されます。      |
|                                          |
|  [キャンセル]         [終了する]         |
|                                          |
+------------------------------------------+
```

**重要**: JavaScriptの`alert()`/`confirm()`は使用禁止。カスタムダイアログで実装。

---

## 4. コンポーネント設計

### 4.1 ディレクトリ構成

```
src/
├── components/
│   ├── layout/
│   │   ├── MainLayout.tsx       # 3ペインレイアウト
│   │   ├── SuggestPane.tsx      # 左: サジェスト
│   │   ├── CameraGridPane.tsx   # 中央: カメラ一覧
│   │   └── LogPane.tsx          # 右: ログ
│   ├── camera/
│   │   ├── CameraCard.tsx       # サムネカード
│   │   ├── CameraModal.tsx      # 詳細モーダル
│   │   └── EmptyState.tsx       # 0件時表示
│   ├── scan/
│   │   ├── ScanModal.tsx        # スキャンモーダル
│   │   ├── SubnetConfig.tsx     # サブネット設定
│   │   ├── CredentialEditor.tsx # クレデンシャル編集
│   │   ├── ScanProgress.tsx     # 進行状況表示
│   │   ├── RadarSpinner.tsx     # レーダースピナー
│   │   ├── ScanResult.tsx       # 結果一覧
│   │   └── DeviceRow.tsx        # デバイス行
│   ├── log/
│   │   ├── LogList.tsx          # ログ一覧
│   │   └── LogEntry.tsx         # ログエントリ
│   └── common/
│       ├── ConfirmDialog.tsx    # 確認ダイアログ
│       ├── Badge.tsx            # ステータスバッジ
│       └── Button.tsx           # ボタン
├── hooks/
│   ├── useScanJob.ts            # スキャンジョブ管理
│   ├── useCameras.ts            # カメラ一覧管理
│   └── useWebSocket.ts          # WS接続
└── styles/
    ├── colors.ts                # カラー定義
    └── theme.ts                 # テーマ設定
```

### 4.2 状態管理

```typescript
// ScanModal内の状態
interface ScanModalState {
  isOpen: boolean;
  phase: 'config' | 'scanning' | 'result';

  // スキャン設定
  subnets: SubnetConfig[];
  credentials: CredentialSet[];

  // スキャン進行
  currentJobId: string | null;
  progress: ScanProgress | null;

  // 結果
  devices: ScannedDevice[];
  selectedIds: Set<string>;

  // 確認ダイアログ
  showConfirmClose: boolean;
}
```

---

## 5. API連携

### 5.1 WebSocket イベント

```typescript
// スキャン進行状況のリアルタイム更新
interface WsScanProgress {
  type: 'scan_progress';
  job_id: string;
  phase: number;
  phase_name: string;
  progress: {
    current: number;
    total: number;
    current_ip?: string;
    message: string;
  };
}
```

### 5.2 必要なAPIエンドポイント

| Method | Endpoint | 用途 |
|--------|----------|------|
| GET | /api/ipcamscan/subnets | サブネット一覧取得 |
| POST | /api/ipcamscan/subnets | サブネット追加 |
| GET | /api/ipcamscan/credentials | クレデンシャル一覧 |
| POST | /api/ipcamscan/credentials | クレデンシャル追加 |
| POST | /api/ipcamscan/jobs | スキャンジョブ開始 |
| GET | /api/ipcamscan/jobs/{id} | ジョブ状態取得 |
| GET | /api/ipcamscan/devices | 検出デバイス一覧 |
| POST | /api/cameras/register | カメラ登録 |
| POST | /api/cameras/register/bulk | 一括登録 |

---

## 6. チェックリスト

### 6.1 レイアウト
- [ ] 3ペインレイアウトが正しく表示される
- [ ] サジェストペインが25%幅
- [ ] カメラ一覧が3列グリッド
- [ ] ログペインが25%幅
- [ ] レスポンシブ対応（最小幅1280px想定）

### 6.2 カメラ一覧
- [ ] カメラ0件時にブランクカード表示
- [ ] "+カメラを追加"クリックでモーダル表示
- [ ] サムネ外周ハイライト（サジェスト中）
- [ ] サムネクリックでカメラモーダル表示

### 6.3 スキャンモーダル
- [ ] サブネット一覧表示
- [ ] クレデンシャル設定UI
- [ ] 1サブネットに複数クレデンシャル対応
- [ ] スキャン開始ボタン動作
- [ ] レーダースピナー表示
- [ ] Phase1-4の進行表示
- [ ] 現在スキャン中のIP表示
- [ ] 各Phaseの結果数表示

### 6.4 スキャン結果
- [ ] 検出デバイス一覧表示
- [ ] DetectionReasonに基づくステータス表示
- [ ] 登録済みデバイスの識別表示
- [ ] 全選択/全解除ボタン
- [ ] 登録可能デバイスのみ選択可
- [ ] クレデンシャル編集ボタン
- [ ] 再検証ボタン
- [ ] 一括登録ボタン

### 6.5 確認ダイアログ
- [ ] モーダル外クリックで確認ダイアログ表示
- [ ] 登録済み件数表示
- [ ] 新規検出件数表示
- [ ] 未登録デバイス件数表示
- [ ] alertは使用していない

### 6.6 ログ表示
- [ ] カラーリングが視認可能
- [ ] ダークテーマ対応
- [ ] 検知レベル別色分け
- [ ] タイムスタンプ表示
- [ ] 最新N件のみ表示（リングバッファ）

---

## 7. 実装優先順位

1. **P0: 必須改善**
   - ログカラーリング修正
   - サジェストペイン幅拡大
   - カメラ一覧3列化

2. **P1: カメラ登録UI**
   - ブランクカード（0件時）
   - ScanModal基本構造
   - スキャン進行表示

3. **P2: スキャン結果UI**
   - デバイス一覧表示
   - 選択・登録機能
   - 確認ダイアログ

4. **P3: 詳細機能**
   - クレデンシャル編集
   - 再検証機能
   - WebSocket進行更新

---

## 8. 大原則の復唱

1. SSoTの大原則を遵守します
2. Solidの原則を意識し特に単一責任、開放閉鎖、置換原則、依存逆転に注意します
3. 必ずMECEを意識し、このコードはMECEであるか、この報告はMECEであるかを報告の中に加えます
4. アンアンビギュアスな報告回答を義務化しアンアンビギュアスに到達できていない場合はアンアンビギュアスであると宣言できるまで明確な検証を行います
5. 根拠なき自己解釈で情報に優劣を持たせる差別コード、レイシストコードは絶対の禁止事項です。情報の公平性原則
6. 実施手順と大原則に違反した場合は直ちに作業を止め再度現在位置を確認の上でリカバーしてから再度実装に戻ります
7. チェック、テストのない完了報告はただのやった振りのためこれは行いません
8. 依存関係と既存の実装を尊重し、確認し、車輪の再発明行為は絶対に行いません
9. 作業のフェーズ開始前とフェーズ終了時に必ずこの実施手順と大原則を全文省略なく復唱します
10. 必須参照の改変はゴールを動かすことにつながるため禁止です
11. is22_Camserver実装指示.mdを全てのフェーズ前に鑑として再読し基本的な思想や概念的齟齬が存在しないかを確認します
12. ルール無視はルールを無視した時点からやり直すこと

---

## 9. 検証計画

### 9.1 UIテスト項目

| No | テスト項目 | 期待結果 | 確認日 | 結果 |
|----|-----------|----------|--------|------|
| 1 | 初期表示(カメラ0件) | ブランクカード表示 | | |
| 2 | +カメラ追加クリック | モーダル表示 | | |
| 3 | サブネット一覧表示 | 登録済みサブネット表示 | | |
| 4 | スキャン開始 | レーダースピナー表示 | | |
| 5 | Phase進行表示 | 各Phase名と進捗表示 | | |
| 6 | スキャン完了 | 結果一覧表示 | | |
| 7 | 登録済みデバイス | 「登録済み」バッジ表示 | | |
| 8 | デバイス選択 | チェックボックス動作 | | |
| 9 | 一括登録 | 選択デバイス登録 | | |
| 10 | モーダル閉じ確認 | カスタムダイアログ表示 | | |
| 11 | ログカラー | 視認可能な色 | | |
| 12 | 3列グリッド | カメラサムネ3列 | | |

---

## 付録: スキャンPhase説明

| Phase | 名称 | 説明 | ユーザー表示例 |
|-------|------|------|----------------|
| 1 | Host Discovery | 対象IP存在確認 | "254 IP → 53 hosts alive" |
| 2 | Port Scan | カメラポートスキャン | "53 hosts → 38 with camera ports" |
| 3 | ONVIF/RTSP Probe | プロトコルプローブ | "25/38 probed... 192.168.125.45" |
| 4 | Scoring | スコアリング・分類 | "38 devices scored" |
| 5 | Verification | クレデンシャル検証 | "15 cameras verified" |
