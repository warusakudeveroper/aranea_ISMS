# IS22 mAcT UI レビュー対応ドキュメント

**作成日**: 2025-12-31
**対象**: フロントエンドUI改善
**ステータス**: 対応中

---

## 1. レイアウト調整

### 1.1 Suggest View 幅調整

| 項目 | 現状 | 修正後 |
|------|------|--------|
| 幅 | 25% (w-1/4) | 30% (+5%) |
| 最小幅 | 280px | 320px |
| 最大幅 | 400px | 480px |

**理由**: サジェストは「今見るべきカメラ」を大きく表示する目的。現状では画像が小さすぎてサジェストの意味が薄い。

**修正ファイル**: `src/App.tsx`
```tsx
// Before
<aside className="w-1/4 min-w-[280px] max-w-[400px] ...">

// After
<aside className="w-[30%] min-w-[320px] max-w-[480px] ...">
```

### 1.2 カメラグリッド調整

| 項目 | 現状 | 修正後 |
|------|------|--------|
| デフォルト列数 | 自動 | 3列 |
| 最大表示台数 | スクロール必要 | 30台収容（スクロールなし） |
| サイズ調整 | 固定 | 自動（台数に応じて縮小） |

**設計方針**:
- 基本3列レイアウト
- カメラ台数が増えると自動的にサムネイルサイズを縮小
- 30台まではスクロールなしで表示
- 30台超過時のみスクロール許可

**修正ファイル**: `src/components/CameraGrid.tsx`

---

## 2. AI Event Log 改善

### 2.1 カラーリング見直し

**現状の問題**:
- 色の意味が不明
- 視認性が低い
- severity数値だけでは何を意味するか分からない

**新カラースキーム**:

| Severity | 意味 | 背景色 | ラベル |
|----------|------|--------|--------|
| 0 | 変化なし | グレー (#f3f4f6) | Normal |
| 1 | 動体検知 | ブルー (#dbeafe) | Motion |
| 2 | 車両検知 | アンバー (#fef3c7) | Vehicle |
| 3+ | 人物検知 | レッド (#fee2e2) | Person |

**追加要素**:
- 各イベントにseverityラベルを表示
- primary_eventの値も表示（human, vehicle, animal等）

### 2.2 カメラ名表示

**現状**: `cam-8c227ab1...` (camera_id の先頭12文字)
**修正後**: `Tapo Toji 1F` (カメラ名を表示、名前がない場合のみID)

**実装方法**:
- EventLogPaneにcamerasリストをpropsで渡す
- camera_idからカメラ名をルックアップ

**修正ファイル**:
- `src/App.tsx` - camerasをEventLogPaneに渡す
- `src/components/EventLogPane.tsx` - カメラ名表示ロジック追加

---

## 3. 空画像カメラ調査

### 3.1 検証記録からの分析 (is22_Phase2_カメラ疎通検証記録.md)

**クレデンシャル状況**:

| ネットワーク | クレデンシャル | 成功 | 失敗 | 備考 |
|-------------|---------------|:----:|:----:|------|
| 192.168.96.x | `ismscam:isms12345@` | 2 | 0 | 市山水産 |
| 192.168.125.x | `halecam:hale0083` | 0 | 5 | **全て失敗** |
| 192.168.126.x | `halecam:hale0083` | 3 | 6 | 一部成功 |

**重要**: 192.168.125.x で全台失敗は、クレデンシャルが `halecam:hale0083@` (末尾に@) の可能性が高い

### 3.2 調査対象カメラ

| カメラ | IP | 現状 | 検証結果 | 推定原因 |
|--------|-----|------|----------|----------|
| Tapo TAM 1F | 192.168.125.12 | 空画像 | RTSP OK, 認証NG | クレデンシャル違い |
| Tapo Toji 3F | 192.168.126.30 | 空画像 | RTSP OK, 認証NG | クレデンシャル違い |
| Tapo Toji 1F | 192.168.126.27 | OK | 認証OK | - |
| Tapo Toji 2F | 192.168.126.28 | OK | 認証OK | - |

### 3.3 試すべきクレデンシャル

| ネットワーク | 試行1 | 試行2 | 試行3 |
|-------------|-------|-------|-------|
| 192.168.125.x | `halecam:hale0083@` | `halecam:hale0083` | `admin:admin` |
| 192.168.126.x | `halecam:hale0083@` | `halecam:hale0083` | `admin:admin` |
| 192.168.96.x | `ismscam:isms12345@` | - | - |

### 3.4 解決策: 個別クレデンシャル設定

カメラごとに異なるクレデンシャルを設定できる機能が必須。

**設計方針**:
- ローカルシステムのためパスワードマスク不要（平文表示OK）
- 必要になったら後からマスク機能追加
- go2rtc.yamlの動的更新またはAPI経由設定

---

## 4. カメラ編集モーダル

### 4.1 UI設計

**トリガー**: カメラサムネイル右上の編集ボタン（ペンアイコン）

**カメラカード表示項目**:
- カメラ名（大）
- ロケーション（小）
- 最終更新日時
- IPアドレス
- 編集ボタン

**モーダル内容**:

```
┌─────────────────────────────────────┐
│ カメラ設定                     [×] │
├─────────────────────────────────────┤
│ 表示名: [Tapo TAM 1F          ]    │
│ ロケーション: [TAM Facility 1F ]    │
│                                     │
│ ─── 接続設定 ───                    │
│ IPアドレス: 192.168.125.12          │
│ RTSP URL: [rtsp://...         ]    │
│ ユーザー名: [halecam           ]    │
│ パスワード: [hale0083@        ]    │  ← 平文表示（マスク不要）
│         [接続テスト]                │
│                                     │
│ ─── 表示設定 ───                    │
│ 画像回転: [0°  ▼] (0/90/180/270)   │
│                                     │
│ ─── 識別情報 ───                    │
│ lacisID: 30228FC0127385450001       │
│ MACアドレス: 8C:22:7A:B1:...        │
│                                     │
│         [キャンセル] [保存]         │
└─────────────────────────────────────┘
```

### 4.2 クレデンシャル設計

**ローカルシステム仕様**:
- パスワードはマスク不要（平文表示）
- 必要になったら後から実装
- 接続テストボタンで即時確認可能

**ネットワーク別デフォルトクレデンシャル**:

| ネットワーク | ユーザー名 | パスワード |
|-------------|-----------|-----------|
| 192.168.96.x | ismscam | isms12345@ |
| 192.168.125.x | halecam | hale0083@ |
| 192.168.126.x | halecam | hale0083@ |

**カメラ個別上書き**:
- 各カメラで個別にクレデンシャル設定可能
- 個別設定がある場合はそちらを優先

### 4.3 lacisID未登録カメラの扱い

**問題**: lacisIDがないカメラの識別方法

**解決策**:
1. MACアドレスを仮キーとして使用
2. lacisID生成規則: `{4文字プレフィックス}` + `{12桁MAC}` + `{4文字サフィックス}`
3. is22ローカルDBに仮登録として保存
4. 正式登録時にlacisIDを付与

**データ構造**:
```typescript
interface CameraLocal {
  camera_id: string;        // ローカル識別子
  mac_address: string;      // MACアドレス（仮キー）
  lacis_id?: string;        // lacisID（オプション）
  is_registered: boolean;   // 正式登録済みか
  credentials?: {
    username: string;
    password: string;
  };
  rotation: 0 | 90 | 180 | 270;
}
```

---

## 5. 追加登録対象カメラ

### 5.1 192.168.96.x (市山水産 fid:9000)

検証で動作確認済みカメラ:

| IP | ポート | ONVIF | RTSP | クレデンシャル | 状態 |
|----|--------|:-----:|:----:|---------------|------|
| 192.168.96.83 | 554, 2020 | OK | OK | ismscam:isms12345@ | 登録対象 |
| 192.168.96.85 | 554, 2020 | OK | OK | ismscam:isms12345@ | 登録対象 |

### 5.2 192.168.125.x (HALE京都丹波口 fid:0150)

検証でRTSP応答ありのカメラ（クレデンシャル要確認）:

| IP | ポート | ONVIF | RTSP | クレデンシャル | 状態 |
|----|--------|:-----:|:----:|---------------|------|
| 192.168.125.12 | 554, 2020 | OK | OK | halecam:hale0083@ (要確認) | 登録済み・認証NG |
| 192.168.125.17 | 554, 2020 | OK | OK | halecam:hale0083@ (要確認) | 登録対象 |
| 192.168.125.45 | 554, 2020 | OK | OK | halecam:hale0083@ (要確認) | 登録対象 |
| 192.168.125.62 | 554, 2020 | OK | OK | halecam:hale0083@ (要確認) | 登録対象 |
| 192.168.125.78 | 554, 2020 | OK | OK | halecam:hale0083@ (要確認) | 登録対象 |

### 5.3 192.168.126.x (HALE京都東寺 fid:0151)

検証でRTSP応答ありのカメラ:

| IP | ポート | ONVIF | RTSP | クレデンシャル | 状態 |
|----|--------|:-----:|:----:|---------------|------|
| 192.168.126.23 | 554, 2020 | OK | OK | halecam:hale0083 | 登録対象 |
| 192.168.126.24 | 554, 2020 | OK | OK | halecam:hale0083@ (要確認) | 登録対象 |
| 192.168.126.25 | 554, 2020 | OK | OK | halecam:hale0083@ (要確認) | 登録対象 |
| 192.168.126.27 | 554, 2020 | OK | OK | halecam:hale0083 | 登録済み・OK |
| 192.168.126.28 | 554, 2020 | OK | OK | halecam:hale0083 | 登録済み・OK |
| 192.168.126.30 | 554, 2020 | OK | OK | halecam:hale0083@ (要確認) | 登録済み・認証NG |
| 192.168.126.120 | 554, 2020 | OK | OK | halecam:hale0083@ (要確認) | 登録対象 |
| 192.168.126.124 | 554, 2020 | OK | OK | halecam:hale0083@ (要確認) | 登録対象 |
| 192.168.126.127 | 554, 2020 | OK | OK | halecam:hale0083@ (要確認) | 登録対象 |

---

## 6. 実装順序

### Phase 1: クレデンシャル修正・接続確認
- [ ] 192.168.125.12 に `halecam:hale0083@` でRTSP接続テスト
- [ ] 192.168.126.30 に `halecam:hale0083@` でRTSP接続テスト
- [ ] go2rtc.yaml クレデンシャル修正
- [ ] go2rtc再起動・動作確認

### Phase 2: レイアウト調整
- [ ] Suggest View幅を30%に拡大（現状25%から+5%）
- [ ] カメラグリッド3列デフォルト・自動サイズ（30台収容）
- [ ] カメラカードに情報追加（最終更新、IP、編集ボタン）

### Phase 3: EventLog改善
- [ ] カラースキーム変更（見やすく）
- [ ] severityラベル追加（Normal/Motion/Vehicle/Person）
- [ ] カメラ名表示対応（IDではなく名前）

### Phase 4: カメラ編集機能
- [ ] 編集ボタン追加（カメラカード右上）
- [ ] 編集モーダルコンポーネント作成
- [ ] クレデンシャル個別設定（平文表示）
- [ ] 接続テストボタン
- [ ] 画像回転設定

### Phase 5: 追加カメラ登録
- [ ] 192.168.96.x カメラ登録 (2台)
- [ ] 192.168.125.x 未登録カメラ追加 (4台)
- [ ] 192.168.126.x 未登録カメラ追加 (6台)
- [ ] MAC仮キー/lacisID対応

---

## 6. 修正ファイル一覧

| ファイル | 修正内容 |
|----------|----------|
| `src/App.tsx` | レイアウト幅調整、cameras props追加 |
| `src/components/CameraGrid.tsx` | 3列デフォルト、自動サイズ |
| `src/components/CameraCard.tsx` | 編集ボタン、情報表示追加 |
| `src/components/EventLogPane.tsx` | カラー、ラベル、カメラ名 |
| `src/components/CameraEditModal.tsx` | 新規作成 |
| `src/types/api.ts` | CameraLocal型追加 |

---

## 7. 確認チェックリスト

- [ ] Suggest Viewが30%幅で表示される
- [ ] サジェスト画像が大きく表示される
- [ ] カメラグリッドが3列で表示される
- [ ] 30台のカメラがスクロールなしで収まる
- [ ] EventLogの色が見やすい
- [ ] EventLogにseverityラベルがある
- [ ] EventLogにカメラ名が表示される
- [ ] カメラカードに編集ボタンがある
- [ ] 編集モーダルが開く
- [ ] クレデンシャルが個別設定できる
- [ ] 空画像カメラが修正される
