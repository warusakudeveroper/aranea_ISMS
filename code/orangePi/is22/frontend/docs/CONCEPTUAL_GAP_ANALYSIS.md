# IS22 Camserver 設計思想・コンセプト乖離分析

## 概要

本ドキュメントは、IS22 Camserverの設計仕様書（`is22_Camserver実装指示.md`、`is22_Camserver仕様案(基本設計書草案改訂版).md`）と現在の実装を比較し、**コンセプト・思想レベルでの乖離**を洗い出したものである。

単なる機能未実装リストではなく、「**スタッフオペレーションで難しい操作なく状況を伝えるサマリー的な要素**」という設計思想に照らし合わせた分析を行う。

---

## 1. 根本的なコンセプト乖離

### 1.1 「なんとなく映しておく」思想の欠如

**設計思想**:
> 「なんとなく映しておく」——スタッフが能動的に操作せずとも、AIが注目すべきカメラを自動で選び、異常があれば目に入る仕組み

**現在の実装**:
- ユーザーがカメラを**能動的にクリック**して初めて詳細が表示される
- サジェスト（AI推薦）による自動表示がない
- 「見逃し」が発生しうる従来型の監視カメラUIのまま

**影響度**: 🔴 致命的

---

### 1.2 3ペインレイアウト vs 2ペインレイアウト

**設計仕様の3ペイン構成**:
```
┌─────────────────────────────────────────────────────────────┐
│ Header: IS22 Camserver | CPU/MEM/モーダル数 | 設定          │
├──────────────┬──────────────────────┬───────────────────────┤
│              │                      │                       │
│  Left Pane   │    Center Pane       │     Right Pane        │
│  (25-30%)    │    (40-50%)          │     (20-25%)          │
│              │                      │                       │
│ サジェスト   │   カメラサムネ羅列    │   AI解析ログ          │
│ ライブ動画   │   (2x2 〜 6x6)       │   (リアルタイム)      │
│              │                      │                       │
│  ・自動選択  │   ・全カメラ一覧     │   ・イベント発生      │
│  ・AI判断    │   ・クリック→モーダル│   ・severity表示      │
│  ・注目点    │   ・赤枠=異常        │   ・時系列表示        │
│              │                      │                       │
└──────────────┴──────────────────────┴───────────────────────┘
```

**現在の実装（2ペイン）**:
```
┌─────────────────────────────────────────────────────────────┐
│ Header: IS22 Camserver | CPU/MEM/モーダル数 | 設定          │
├────────────────────────────────────┬────────────────────────┤
│                                    │                        │
│         Main Area (80%)            │   Right Panel (20%)    │
│                                    │                        │
│      カメラサムネ羅列               │   選択カメラ詳細       │
│      (2x2 〜 6x6)                  │   (静的情報)           │
│                                    │                        │
│                                    │   ・スナップショット   │
│                                    │   ・Location/IP/Family │
│                                    │   ・Live/Historyボタン │
│                                    │                        │
└────────────────────────────────────┴────────────────────────┘
```

**欠落要素**:
| 要素 | 設計 | 現在 | 状態 |
|------|------|------|------|
| Left Pane（サジェストライブ動画） | ○ | × | 🔴 未実装 |
| Center Pane（サムネ羅列） | ○ | ○ | ✅ 実装済 |
| Right Pane（AI解析ログ） | ○ | △ | 🟡 静的詳細のみ |

**影響度**: 🔴 致命的

---

## 2. サジェスト再生機能の完全欠如

### 2.1 サジェストエンジンの不在

**設計思想**:
> サジェスト再生 = サーバーが決定した「今最も見るべきカメラ」を全ユーザーに同時配信

**仕様の要件**:
- `SuggestEngine` がスコア計算（severity × 重み + 時間減衰）
- `/api/suggest/current` で現在のサジェスト対象カメラを取得
- WebSocket `/ws/suggest` でリアルタイム更新

**現在の実装**:
- SuggestEngine: **存在しない**
- サジェストAPI: **存在しない**
- Left Paneへの動画自動表示: **存在しない**

**コンセプト的問題**:
スタッフは「どのカメラを見ればいいか」を自分で判断しなければならない。これは設計思想「難しい操作なく状況を伝える」に完全に反する。

**影響度**: 🔴 致命的

---

### 2.2 巡回（Polling）+ AI解析の連携不在

**設計仕様**:
```
巡回サイクル:
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│ Camera A │ →  │ Snapshot │ →  │ is21 AI  │ →  │ Event    │
│ 選択     │    │ 取得     │    │ 推論     │    │ 生成     │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
                                      │
                                      ↓
                              ┌──────────────┐
                              │ SuggestScore │
                              │ 更新         │
                              └──────────────┘
```

**現在の実装**:
- 巡回ロジック: Rust側に `polling.rs` 存在するが**is21連携なし**
- is21 AI imageProcessor: 別サーバー(192.168.3.116:9000)で稼働中だが**呼び出しコードなし**
- スコア計算: **存在しない**

**影響度**: 🔴 致命的

---

## 3. AI解析ログ（Right Pane）の本質的乖離

### 3.1 「リアルタイムイベントストリーム」vs「静的詳細表示」

**設計仕様のRight Pane**:
```
┌─────────────────────────────┐
│ 📋 AI解析ログ               │
├─────────────────────────────┤
│ 🔴 14:32:05 cam-A           │
│    person_detected (sev:3)  │
│    [サムネイル]             │
├─────────────────────────────┤
│ 🟡 14:31:42 cam-C           │
│    motion (sev:1)           │
├─────────────────────────────┤
│ 🟢 14:30:15 cam-B           │
│    periodic_check (sev:0)   │
└─────────────────────────────┘
  ↑ 上から新しい順、自動スクロール
```

**現在のRight Panel**:
```
┌─────────────────────────────┐
│ 📷 cam-toji-126-28          │
├─────────────────────────────┤
│ [静的スナップショット]       │
│                             │
│ Location: 多治見126室28     │
│ IP: 192.168.126.28         │
│ Family: Tapo               │
│                             │
│ [Live] [History]            │
├─────────────────────────────┤
│ Recent Events              │
│ No recent events           │ ← 常に空
└─────────────────────────────┘
```

**問題点**:
| 設計要素 | 設計 | 現在 |
|----------|------|------|
| イベントのリアルタイム表示 | ○ | × |
| 複数カメラのイベント時系列 | ○ | × |
| severity色分け | ○ | × |
| 自動スクロール | ○ | × |
| サムネイル付きログ | ○ | × |

**現在の実装の問題**:
「選択したカメラの詳細」を表示するだけで、**システム全体で何が起きているかのサマリー**になっていない。

**影響度**: 🔴 致命的

---

## 4. イベント駆動アーキテクチャの不在

### 4.1 RealtimeHub / WebSocket未実装

**設計仕様**:
```rust
// RealtimeHub: イベント配信ハブ
pub struct RealtimeHub {
    clients: DashMap<Uuid, Sender<Event>>,
}

// WebSocket endpoints
- /ws/events     → 全イベントストリーム
- /ws/suggest    → サジェスト更新通知
- /ws/camera/{id}/stream → 個別カメライベント
```

**現在の実装**:
- WebSocketエンドポイント: **存在しない**
- RealtimeHub: **存在しない**
- フロントエンドはポーリング（30秒間隔）のみ

**コンセプト的問題**:
「リアルタイムで状況が伝わる」UIを実現できない。

**影響度**: 🟠 重要

---

## 5. カメラタイルの状態表現の乖離

### 5.1 Severity視覚表現

**設計仕様**:
```
severity 0: 灰色枠（通常）
severity 1: 青枠（軽微）
severity 2: 黄枠 + バッジ（注意）
severity 3: 赤枠 + 点滅 + バッジ（警告）
```

**現在の実装（CameraTile.tsx）**:
```typescript
// severityに応じた枠表現はあるが...
severity >= 2 && "ring-2 ring-yellow-500",
severity >= 3 && "ring-2 ring-red-500"
```

**問題点**:
- severity値を受け取る仕組みはあるが、**値が常に0**（AI解析がないため）
- 点滅アニメーションなし
- 視覚的警告が機能していない

**影響度**: 🟡 中程度（基盤はある）

---

## 6. モーダル再生の実装不完全

### 6.1 AdmissionController連携

**設計仕様**:
```
モーダル再生 = ユーザー指定のHD動画視聴（リソース制限あり）
- 予算制: 同時HD 4本まで
- タイムアウト: 60秒で自動解放
- AdmissionController で集中管理
```

**現在の実装**:
- AdmissionController: Rust側に存在
- LeaseManager: Rust側に存在
- **フロントエンドからのLease取得呼び出し: なし**
- 「Live」ボタンはあるが**機能していない**

**影響度**: 🟡 中程度

---

## 7. 優先度付き是正計画

### Phase 1: コンセプト復旧（最優先）

| # | 項目 | 工数目安 | 効果 |
|---|------|----------|------|
| 1-1 | 3ペインレイアウト実装 | 4h | Left Pane枠だけでも作る |
| 1-2 | EventLogコンポーネント作成 | 4h | Right Pane改修 |
| 1-3 | WebSocket基盤（/ws/events） | 8h | リアルタイム配信 |

### Phase 2: AI連携

| # | 項目 | 工数目安 | 効果 |
|---|------|----------|------|
| 2-1 | is21 API呼び出し実装 | 4h | 巡回時にAI推論 |
| 2-2 | イベント生成・保存 | 4h | DBにイベント蓄積 |
| 2-3 | SuggestEngine実装 | 8h | サジェスト再生実現 |

### Phase 3: UX磨き込み

| # | 項目 | 工数目安 | 効果 |
|---|------|----------|------|
| 3-1 | severity視覚効果（点滅等） | 2h | 警告の視認性 |
| 3-2 | モーダル再生完成 | 4h | HD動画視聴 |
| 3-3 | サジェストライブ動画表示 | 4h | Left Pane完成 |

---

## 8. 結論

### 現状評価

| カテゴリ | 設計充足度 |
|----------|-----------|
| 基盤（API/DB/ストリーム） | 70% |
| UI構造 | 30% |
| コンセプト実現度 | 10% |

### 根本的な問題

現在の実装は「**従来型の監視カメラビューア**」であり、設計が目指す「**AIが状況をサマリーし、スタッフが受動的に状況を把握できるシステム**」になっていない。

技術的な基盤（go2rtc、Rust backend、React frontend）は整っているが、**肝心の「サジェスト」「AI連携」「リアルタイムログ」という3本柱**が欠落している。

### 推奨アクション

1. **3ペインレイアウトへの移行を最優先**（UIの骨格修正）
2. **EventLogコンポーネントの実装**（Right Paneの本来の役割回復）
3. **is21連携の早期実装**（AIなしでは本システムの価値がない）

---

*作成日: 2025-12-31*
*作成者: Claude Code (自動分析)*
